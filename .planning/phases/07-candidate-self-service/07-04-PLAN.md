---
phase: 07-candidate-self-service
plan: 04
type: execute
wave: 3
depends_on: ["07-02", "07-03"]
files_modified:
  - src/app/(authenticated)/candidate/upload/page.tsx
  - src/app/(authenticated)/candidate/profile/page.tsx
  - src/components/candidate/profile-form.tsx
autonomous: true

must_haves:
  truths:
    - "Candidate can upload a PDF CV via drag-and-drop or file picker"
    - "After upload, candidate triggers parse which shows progress and redirects to profile page on completion"
    - "Candidate can view their parsed profile with all sections (contact, specializations, education, work history, bar admissions, technical domains)"
    - "Candidate can inline-edit profile fields (no confidence badges shown)"
    - "Candidate can submit profile for review"
    - "Candidate can re-upload a new CV from the upload page when a profile already exists"
    - "Editing an active profile triggers re-review with a visible warning"
  artifacts:
    - path: "src/app/(authenticated)/candidate/upload/page.tsx"
      provides: "Candidate CV upload page with single-file upload and auto-parse"
      min_lines: 80
    - path: "src/app/(authenticated)/candidate/profile/page.tsx"
      provides: "Candidate profile view page with edit capability and submit for review"
      min_lines: 40
    - path: "src/components/candidate/profile-form.tsx"
      provides: "Candidate profile form (adapted from admin, no confidence badges)"
      exports: ["CandidateProfileForm"]
  key_links:
    - from: "src/app/(authenticated)/candidate/upload/page.tsx"
      to: "/api/candidate/cv/upload"
      via: "Vercel Blob client upload() with handleUploadUrl"
      pattern: "handleUploadUrl.*candidate"
    - from: "src/app/(authenticated)/candidate/upload/page.tsx"
      to: "/api/candidate/cv/parse"
      via: "fetch POST to trigger parsing after upload"
      pattern: "api/candidate/cv/parse"
    - from: "src/components/candidate/profile-form.tsx"
      to: "src/actions/candidate-profiles.ts"
      via: "imports candidate action functions for inline editing"
      pattern: "updateCandidateProfileField|updateCandidateEducation"
    - from: "src/app/(authenticated)/candidate/profile/page.tsx"
      to: "src/lib/dal/candidate-profiles.ts"
      via: "getCandidateProfile for server-side data loading"
      pattern: "getCandidateProfile"
---

<objective>
Build the candidate-facing CV upload page and profile view/edit page -- the core self-service UI.

Purpose: This is the candidate experience. Candidates upload their CV, the system parses it, and they review/edit the extracted data before submitting for admin review. The upload page adapts the admin CV upload pattern for single-file use. The profile page uses a candidate-specific ProfileForm that omits confidence badges and adds a "Submit for Review" button. Re-upload support lets candidates replace their CV at any time.

Output: Upload page with drag-and-drop + auto-parse, profile page with inline editing, and candidate-specific profile form component.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-candidate-self-service/07-RESEARCH.md
@src/app/admin/cv-upload/page.tsx
@src/components/admin/profile-form.tsx
@src/components/admin/inline-edit-field.tsx
@src/actions/candidate-profiles.ts
@src/lib/dal/candidate-profiles.ts
@src/app/api/candidate/cv/upload/route.ts
@src/app/api/candidate/cv/parse/route.ts
@src/app/api/candidate/cv/status/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create candidate CV upload page with single-file upload and auto-parse</name>
  <files>src/app/(authenticated)/candidate/upload/page.tsx</files>
  <action>
    Create `src/app/(authenticated)/candidate/upload/page.tsx` as a 'use client' component. This adapts the admin CV upload page (`src/app/admin/cv-upload/page.tsx`) but simplified for single-file candidate use.

    **Key differences from admin:**
    - Single file upload only (not batch). Disable multi-select on file input (no `multiple` attribute).
    - Auto-trigger parse immediately after upload completes (no separate "Parse All" button).
    - Use candidate API routes: `handleUploadUrl: '/api/candidate/cv/upload'`, PUT to `/api/candidate/cv/upload`, POST to `/api/candidate/cv/parse`, GET from `/api/candidate/cv/status`.
    - Show re-upload warning if candidate already has a profile: on mount, fetch `/api/candidate/cv/status` and if any uploads exist with status 'parsed', show a warning banner: "You already have a profile. Uploading a new CV will replace your existing profile and require re-approval."

    **Upload flow (adapted from admin):**
    1. Drag-and-drop zone or file picker (same visual as admin but with text "Upload your CV" instead of "Upload CVs")
    2. Validate: PDF only, max 10MB (reuse same validateFiles logic as admin)
    3. Upload via `upload(file.name, file, { access: 'public', handleUploadUrl: '/api/candidate/cv/upload' })` from `@vercel/blob/client`
    4. After blob upload, PUT to `/api/candidate/cv/upload` with `{ filename, blobUrl }` to create DB record
    5. Auto-trigger parse: POST to `/api/candidate/cv/parse` with `{ cvUploadId: record.id }`
    6. Poll `/api/candidate/cv/status` every 3 seconds while status is 'parsing'
    7. On parse completion (status 'parsed'): show success message, then redirect to `/candidate/profile` using `router.push('/candidate/profile')`. Import `useRouter` from `next/navigation`.
    8. On parse failure: show error message with a "Try Again" option

    **UI state machine:**
    - `idle`: Show upload area
    - `uploading`: Show progress with spinner
    - `parsing`: Show "Analyzing your CV..." with spinner and progress text
    - `complete`: Show "Profile created!" with auto-redirect countdown
    - `error`: Show error message with retry button

    Use Card, CardContent, CardHeader, CardTitle from '@/components/ui/card'.
    Use Button from '@/components/ui/button'.
    Import icons: Upload, FileText, Loader2, CheckCircle, XCircle, AlertTriangle from lucide-react.

    Sub-text under heading: "Upload your CV in PDF format. Our system will automatically extract your qualifications and experience."
  </action>
  <verify>
    Run `npx tsc --noEmit`. Verify the page uses candidate API routes (not admin). Verify it auto-triggers parse after upload and polls for status.
  </verify>
  <done>
    Candidate upload page exists with drag-and-drop single-file upload, auto-parse trigger, status polling, and redirect to profile page on completion. Re-upload warning shown when profile exists.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create candidate profile form component and profile page</name>
  <files>src/components/candidate/profile-form.tsx, src/app/(authenticated)/candidate/profile/page.tsx</files>
  <action>
    **1. Create `src/components/candidate/profile-form.tsx`:**

    Adapt the admin `ProfileForm` (`src/components/admin/profile-form.tsx`) for candidate use. Key differences:
    - Import candidate actions from `@/actions/candidate-profiles` instead of admin actions from `@/actions/profiles`
    - NO confidence badges -- do not import or render `ConfidenceBadge`. Candidates should not see internal quality metrics.
    - Use the existing `InlineEditField` component from `@/components/admin/inline-edit-field.tsx` but pass a dummy confidence value of 'high' (the component requires it but the confidence badge is styled small enough to not be prominent). Alternatively, create a simpler wrapper that omits confidence. The simplest approach: pass `confidence="high"` to InlineEditField which will show a small green dot -- acceptable for now, or better yet, create a new `CandidateInlineEditField` that wraps InlineEditField.

    Actually, looking at the InlineEditField implementation, it renders ConfidenceBadge inside the display mode. For candidates, this is confusing. Better approach: Create a thin wrapper `CandidateEditField` in the same file that has the same interface as InlineEditField but without the confidence prop/badge. Copy the InlineEditField implementation and remove the ConfidenceBadge import and rendering. This avoids modifying the shared admin component.

    The `CandidateEditField` component:
    - Same props as InlineEditField minus `confidence` and `profileId` (profileId isn't used by the component itself)
    - Same editing behavior: click to edit, Enter to save, Escape to cancel, blur to save
    - Same Input from '@/components/ui/input'
    - Same Pencil icon on hover
    - No ConfidenceBadge rendering

    Export `CandidateProfileForm` component that accepts `{ profile: CandidateProfileFormData }`.

    The `CandidateProfileFormData` type: same as admin `ProfileFormData` but without confidence fields. Include: id, name, email, phone, education (without confidence), workHistory, barAdmissions, specializations (name only, no confidence), technicalDomains (name only).

    Action wrappers: same pattern as admin (createProfileFieldAction, etc.) but calling candidate actions.

    Sections to render:
    - Contact Information (name, email, phone -- editable via CandidateEditField)
    - Specializations (read-only badges, no confidence badges)
    - Education (editable entries)
    - Work History (editable entries, sorted most recent first)
    - Technical Domains (read-only badges)
    - Bar Admissions (editable entries)

    **2. Create `src/app/(authenticated)/candidate/profile/page.tsx`:**

    Server component (async). Import `getUser` from `@/lib/dal`, `getCandidateProfile` from `@/lib/dal/candidate-profiles`, `redirect` from `next/navigation`.

    Logic:
    1. Get user, get profile via `getCandidateProfile(user.id)`
    2. If no profile: redirect to `/candidate/upload`
    3. If profile exists:
       - Show page header with profile.name and status badge
       - If status is 'active': show info banner "Your profile is live and visible to employers. Editing will send it back for review."
       - If status is 'rejected': show warning banner with rejection notes and guidance to edit and resubmit
       - If status is 'pending_review': show info banner "Your profile is being reviewed by our team."
       - Render the `CandidateProfileForm` component with the profile data
       - Below the form, render action buttons:
         - If status is 'pending_review' or 'rejected': show "Submit for Review" button (form with hidden profileId, action=submitProfileForReview)
         - If status is 'active': show "Re-upload CV" link to `/candidate/upload`
       - Show a "Re-upload CV" link (secondary/outline) for all statuses, so candidates can always replace their CV

    Transform the profile data from the DAL format to the `CandidateProfileFormData` format:
    - Map profileSpecializations to `{ name: ps.specialization.name }`
    - Map profileTechnicalDomains to `{ name: ptd.technicalDomain.name }`
    - Strip confidence fields from education, workHistory, barAdmissions (or just pass them through and let the form ignore them)

    Import `submitProfileForReview` from `@/actions/candidate-profiles` for the submit button form.
    Use Card, Button, Badge, and standard layout components.
  </action>
  <verify>
    Run `npx tsc --noEmit`. Verify the profile page redirects to upload when no profile exists. Verify the CandidateProfileForm renders without confidence badges. Verify the submit for review button is present.
  </verify>
  <done>
    Candidate profile form component exists without confidence badges, using candidate-specific server actions. Profile page loads profile from DAL, shows status-appropriate banners (active/pending/rejected), renders editable form, and provides submit-for-review and re-upload options.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- Upload page uses candidate API routes `/api/candidate/cv/upload`, `/api/candidate/cv/parse`, `/api/candidate/cv/status`
- Upload page auto-triggers parse and redirects to profile on completion
- Upload page shows re-upload warning when profile already exists
- Profile page redirects to `/candidate/upload` when no profile exists
- CandidateProfileForm renders without confidence badges
- Profile page shows status-specific banners (pending/active/rejected)
- Submit for Review button calls submitProfileForReview action
- Re-upload CV link available on profile page
- `npm run build` completes without errors (full build verification)
</verification>

<success_criteria>
Complete candidate self-service UI works end-to-end: upload page accepts single PDF, auto-parses, shows progress, redirects to profile. Profile page shows all parsed data with inline editing (no confidence badges), status banners, submit for review, and re-upload option. Editing an active profile warns about re-review.
</success_criteria>

<output>
After completion, create `.planning/phases/07-candidate-self-service/07-04-SUMMARY.md`
</output>
