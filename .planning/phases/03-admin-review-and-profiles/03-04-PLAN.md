---
phase: 03-admin-review-and-profiles
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - src/app/admin/candidates/[id]/page.tsx
  - src/components/admin/profile-form.tsx
  - src/components/admin/inline-edit-field.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view a single candidate's full profile at /admin/candidates/[id]"
    - "Profile detail shows all parsed data organized in sections: contact info, specializations, education, work history, technical domains, bar admissions"
    - "Each field displays its confidence badge (high/medium/low)"
    - "Admin can click any text field to enter inline edit mode (click-to-edit)"
    - "Inline edit saves on Enter or blur, cancels on Escape"
    - "After edit, confidence is upgraded to 'high' (human-verified)"
    - "Admin can approve a profile (sets status to active)"
    - "Admin can reject a profile with required rejection notes"
  artifacts:
    - path: "src/app/admin/candidates/[id]/page.tsx"
      provides: "Profile detail page with all sections, approve/reject buttons"
      min_lines: 80
    - path: "src/components/admin/profile-form.tsx"
      provides: "Profile sections display with organized layout"
      exports: ["ProfileForm"]
    - path: "src/components/admin/inline-edit-field.tsx"
      provides: "Click-to-edit component for individual fields"
      exports: ["InlineEditField"]
  key_links:
    - from: "src/app/admin/candidates/[id]/page.tsx"
      to: "src/lib/db/index.ts"
      via: "db.query.profiles.findFirst for full profile data"
      pattern: "db\\.query\\.profiles\\.findFirst"
    - from: "src/components/admin/inline-edit-field.tsx"
      to: "src/actions/profiles.ts"
      via: "calls updateProfileField server action"
      pattern: "import.*updateProfileField"
    - from: "src/app/admin/candidates/[id]/page.tsx"
      to: "src/actions/profiles.ts"
      via: "calls approveProfile and rejectProfile server actions"
      pattern: "import.*approveProfile|rejectProfile"
---

<objective>
Build the profile detail page with inline editing, approve/reject actions, and organized profile sections showing all parsed data with confidence indicators.

Purpose: This covers success criteria #2 (view/correct parsed data), #3 (approve/reject with notes), and #4 (edit any field at any time). This is the core admin workflow page.

Output: Working profile detail page with inline editing and status actions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-admin-review-and-profiles/03-RESEARCH.md
@.planning/phases/03-admin-review-and-profiles/03-01-SUMMARY.md
@.planning/phases/03-admin-review-and-profiles/03-02-SUMMARY.md
@.planning/phases/03-admin-review-and-profiles/03-03-SUMMARY.md
@src/lib/db/schema.ts
@src/lib/db/index.ts
@src/actions/profiles.ts
@src/components/admin/confidence-badge.tsx
@src/components/admin/status-badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InlineEditField component and ProfileForm sections component</name>
  <files>
    src/components/admin/inline-edit-field.tsx
    src/components/admin/profile-form.tsx
  </files>
  <action>
**Create src/components/admin/inline-edit-field.tsx:**
- Add `'use client'` directive (uses useState, useTransition)
- Import `useState`, `useRef`, `useTransition` from React
- Import `Input` from `@/components/ui/input`
- Import `ConfidenceBadge` from `@/components/admin/confidence-badge`
- Import `Pencil` icon from `lucide-react`

Props:
```typescript
{
  profileId: string
  fieldName: string
  value: string
  confidence: 'high' | 'medium' | 'low'
  action: (formData: FormData) => Promise<{ error?: string; success?: boolean }>
  label: string
}
```

Behavior:
- **Display mode (default):** Shows the value text + ConfidenceBadge. On hover, shows a subtle pencil icon. Clicking anywhere on the row enters edit mode. If value is empty, show "(empty)" in muted text.
- **Edit mode:** Replaces text with an `<Input>` that is auto-focused. Shows a small "Save" / "Cancel" below or uses keyboard shortcuts.
  - **Enter:** Calls the server action via FormData, transitions back to display mode
  - **Escape:** Reverts to original value, exits edit mode
  - **Blur:** Same as Enter (save on blur)
  - While saving (isPending from useTransition), disable the input and show subtle loading state
- **After save:** The server action calls revalidatePath, Next.js re-renders the server component above, updating the prop values. The component receives new props with `confidence: 'high'`.

The action prop is a generic server action reference -- this lets the same component work for top-level profile fields AND child table fields (caller passes the appropriate action).

**Create src/components/admin/profile-form.tsx:**
- Add `'use client'` directive (contains InlineEditField which needs client)
- Import `InlineEditField` from `./inline-edit-field`
- Import `ConfidenceBadge` from `./confidence-badge`
- Import `StatusBadge` from `./status-badge`
- Import `Card`, `CardContent`, `CardHeader`, `CardTitle` from `@/components/ui/card`
- Import `Separator` from `@/components/ui/separator`
- Import `updateProfileField`, `updateEducation`, `updateWorkHistory`, `updateBarAdmission` from `@/actions/profiles`

Accept a `profile` prop containing the full nested profile data (the shape returned by the Drizzle relational query in the page component). Define a TypeScript type for this.

Render organized sections:

**Section 1: Contact Information**
- Name field: InlineEditField with action bound to updateProfileField
- Email field: InlineEditField with action bound to updateProfileField
- Phone field: InlineEditField with action bound to updateProfileField
- For each, create a wrapper function that builds FormData with profileId, fieldName, and value, then calls updateProfileField

**Section 2: Specializations**
- List each specialization with its confidence badge
- Display as tags/chips (Badge components)
- Read-only for now (editing junction tables with combobox is complex -- will be a future enhancement)

**Section 3: Education**
- List each education entry as a card/row
- Fields: institution, degree, field, year -- each as InlineEditField
- For education fields, create a wrapper function that builds FormData with educationId, profileId, and all fields, then calls updateEducation
- Show confidence badge per entry

**Section 4: Work History**
- List each work history entry
- Fields: employer, title, startDate, endDate, description
- Each field as InlineEditField (description uses textarea-like handling -- for now, a single-line input is acceptable; a future enhancement can add multi-line)
- Wrap updateWorkHistory as the action
- Show confidence badge per entry
- Order by startDate descending (most recent first)

**Section 5: Technical Domains**
- List each technical domain with confidence badge
- Read-only display (same as specializations)

**Section 6: Bar Admissions**
- List each bar admission entry
- Fields: jurisdiction, year, status -- each as InlineEditField
- Wrap updateBarAdmission as the action
- Show confidence badge per entry

Each section should have a clear heading and visual separator. Use Card components for grouping.

**Important for server action wrappers:** The InlineEditField expects an `action` prop that receives FormData and returns `{ error?: string; success?: boolean }`. Create bound action functions for each field type. Example for a profile field:

```typescript
function createProfileFieldAction(profileId: string, fieldName: string) {
  return async (formData: FormData) => {
    const fd = new FormData()
    fd.set('profileId', profileId)
    fd.set('fieldName', fieldName)
    fd.set('value', formData.get('value') as string)
    return updateProfileField(fd)
  }
}
```

And for education:
```typescript
function createEducationAction(educationId: string, profileId: string, currentValues: {...}) {
  return async (formData: FormData) => {
    const fd = new FormData()
    fd.set('educationId', educationId)
    fd.set('profileId', profileId)
    // Set all fields, using the new value for the edited field
    // and current values for others
    fd.set('institution', ...)
    fd.set('degree', ...)
    fd.set('field', ...)
    fd.set('year', ...)
    return updateEducation(fd)
  }
}
```

This is slightly verbose but ensures each InlineEditField only needs to know about its own value change, while the wrapper fills in the rest.
  </action>
  <verify>
  - `npx tsc --noEmit` passes
  - InlineEditField exports and handles display/edit/save/cancel modes
  - ProfileForm exports and renders all 6 sections
  - ProfileForm imports and wires server actions from src/actions/profiles.ts
  - Each editable field has a bound action function
  </verify>
  <done>
  - InlineEditField: click-to-edit with Enter/Escape/blur, loading state, confidence badge display
  - ProfileForm: 6 organized sections (contact, specializations, education, work history, tech domains, bar admissions)
  - All editable fields wired to appropriate server actions
  - Specializations and tech domains are read-only with badges
  - Education, work history, bar admissions have per-field inline editing
  </done>
</task>

<task type="auto">
  <name>Task 2: Create profile detail page with approve/reject actions and PDF side-by-side view</name>
  <files>
    src/app/admin/candidates/[id]/page.tsx
  </files>
  <action>
**Create src/app/admin/candidates/[id]/page.tsx** as a server component (NO `'use client'`).

**Data fetching:**
- Import `db` from `@/lib/db`
- Import `notFound` from `next/navigation`
- Fetch the profile using `db.query.profiles.findFirst()` with the full `with` clause:
  ```
  with: {
    education: true,
    workHistory: true,
    barAdmissions: true,
    profileSpecializations: { with: { specialization: true } },
    profileTechnicalDomains: { with: { technicalDomain: true } },
    cvUploads: true,
  }
  ```
- Filter by `id` from params: `where: (profiles, { eq }) => eq(profiles.id, params.id)`
- If profile not found, call `notFound()`

**Page params typing (Next.js 16):**
```typescript
export default async function ProfileDetailPage({
  params,
}: {
  params: Promise<{ id: string }>
}) {
  const { id } = await params
  // ... fetch profile
}
```

**Layout:**
The page uses shadcn/ui `ResizablePanelGroup` for a side-by-side layout IF the profile has an associated CV upload with a blobUrl. Otherwise, it renders just the profile form at full width.

- Import `ResizablePanelGroup`, `ResizablePanel`, `ResizableHandle` from `@/components/ui/resizable`

**Left panel (PDF):**
- If `profile.cvUploads` has entries with a blobUrl, render an iframe with `src={cvUpload.blobUrl}`, class `h-full w-full border-0`
- If no CV upload, skip the resizable layout and render profile form full-width

**Right panel (Profile Data):**
- Header area with:
  - Back link to `/admin/candidates` ("< Back to candidates")
  - Profile name as `<h1>`
  - StatusBadge showing current status
  - Action buttons area (approve/reject)
- ProfileForm component receiving the full profile data

**Approve/Reject actions:**
Import `approveProfile` and `rejectProfile` from `@/actions/profiles`.

Create a client component `ProfileActions` (can be defined in the same file or inline) that renders:

1. **Approve button** (green): Only shown if status is NOT 'active'. Uses a `<form>` with hidden `profileId` input and `action={approveProfile}`. Use `useActionState` from React to handle pending state. Show "Approving..." while pending.

2. **Reject button** (red): Only shown if status is NOT 'rejected'. Opens a Dialog (shadcn/ui) with:
   - Title: "Reject Profile"
   - Textarea for rejection notes (required)
   - Cancel and Confirm buttons
   - Form with hidden `profileId` and the textarea `rejectionNotes`, `action={rejectProfile}`
   - Show existing rejectionNotes if profile was previously rejected

Since these action buttons need client interactivity, wrap them in a small client component:

```tsx
'use client'

import { useActionState } from 'react'
// ... imports

export function ProfileActions({ profileId, status, rejectionNotes }: {
  profileId: string
  status: 'pending_review' | 'active' | 'rejected'
  rejectionNotes: string | null
}) {
  // Approve form with useActionState
  // Reject dialog with textarea
}
```

This client component can be defined in a separate file `src/app/admin/candidates/[id]/profile-actions.tsx` if the page file gets too large, or kept inline. Prefer a separate file for clarity.

**ResizablePanelGroup layout:**
```tsx
<ResizablePanelGroup direction="horizontal" className="min-h-[calc(100vh-8rem)]">
  <ResizablePanel defaultSize={45} minSize={25}>
    <iframe src={pdfUrl} className="h-full w-full border-0" title="Original CV" />
  </ResizablePanel>
  <ResizableHandle withHandle />
  <ResizablePanel defaultSize={55} minSize={30}>
    <div className="h-full overflow-y-auto p-6">
      {/* Header with back link, name, status, actions */}
      {/* ProfileForm */}
    </div>
  </ResizablePanel>
</ResizablePanelGroup>
```

**If no PDF available** (no cvUploads or no blobUrl):
```tsx
<div className="mx-auto max-w-4xl p-6">
  {/* Header with back link, name, status, actions */}
  {/* ProfileForm */}
</div>
```

**Data transformation before passing to ProfileForm:**
Flatten the junction table data for specializations and technical domains:
```typescript
const profileData = {
  ...profile,
  specializations: profile.profileSpecializations.map(ps => ({
    name: ps.specialization.name,
    confidence: ps.confidence,
  })),
  technicalDomains: profile.profileTechnicalDomains.map(ptd => ({
    name: ptd.technicalDomain.name,
    confidence: ptd.confidence,
  })),
}
```
  </action>
  <verify>
  - `npx tsc --noEmit` passes
  - /admin/candidates/[id] route exists
  - Page fetches full profile with all nested relations
  - Resizable side-by-side layout renders when CV exists
  - Full-width layout renders when no CV exists
  - Approve button triggers approveProfile server action
  - Reject button opens Dialog with textarea, triggers rejectProfile server action
  - ProfileForm renders with all profile data and inline editing
  - `npm run build` succeeds
  </verify>
  <done>
  - Profile detail page at /admin/candidates/[id] with full data display
  - Side-by-side PDF + data layout using ResizablePanelGroup (when CV exists)
  - Approve button sets profile to active
  - Reject button with required notes sets profile to rejected
  - All profile fields visible with confidence badges
  - Inline editing works for contact info, education, work history, bar admissions
  - Back navigation to candidate list
  </done>
</task>

</tasks>

<verification>
- TypeScript compilation passes
- /admin/candidates/[id] renders with profile data
- Side-by-side layout works when CV PDF exists
- Inline editing: click field -> edit -> Enter saves -> confidence becomes high
- Inline editing: click field -> edit -> Escape reverts
- Approve button changes status to active
- Reject button opens dialog, requires notes, changes status to rejected
- All 6 profile sections render with confidence badges
- Navigation between list and detail works (name link -> detail, back link -> list)
</verification>

<success_criteria>
- Admin can view full profile with all parsed data organized in sections
- Admin can see original PDF side-by-side with parsed data (resizable panels)
- Admin can click-to-edit any field with immediate save and confidence upgrade
- Admin can approve a profile (status -> active)
- Admin can reject a profile with notes (status -> rejected)
- All fields show confidence badges
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-admin-review-and-profiles/03-04-SUMMARY.md`
</output>
