---
phase: 03-admin-review-and-profiles
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/admin/candidates/page.tsx
  - src/app/admin/candidates/columns.tsx
  - src/app/admin/candidates/data-table.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can see all candidate profiles in a table at /admin/candidates"
    - "Table shows name (linked to detail page), status badge, attention level (lowest confidence), specializations, and date added"
    - "Admin can search candidates by name or email via a text input"
    - "Admin can filter candidates by status (pending_review, active, rejected, or all)"
    - "Table columns are sortable by clicking headers"
    - "Table has pagination for large datasets"
    - "Low-confidence profiles appear first when sorting by attention"
  artifacts:
    - path: "src/app/admin/candidates/page.tsx"
      provides: "Server component that fetches candidates with search/filter params and renders DataTable"
      min_lines: 40
    - path: "src/app/admin/candidates/columns.tsx"
      provides: "TanStack Table column definitions with status/confidence badges"
      exports: ["columns"]
    - path: "src/app/admin/candidates/data-table.tsx"
      provides: "Client component wrapping TanStack Table with search input, status filter, pagination"
      exports: ["DataTable"]
  key_links:
    - from: "src/app/admin/candidates/page.tsx"
      to: "src/lib/db/index.ts"
      via: "db.query.profiles.findMany with relational queries"
      pattern: "db\\.query\\.profiles\\.findMany"
    - from: "src/app/admin/candidates/columns.tsx"
      to: "src/components/admin/status-badge.tsx"
      via: "import StatusBadge for status column"
      pattern: "import.*StatusBadge"
    - from: "src/app/admin/candidates/columns.tsx"
      to: "src/components/admin/confidence-badge.tsx"
      via: "import ConfidenceBadge for attention column"
      pattern: "import.*ConfidenceBadge"
    - from: "src/app/admin/candidates/data-table.tsx"
      to: "@tanstack/react-table"
      via: "useReactTable hook"
      pattern: "useReactTable"
---

<objective>
Build the candidate list page at /admin/candidates with a searchable, sortable, filterable data table showing all profiles with status indicators and confidence-based attention sorting.

Purpose: This is success criterion #5 -- "Admin can see all candidate profiles in a searchable, sortable list with status indicators." It also partially serves criterion #1 by showing pending profiles sorted by attention level.

Output: Working candidate list page with TanStack Table, server-side data fetching, and client-side sorting/filtering.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-admin-review-and-profiles/03-RESEARCH.md
@.planning/phases/03-admin-review-and-profiles/03-01-SUMMARY.md
@src/lib/db/schema.ts
@src/lib/db/index.ts
@src/app/admin/layout.tsx
@src/components/admin/confidence-badge.tsx
@src/components/admin/status-badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TanStack Table column definitions and DataTable client component</name>
  <files>
    src/app/admin/candidates/columns.tsx
    src/app/admin/candidates/data-table.tsx
  </files>
  <action>
**Define the CandidateRow type** (used by both files):

```typescript
type CandidateRow = {
  id: string
  name: string
  email: string | null
  status: 'pending_review' | 'active' | 'rejected'
  specializations: string[]
  lowestConfidence: 'high' | 'medium' | 'low'
  createdAt: string
}
```

**Create src/app/admin/candidates/columns.tsx:**
- Add `'use client'` directive
- Import `ColumnDef` from `@tanstack/react-table`
- Import `StatusBadge` from `@/components/admin/status-badge`
- Import `ConfidenceBadge` from `@/components/admin/confidence-badge`
- Import `ArrowUpDown` from `lucide-react` for sortable header indicators
- Import `Button` from `@/components/ui/button` for the sortable header button wrapper

Define and export `columns: ColumnDef<CandidateRow>[]` with these columns:

1. **name** - Header: "Name". Cell: Link (`<a>`) to `/admin/candidates/${row.original.id}` with `font-medium hover:underline`. Sortable.
2. **status** - Header: "Status". Cell: `<StatusBadge status={...} />`. Filterable by equals.
3. **lowestConfidence** - Header: "Attention". Cell: `<ConfidenceBadge level={...} />`. Custom sorting function: `low=0, medium=1, high=2` (so low-confidence sorts first in ascending order).
4. **specializations** - Header: "Specializations". Cell: Join array with ", ". Truncate display if > 3 items (show first 3 + "+N more"). Not sortable (`enableSorting: false`).
5. **createdAt** - Header: "Added". Cell: Format as locale date string. Sortable.

**Create src/app/admin/candidates/data-table.tsx:**
- Add `'use client'` directive
- Import from `@tanstack/react-table`: `useReactTable`, `getCoreRowModel`, `getSortedRowModel`, `getFilteredRowModel`, `getPaginationRowModel`, `SortingState`, `ColumnFiltersState`, `flexRender`
- Import shadcn/ui: `Table`, `TableBody`, `TableCell`, `TableHead`, `TableHeader`, `TableRow` from `@/components/ui/table`
- Import `Input` from `@/components/ui/input`
- Import `Button` from `@/components/ui/button`
- Import `Select`, `SelectContent`, `SelectItem`, `SelectTrigger`, `SelectValue` from `@/components/ui/select`

Props: `{ columns, data, pageCount? }` where `columns` is `ColumnDef<CandidateRow>[]` and `data` is `CandidateRow[]`.

State:
- `sorting: SortingState` (default: sort by lowestConfidence ascending, then createdAt descending)
- `columnFilters: ColumnFiltersState`
- `globalFilter: string` (for search)

Features:
- **Search input** at top: filters globally across name and email. Use `Input` with placeholder "Search candidates..." and onChange setting globalFilter.
- **Status filter** next to search: `Select` dropdown with options "All", "Pending Review", "Active", "Rejected". Setting this adds a column filter on the status column.
- **Table** rendering: Map over `table.getHeaderGroups()` for headers, `table.getRowModel().rows` for body. If no rows, show "No candidates found." centered message.
- **Pagination** at bottom: Previous/Next buttons using `table.previousPage()` / `table.nextPage()`, disabled appropriately. Show "Page X of Y" text.

Layout: Search and status filter in a flex row above the table. Pagination below.
  </action>
  <verify>
  - `npx tsc --noEmit` passes
  - columns.tsx exports `columns` array with 5 column definitions
  - data-table.tsx exports `DataTable` component
  - DataTable uses useReactTable with sorting, filtering, pagination row models
  - Search input and status filter Select are present in DataTable
  </verify>
  <done>
  - Column definitions handle name linking, status badges, confidence badges, specialization display, date formatting
  - DataTable client component provides search, status filter, column sorting, and pagination
  - Custom sort for confidence column (low first = most attention)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create candidates server page with data fetching</name>
  <files>src/app/admin/candidates/page.tsx</files>
  <action>
**Create src/app/admin/candidates/page.tsx** as a server component (NO `'use client'` directive).

**Data fetching:**
- Import `db` from `@/lib/db`
- Use `db.query.profiles.findMany()` with Drizzle v1 relational queries
- Fetch ALL profiles (no server-side filtering -- TanStack Table handles client-side filtering/sorting since we expect < 1000 candidates)
- Include `with` option to get nested data:
  ```
  with: {
    profileSpecializations: {
      with: { specialization: true }
    },
    education: true,
    workHistory: true,
    barAdmissions: true,
    profileTechnicalDomains: {
      with: { technicalDomain: true }
    },
  }
  ```
- Order by `createdAt` descending (newest first)

**Data transformation:**
After fetching, transform each profile into a `CandidateRow` for the DataTable:

```typescript
const candidateRows = allProfiles.map(profile => {
  // Flatten specializations from junction table
  const specializations = profile.profileSpecializations.map(
    ps => ps.specialization.name
  )

  // Compute lowest confidence across ALL fields
  const confidenceRank = { low: 0, medium: 1, high: 2 }
  const allConfidences = [
    confidenceRank[profile.nameConfidence],
    confidenceRank[profile.emailConfidence],
    confidenceRank[profile.phoneConfidence],
    ...profile.education.map(e => confidenceRank[e.confidence]),
    ...profile.workHistory.map(w => confidenceRank[w.confidence]),
    ...profile.barAdmissions.map(b => confidenceRank[b.confidence]),
    ...profile.profileSpecializations.map(s => confidenceRank[s.confidence]),
    ...profile.profileTechnicalDomains.map(t => confidenceRank[t.confidence]),
  ]
  const minConfidence = allConfidences.length > 0
    ? Math.min(...allConfidences)
    : 2 // default to high if no fields
  const lowestConfidence = minConfidence === 0 ? 'low' : minConfidence === 1 ? 'medium' : 'high'

  return {
    id: profile.id,
    name: profile.name,
    email: profile.email,
    status: profile.status,
    specializations,
    lowestConfidence,
    createdAt: profile.createdAt.toISOString(),
  }
})
```

**Page layout:**
- Header section: `<h1>` "Candidates" + subtitle "Review and manage candidate profiles"
- Summary cards row showing counts: Total, Pending Review, Active, Rejected (using Card from shadcn/ui)
- DataTable component rendered with columns and transformed data

Import `columns` from `./columns` and `DataTable` from `./data-table`.

**NOTE on typing:** If `db.query.profiles` TypeScript types don't resolve properly with the v1 relational API on Drizzle 0.45.1, fall back to `db.select().from(profiles)` with left joins for the basic query, and do a second query for specializations. But try `db.query` first -- it should work with the relations defined in Plan 01.
  </action>
  <verify>
  - `npx tsc --noEmit` passes
  - Page is a server component (no 'use client')
  - Page imports db and performs relational query
  - Page transforms profile data into CandidateRow format
  - Page renders DataTable with columns and data
  - `npm run build` succeeds (or at minimum `npx next build` does not crash on this route)
  </verify>
  <done>
  - /admin/candidates page fetches all profiles with nested relations
  - Data transformed: specializations flattened, lowest confidence computed
  - Summary cards show counts by status
  - DataTable renders with search, filter, sort, pagination
  - Candidate names link to /admin/candidates/[id] (detail page built in Plan 04)
  </done>
</task>

</tasks>

<verification>
- TypeScript compilation passes
- /admin/candidates route exists and renders
- DataTable shows columns: Name (linked), Status (badge), Attention (confidence badge), Specializations, Added
- Search filters by name/email
- Status dropdown filters by status
- Column headers sortable
- Pagination controls visible
- Attention column sorts low-confidence first
</verification>

<success_criteria>
- Working candidate list page at /admin/candidates
- All 5 columns rendering with proper badges and formatting
- Client-side search, status filter, column sorting, pagination
- Server-side data fetching with Drizzle relational queries
- Low-confidence profiles surface first when sorted by Attention
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-admin-review-and-profiles/03-03-SUMMARY.md`
</output>
