---
phase: 03-admin-review-and-profiles
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/schema.ts
  - src/lib/db/relations.ts
  - src/lib/db/index.ts
  - src/components/admin/confidence-badge.tsx
  - src/components/admin/status-badge.tsx
autonomous: true

must_haves:
  truths:
    - "profiles table has status column with enum (pending_review, active, rejected)"
    - "profiles table has rejectionNotes, reviewedAt, reviewedBy columns"
    - "Drizzle relational queries work: db.query.profiles.findFirst with 'with' returns nested education, workHistory, etc."
    - "All shadcn/ui components needed for Phase 3 are installed and importable"
    - "TanStack Table is installed and importable"
  artifacts:
    - path: "src/lib/db/schema.ts"
      provides: "profileStatusEnum + extended profiles table columns"
      contains: "profileStatusEnum"
    - path: "src/lib/db/relations.ts"
      provides: "Drizzle v1 relations for all profile-related tables"
      exports: ["profilesRelations", "educationRelations", "workHistoryRelations", "barAdmissionsRelations", "cvUploadsRelations"]
    - path: "src/lib/db/index.ts"
      provides: "db instance with both schema and relations"
      contains: "relations"
    - path: "src/components/admin/confidence-badge.tsx"
      provides: "Reusable confidence level badge component"
      exports: ["ConfidenceBadge"]
    - path: "src/components/admin/status-badge.tsx"
      provides: "Reusable profile status badge component"
      exports: ["StatusBadge"]
  key_links:
    - from: "src/lib/db/index.ts"
      to: "src/lib/db/relations.ts"
      via: "spread into drizzle config schema"
      pattern: "\\{ \\.\\.\\.schema, \\.\\.\\.relations \\}"
    - from: "src/lib/db/relations.ts"
      to: "src/lib/db/schema.ts"
      via: "imports all tables for relation definitions"
      pattern: "import.*from.*schema"
---

<objective>
Extend the database schema with profile status tracking, define Drizzle v1 relations for efficient nested queries, install all UI dependencies, and create shared badge components used across the phase.

Purpose: Everything in Phase 3 depends on the status field (review queue filtering, approve/reject actions, status indicators) and relational queries (profile detail views, list page confidence sorting). This plan lays that foundation.

Output: Extended schema, working relational queries, installed packages, reusable badge components.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-admin-review-and-profiles/03-RESEARCH.md
@src/lib/db/schema.ts
@src/lib/db/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend schema, define relations, update db instance, install packages</name>
  <files>
    src/lib/db/schema.ts
    src/lib/db/relations.ts
    src/lib/db/index.ts
  </files>
  <action>
1. **Install packages:**
   ```bash
   npx shadcn@latest add table badge tabs dialog select textarea separator resizable
   npm install @tanstack/react-table
   ```

2. **Extend src/lib/db/schema.ts:**
   - Add `profileStatusEnum` pgEnum with values: `'pending_review'`, `'active'`, `'rejected'`
   - Add these columns to the `profiles` table:
     - `status: profileStatusEnum('status').notNull().default('pending_review')`
     - `rejectionNotes: text('rejection_notes')`
     - `reviewedAt: timestamp('reviewed_at', { withTimezone: true })`
     - `reviewedBy: uuid('reviewed_by').references(() => users.id)`
   - Add an index on `profiles.status`: `index('profiles_status_idx').on(table.status)`
   - Keep ALL existing columns and tables unchanged

3. **Create src/lib/db/relations.ts:**
   Define Drizzle v1 relations using the `relations()` function from `drizzle-orm`. Follow the exact pattern from the research file (Pattern 1). Define relations for:
   - `profilesRelations`: many(education), many(workHistory), many(barAdmissions), many(profileSpecializations), many(profileTechnicalDomains), many(cvUploads)
   - `educationRelations`: one(profiles) via education.profileId -> profiles.id
   - `workHistoryRelations`: one(profiles) via workHistory.profileId -> profiles.id
   - `barAdmissionsRelations`: one(profiles) via barAdmissions.profileId -> profiles.id
   - `profileSpecializationsRelations`: one(profiles) + one(specializations)
   - `profileTechnicalDomainsRelations`: one(profiles) + one(technicalDomains)
   - `cvUploadsRelations`: one(profiles) via cvUploads.profileId -> profiles.id

4. **Update src/lib/db/index.ts:**
   Import relations and spread both schema and relations into the drizzle config:
   ```typescript
   import { drizzle } from 'drizzle-orm/neon-http'
   import * as schema from './schema'
   import * as relations from './relations'

   export const db = drizzle(process.env.DATABASE_URL!, {
     schema: { ...schema, ...relations },
   })
   ```

IMPORTANT: The server actions file is at `src/actions/auth.ts` (not src/lib/actions/). Note this for future reference but do NOT move it.
  </action>
  <verify>
  - `npx tsc --noEmit` passes (no TypeScript errors)
  - Verify `@tanstack/react-table` appears in package.json dependencies
  - Verify shadcn/ui components exist: `ls src/components/ui/table.tsx src/components/ui/badge.tsx src/components/ui/tabs.tsx src/components/ui/dialog.tsx src/components/ui/select.tsx src/components/ui/textarea.tsx src/components/ui/separator.tsx src/components/ui/resizable.tsx`
  - Verify relations.ts exports relation objects (grep for `profilesRelations`)
  - Verify db/index.ts imports and spreads relations
  </verify>
  <done>
  - profileStatusEnum exists in schema with 3 values
  - profiles table has status, rejectionNotes, reviewedAt, reviewedBy columns
  - All Drizzle v1 relations defined for profile + child tables
  - db instance initialized with both schema and relations
  - All shadcn/ui components and TanStack Table installed
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shared badge components (ConfidenceBadge, StatusBadge)</name>
  <files>
    src/components/admin/confidence-badge.tsx
    src/components/admin/status-badge.tsx
  </files>
  <action>
1. **Create src/components/admin/confidence-badge.tsx:**
   - Export a `ConfidenceBadge` component that accepts `level: 'high' | 'medium' | 'low'`
   - Use shadcn/ui `Badge` component with variant styling:
     - `high`: green variant (bg-green-100 text-green-700, dark mode: bg-green-900/30 text-green-400)
     - `medium`: amber/yellow variant (bg-amber-100 text-amber-700, dark mode: bg-amber-900/30 text-amber-400)
     - `low`: red variant (bg-red-100 text-red-700, dark mode: bg-red-900/30 text-red-400)
   - Display the confidence level text capitalized (e.g., "High", "Medium", "Low")
   - Use shadcn/ui Badge as the base with className overrides for the colors (Badge uses `variant="outline"` as base, override bg/text colors)

2. **Create src/components/admin/status-badge.tsx:**
   - Export a `StatusBadge` component that accepts `status: 'pending_review' | 'active' | 'rejected'`
   - Use shadcn/ui `Badge` component with variant styling:
     - `pending_review`: amber/yellow variant, display text "Pending Review"
     - `active`: green variant, display text "Active"
     - `rejected`: red variant, display text "Rejected"
   - Same color pattern as ConfidenceBadge but with appropriate colors per status

Both components should be simple, pure presentational components. No client-side state needed -- they can be used in both server and client components. Do NOT add `'use client'` directive.
  </action>
  <verify>
  - `npx tsc --noEmit` passes
  - Both files exist and export their respective components
  - Components import from `@/components/ui/badge`
  </verify>
  <done>
  - ConfidenceBadge renders high/medium/low with green/amber/red colors
  - StatusBadge renders pending_review/active/rejected with appropriate colors and human-readable labels
  - Both components use shadcn/ui Badge as base
  </done>
</task>

</tasks>

<verification>
- TypeScript compilation passes with no errors
- All 8 shadcn/ui components installed (table, badge, tabs, dialog, select, textarea, separator, resizable)
- @tanstack/react-table in package.json
- Schema has profileStatusEnum and extended profiles columns
- Relations file defines all 7 relation objects
- db instance uses both schema and relations
- Badge components render correctly (check via tsc, no visual test needed yet)
</verification>

<success_criteria>
- Schema extended with profile status tracking (enum + 4 columns)
- Drizzle v1 relational queries functional (db.query.profiles with 'with' option)
- All UI packages installed and importable
- Shared badge components created and type-safe
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-admin-review-and-profiles/03-01-SUMMARY.md`
</output>
