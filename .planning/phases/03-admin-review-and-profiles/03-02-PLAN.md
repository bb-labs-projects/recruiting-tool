---
phase: 03-admin-review-and-profiles
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/actions/profiles.ts
autonomous: true

must_haves:
  truths:
    - "Server action approveProfile sets status to 'active', reviewedAt, reviewedBy"
    - "Server action rejectProfile sets status to 'rejected', stores rejectionNotes, reviewedAt, reviewedBy"
    - "Server action updateProfileField updates a single top-level field (name/email/phone) and sets its confidence to 'high'"
    - "Server action updateEducation updates a single education entry and sets confidence to 'high'"
    - "Server action updateWorkHistory updates a single work history entry and sets confidence to 'high'"
    - "Server action updateBarAdmission updates a single bar admission entry and sets confidence to 'high'"
    - "All server actions verify admin role before proceeding"
    - "All server actions call revalidatePath after mutation"
  artifacts:
    - path: "src/actions/profiles.ts"
      provides: "All profile CRUD server actions"
      exports: ["approveProfile", "rejectProfile", "updateProfileField", "updateEducation", "updateWorkHistory", "updateBarAdmission"]
  key_links:
    - from: "src/actions/profiles.ts"
      to: "src/lib/db/index.ts"
      via: "import db for mutations"
      pattern: "import.*db.*from.*@/lib/db"
    - from: "src/actions/profiles.ts"
      to: "src/lib/dal.ts"
      via: "import getUser for auth check"
      pattern: "import.*getUser.*from.*@/lib/dal"
    - from: "src/actions/profiles.ts"
      to: "next/cache"
      via: "revalidatePath after mutations"
      pattern: "revalidatePath"
---

<objective>
Create all server actions for profile review and editing: approve, reject, update individual fields, and update child table entries (education, work history, bar admissions).

Purpose: These server actions are the mutation layer that the review UI (Plan 04) will call. They enforce admin-only access, validate inputs with Zod, persist changes, and revalidate cached pages.

Output: A single file with all profile mutation server actions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-admin-review-and-profiles/03-RESEARCH.md
@src/lib/db/schema.ts
@src/lib/dal.ts
@src/actions/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create core profile actions (approve, reject, update field)</name>
  <files>src/actions/profiles.ts</files>
  <action>
Create `src/actions/profiles.ts` with `'use server'` directive. This file goes in `src/actions/` (same directory as the existing `auth.ts`).

**Import requirements:**
- `revalidatePath` from `next/cache`
- `db` from `@/lib/db`
- `profiles, education, workHistory, barAdmissions` from `@/lib/db/schema`
- `eq, and` from `drizzle-orm`
- `z` from `zod`
- `getUser` from `@/lib/dal`

**Helper: Admin auth check**
Create an internal async function `requireAdmin()` that:
- Calls `getUser()`
- If `!user || user.role !== 'admin'`, throws or returns `{ error: 'Unauthorized' }`
- Returns the user object

**Action 1: approveProfile**
- Accepts `FormData` with `profileId` (string, uuid)
- Validates with Zod: `{ profileId: z.string().uuid() }`
- Updates profiles table: `status = 'active'`, `reviewedAt = new Date()`, `reviewedBy = user.id`, `updatedAt = new Date()`
- Revalidates `/admin/candidates` and `/admin/candidates/${profileId}`
- Returns `{ success: true }` or `{ error: string }`

**Action 2: rejectProfile**
- Accepts `FormData` with `profileId` (uuid) and `rejectionNotes` (string, min 1 char)
- Validates with Zod
- Updates profiles table: `status = 'rejected'`, `rejectionNotes`, `reviewedAt = new Date()`, `reviewedBy = user.id`, `updatedAt = new Date()`
- Revalidates same paths
- Returns `{ success: true }` or `{ error: string }`

**Action 3: updateProfileField**
- Accepts `FormData` with `profileId` (uuid), `fieldName` (enum: 'name' | 'email' | 'phone'), `value` (string)
- Validates with Zod. Use `z.enum(['name', 'email', 'phone'])` for fieldName
- Updates the specific field on profiles table + sets `${fieldName}Confidence` to `'high'` (human-verified) + `updatedAt = new Date()`
- Use computed property name: `{ [fieldName]: value, [`${fieldName}Confidence`]: 'high', updatedAt: new Date() }`
- Revalidates `/admin/candidates/${profileId}` and `/admin/candidates`
- Returns `{ success: true }` or `{ error: string }`
  </action>
  <verify>
  - `npx tsc --noEmit` passes
  - File has `'use server'` directive at top
  - All three functions are exported
  - Each function checks admin role
  - Each function validates input with Zod
  - Each function calls revalidatePath
  </verify>
  <done>
  - approveProfile, rejectProfile, updateProfileField exported and type-safe
  - Admin auth check on every action
  - Zod validation on every action
  - revalidatePath called after every mutation
  </done>
</task>

<task type="auto">
  <name>Task 2: Add child table update actions (education, work history, bar admissions)</name>
  <files>src/actions/profiles.ts</files>
  <action>
Add three more server actions to `src/actions/profiles.ts`:

**Action 4: updateEducation**
- Accepts `FormData` with: `educationId` (uuid), `profileId` (uuid), `institution` (string, min 1), `degree` (string, min 1), `field` (string, min 1), `year` (string, optional)
- Validates with Zod
- Updates education table where `id = educationId AND profileId = profileId` (both conditions prevent cross-profile edits)
- Sets all provided fields + `confidence = 'high'` (human-verified)
- Revalidates `/admin/candidates/${profileId}`
- Returns `{ success: true }` or `{ error: string }`

**Action 5: updateWorkHistory**
- Accepts `FormData` with: `workHistoryId` (uuid), `profileId` (uuid), `employer` (string, min 1), `title` (string, min 1), `startDate` (string, optional), `endDate` (string, optional), `description` (string, optional)
- Validates with Zod
- Updates work_history table where `id = workHistoryId AND profileId = profileId`
- Sets all provided fields + `confidence = 'high'`
- Revalidates `/admin/candidates/${profileId}`
- Returns `{ success: true }` or `{ error: string }`

**Action 6: updateBarAdmission**
- Accepts `FormData` with: `barAdmissionId` (uuid), `profileId` (uuid), `jurisdiction` (string, min 1), `year` (string, optional), `status` (string, optional)
- Validates with Zod
- Updates bar_admissions table where `id = barAdmissionId AND profileId = profileId`
- Sets all provided fields + `confidence = 'high'`
- Revalidates `/admin/candidates/${profileId}`
- Returns `{ success: true }` or `{ error: string }`

**For optional fields:** Use `.optional().or(z.literal(''))` in Zod schemas so empty form values pass validation. Convert empty strings to null before database update: `year: parsed.data.year || null`.
  </action>
  <verify>
  - `npx tsc --noEmit` passes
  - All 6 functions are exported from the file
  - Each child table action validates both the item ID and the profileId (prevents cross-profile edits)
  - Each child table action sets confidence to 'high' on update
  </verify>
  <done>
  - updateEducation, updateWorkHistory, updateBarAdmission exported and type-safe
  - All 6 server actions in src/actions/profiles.ts
  - Each uses Zod validation, admin check, revalidatePath
  - Child table updates enforce profileId match for security
  - Human edits set confidence to 'high' on all updated records
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- src/actions/profiles.ts exports all 6 functions
- Every action: has admin check, Zod validation, revalidatePath
- updateProfileField correctly uses computed property names for dynamic field + confidence update
- Child table updates use AND condition (id + profileId) for security
</verification>

<success_criteria>
- 6 server actions covering all profile mutation needs for the review UI
- Type-safe Zod validation on every action
- Admin-only access enforced on every action
- Cache revalidation after every mutation
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-admin-review-and-profiles/03-02-SUMMARY.md`
</output>
