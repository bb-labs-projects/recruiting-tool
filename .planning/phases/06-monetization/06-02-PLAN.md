---
phase: 06-monetization
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/components/employer/unlock-button.tsx
  - src/app/(authenticated)/employer/browse/[id]/page.tsx
  - src/app/(authenticated)/employer/purchases/page.tsx
  - src/app/(authenticated)/employer/nav.tsx
autonomous: true

must_haves:
  truths:
    - "Employer sees 'Unlock Full Profile' button that redirects to Stripe Checkout on click"
    - "After payment, employer sees full candidate details (name, email, phone, employer names)"
    - "Previously unlocked profiles show full details immediately without re-payment"
    - "Employer can view a purchase history page listing all unlocked profiles with dates and amounts"
    - "Profile views are tracked for analytics when employer visits a profile detail page"
  artifacts:
    - path: "src/components/employer/unlock-button.tsx"
      provides: "Functional unlock button wired to checkout action"
      contains: "createCheckoutSession"
    - path: "src/app/(authenticated)/employer/browse/[id]/page.tsx"
      provides: "Conditional profile display -- full PII when unlocked, anonymized with unlock CTA when not"
      contains: "isProfileUnlocked"
    - path: "src/app/(authenticated)/employer/purchases/page.tsx"
      provides: "Purchase history page with list of unlocked profiles"
      contains: "getEmployerPurchases"
    - path: "src/app/(authenticated)/employer/nav.tsx"
      provides: "Updated nav with Purchases link"
      contains: "purchases"
  key_links:
    - from: "src/components/employer/unlock-button.tsx"
      to: "src/actions/checkout.ts"
      via: "onClick -> startTransition -> createCheckoutSession"
      pattern: "createCheckoutSession"
    - from: "src/app/(authenticated)/employer/browse/[id]/page.tsx"
      to: "src/lib/dal/employer-unlocks.ts"
      via: "isProfileUnlocked check determines which view to render"
      pattern: "isProfileUnlocked"
    - from: "src/app/(authenticated)/employer/browse/[id]/page.tsx"
      to: "src/lib/dal/employer-profiles.ts"
      via: "getFullProfileById for unlocked, getAnonymizedProfileById for locked"
      pattern: "getFullProfileById"
---

<objective>
Wire the unlock button to Stripe Checkout, display full profiles when unlocked, and add purchase history for employers.

Purpose: This plan connects the backend payment pipeline (Plan 01) to the employer-facing UI. After this plan, an employer can click "Unlock", pay via Stripe, and see the candidate's full details. They can also review all past purchases.

Output: Functional unlock button, conditional profile detail page, purchase history page, updated employer navigation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-monetization/06-RESEARCH.md
@.planning/phases/06-monetization/06-01-SUMMARY.md

@src/components/employer/unlock-button.tsx
@src/app/(authenticated)/employer/browse/[id]/page.tsx
@src/app/(authenticated)/employer/nav.tsx
@src/app/(authenticated)/employer/saved/page.tsx
@src/lib/dal/employer-profiles.ts
@src/lib/dal/employer-unlocks.ts
@src/actions/checkout.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire unlock button and modify profile detail page for conditional PII display</name>
  <files>
    src/components/employer/unlock-button.tsx
    src/app/(authenticated)/employer/browse/[id]/page.tsx
  </files>
  <action>
    1. Rewrite `src/components/employer/unlock-button.tsx`:
       - Add 'use client' directive
       - Accept props: `{ profileId: string; isUnlocked?: boolean }`
       - If `isUnlocked` is true, render a disabled outline button showing "Profile Unlocked" with Unlock icon
       - If not unlocked, render an active button with Lock icon that calls `createCheckoutSession(profileId)` via `useTransition` (for loading state)
       - While pending, show Loader2 spinner and "Processing..." text
       - Disable button while pending to prevent double-clicks
       - Import createCheckoutSession from '@/actions/checkout'
       - Import useTransition from react
       - Import Button from ui/button, Lock, Unlock, Loader2 from lucide-react

    2. Rewrite `src/app/(authenticated)/employer/browse/[id]/page.tsx`:
       - Keep existing approval gate (getUser, getEmployerProfile, redirect if not approved)
       - After approval gate, check unlock status: `const unlocked = await isProfileUnlocked(user.id, id)`
       - Import isProfileUnlocked from '@/lib/dal/employer-unlocks'
       - Import getFullProfileById from '@/lib/dal/employer-profiles' (alongside existing getAnonymizedProfileById import)
       - Import profileViews from '@/lib/db/schema' and db from '@/lib/db' for view tracking

       **Profile view tracking (fire-and-forget):**
       - After fetching profile data, record a view: `db.insert(profileViews).values({ employerUserId: user.id, profileId: id }).catch(() => {})` -- no await, non-blocking, silently ignore failures.

       **If unlocked:**
       - Fetch full profile: `const fullProfile = await getFullProfileById(id, user.id)`
       - If null (shouldn't happen but defensive), fall through to anonymized view
       - Render full profile with:
         - Title: candidate's actual name (fullProfile.name) instead of "IP Professional"
         - Contact info section showing email and phone (with mailto/tel links)
         - Work history showing actual employer names and full descriptions
         - All other sections same as anonymized view (specializations, technical domains, bar admissions, education)
         - Pass `isUnlocked={true}` to UnlockButton component (shows "Profile Unlocked" state)
         - No unlock CTA section needed (replace with contact info section)

       **If not unlocked:**
       - Keep exact existing anonymized behavior (getAnonymizedProfileById, current rendering)
       - Pass `isUnlocked={false}` to UnlockButton
       - Keep the unlock CTA section at the bottom

       **Pending state after payment redirect:**
       - Check for `?unlocked=pending` URL search param
       - If present AND not yet unlocked in DB (webhook hasn't fired yet), show a brief info banner: "Payment received! Your profile unlock is being processed. This page will update automatically." with a meta refresh or `router.refresh()` hint.
       - Use `searchParams` prop (async in Next.js 16: `searchParams: Promise<{ unlocked?: string }>`)

       Keep the existing SaveButton, back link, and overall page structure. The unlocked view is an enhancement of the existing page, not a replacement.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - UnlockButton has 'use client' directive and imports createCheckoutSession
    - Profile detail page imports isProfileUnlocked and getFullProfileById
    - Profile detail page has fire-and-forget view tracking (db.insert(profileViews)...catch)
    - Profile detail page handles `?unlocked=pending` search param
    - Profile detail page renders name/email/phone when unlocked
    - Profile detail page renders anonymized view when not unlocked
  </verify>
  <done>
    Unlock button wired to Stripe Checkout with loading state and double-click prevention. Profile detail page conditionally shows full PII (name, email, phone, employer names) when unlocked, or anonymized view with unlock CTA when not. Profile views tracked for analytics.
  </done>
</task>

<task type="auto">
  <name>Task 2: Purchase history page and employer navigation update</name>
  <files>
    src/app/(authenticated)/employer/purchases/page.tsx
    src/app/(authenticated)/employer/nav.tsx
  </files>
  <action>
    1. Create `src/app/(authenticated)/employer/purchases/page.tsx`:
       - Server component (no 'use client')
       - Approval gate: getUser, getEmployerProfile, redirect if not approved (same pattern as browse pages)
       - Fetch purchases: `const purchases = await getEmployerPurchases(user.id)` from employer-unlocks DAL
       - Display a table/list of purchases with columns:
         - Profile specializations (joined from the DAL query)
         - Amount paid (format as currency: `$${(amountPaid / 100).toFixed(2)}`)
         - Date unlocked (format with toLocaleDateString)
         - "View Profile" link to `/employer/browse/${profileId}`
       - If no purchases, show empty state: "No purchases yet. Browse candidates and unlock profiles to see their full details." with a link to /employer/browse
       - Use Card component for the page container, standard heading pattern
       - Page title: "Purchase History"

    2. Update `src/app/(authenticated)/employer/nav.tsx`:
       - Add a "Purchases" link between "Saved" and the end of the nav array
       - Use `Receipt` icon from lucide-react (or `CreditCard` -- whichever is available)
       - href: '/employer/purchases', exact: true
       - Keep existing Dashboard, Browse, Saved links unchanged

    Follow the exact patterns from the saved profiles page (`src/app/(authenticated)/employer/saved/page.tsx`) for the page layout, approval gate, and empty state patterns.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Purchase history page exists at `src/app/(authenticated)/employer/purchases/page.tsx`
    - Purchase history page imports getEmployerPurchases from employer-unlocks DAL
    - Employer nav includes "Purchases" link
    - Currency formatting divides by 100 (cents to dollars)
  </verify>
  <done>
    Purchase history page shows all unlocked profiles with amounts and dates. Employer navigation updated with Purchases link. Empty state guides employers to browse when no purchases exist.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes -- all modified/new files compile
2. UnlockButton calls createCheckoutSession server action on click
3. Profile detail page checks isProfileUnlocked and renders full/anonymized accordingly
4. Full profile view shows name, email, phone, employer names in work history
5. Profile view tracking fires on every profile detail page load
6. Purchase history page lists unlocked profiles with formatted currency
7. Employer nav shows Dashboard, Browse, Saved, Purchases links
8. Pending payment state shows informational banner
</verification>

<success_criteria>
- Unlock button redirects to Stripe Checkout on click (with loading state)
- Unlocked profiles show full candidate details (name, email, phone, employer names)
- Non-unlocked profiles show anonymized view with unlock CTA (unchanged behavior)
- Purchase history page lists all employer's unlocked profiles with amounts and dates
- Employer nav includes Purchases link
- Profile views are tracked for admin analytics
</success_criteria>

<output>
After completion, create `.planning/phases/06-monetization/06-02-SUMMARY.md`
</output>
