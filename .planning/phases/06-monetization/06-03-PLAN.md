---
phase: 06-monetization
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/lib/dal/admin-analytics.ts
  - src/app/admin/analytics/page.tsx
  - src/app/admin/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view total revenue from profile unlocks"
    - "Admin can view total profile views and unlock count"
    - "Admin can see unlock conversion rate (unlocks / views)"
    - "Admin can see most viewed and most unlocked profiles"
    - "Admin dashboard shows live data instead of placeholder dashes"
  artifacts:
    - path: "src/lib/dal/admin-analytics.ts"
      provides: "Analytics aggregate queries"
      exports: ["getAnalyticsSummary", "getTopProfiles", "getRecentUnlocks"]
    - path: "src/app/admin/analytics/page.tsx"
      provides: "Admin analytics dashboard page"
      contains: "getAnalyticsSummary"
    - path: "src/app/admin/page.tsx"
      provides: "Updated admin dashboard with live candidate/employer/revenue counts"
      contains: "count"
  key_links:
    - from: "src/app/admin/analytics/page.tsx"
      to: "src/lib/dal/admin-analytics.ts"
      via: "Server component calling analytics DAL functions"
      pattern: "getAnalyticsSummary"
    - from: "src/lib/dal/admin-analytics.ts"
      to: "src/lib/db/schema.ts"
      via: "Aggregate queries on profileUnlocks, profileViews, profiles tables"
      pattern: "profileUnlocks|profileViews|profiles"
---

<objective>
Build admin analytics dashboard and update the admin dashboard with live data.

Purpose: This plan fulfills ADMN-03 (admin analytics) by creating aggregate queries over profile views, unlocks, and revenue data, and displaying them in a dedicated analytics page. Also replaces the placeholder admin dashboard with live counts.

Output: Admin analytics DAL module, analytics page with summary metrics and top profiles, updated admin dashboard with real data.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-monetization/06-RESEARCH.md
@.planning/phases/06-monetization/06-01-SUMMARY.md

@src/lib/db/schema.ts
@src/lib/db/relations.ts
@src/lib/dal/admin-employers.ts
@src/app/admin/page.tsx
@src/app/admin/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin analytics DAL and analytics page</name>
  <files>
    src/lib/dal/admin-analytics.ts
    src/app/admin/analytics/page.tsx
  </files>
  <action>
    1. Create `src/lib/dal/admin-analytics.ts` with cached query functions:

       **getAnalyticsSummary()** -- returns aggregate metrics:
       - Total revenue: `sum(profileUnlocks.amountPaid)` -- returns number in cents
       - Total unlocks: `count()` from profileUnlocks
       - Total profile views: `count()` from profileViews
       - Total active profiles: `count()` from profiles where status = 'active'
       - Total approved employers: `count()` from employerProfiles where status = 'approved'
       - Conversion rate: `(totalUnlocks / totalViews * 100).toFixed(1)` (handle division by zero)
       - Return type: `{ totalRevenue: number, totalUnlocks: number, totalViews: number, activeProfiles: number, approvedEmployers: number, conversionRate: string }`

       **getTopProfiles(limit = 10)** -- most viewed profiles:
       - SELECT profileId, count(*) as viewCount FROM profileViews GROUP BY profileId ORDER BY viewCount DESC LIMIT limit
       - Also join with profiles table to get profile status (only show active profiles)
       - Join with profileSpecializations -> specializations to get specialization names for display
       - Return array of: `{ profileId, viewCount, specializations: string[] }`

       **getRecentUnlocks(limit = 10)** -- latest unlock transactions:
       - SELECT from profileUnlocks ORDER BY unlockedAt DESC LIMIT limit
       - Join with users table to get employer email
       - Join with profiles to check profile status
       - Join with profileSpecializations -> specializations for display
       - Return array of: `{ profileId, employerEmail, amountPaid, currency, unlockedAt, specializations: string[] }`

       Follow the pattern in existing DAL files: import 'server-only', cache wrapper, db import from '@/lib/db'.
       Import count, sum, desc, eq, sql from drizzle-orm as needed.
       Import relevant tables from schema.

    2. Create `src/app/admin/analytics/page.tsx`:
       - Server component with admin auth gate (same pattern as admin/page.tsx: getUser, redirect if not admin)
       - Call all three DAL functions: getAnalyticsSummary, getTopProfiles, getRecentUnlocks
       - Layout:

       **Summary Cards Row (4 cards in a grid):**
       - Total Revenue: format as `$${(totalRevenue / 100).toFixed(2)}` with DollarSign icon
       - Total Unlocks: plain number with Unlock icon
       - Total Profile Views: plain number with Eye icon
       - Conversion Rate: `${conversionRate}%` with TrendingUp icon
       - Use Card/CardHeader/CardTitle/CardContent from shadcn/ui
       - Grid: `grid gap-4 sm:grid-cols-2 lg:grid-cols-4`

       **Two-column layout below cards:**

       Left column -- **Most Viewed Profiles** (Card with table):
       - Table with columns: Specializations (badges), Views (count), Action (Link to admin candidate detail)
       - If no views yet, show "No profile views recorded yet"

       Right column -- **Recent Unlocks** (Card with table):
       - Table with columns: Employer (email), Specializations (badges), Amount (formatted), Date
       - If no unlocks yet, show "No profile unlocks yet"

       Icons to use from lucide-react: DollarSign, Unlock, Eye, TrendingUp, Users, Building2
       Use Badge from shadcn/ui for specializations display (same pattern as browse pages).
       Use standard Table/TableHeader/TableRow/TableCell from shadcn/ui if available, otherwise use simple HTML table with Tailwind classes.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `src/lib/dal/admin-analytics.ts` exports getAnalyticsSummary, getTopProfiles, getRecentUnlocks
    - `src/app/admin/analytics/page.tsx` exists and imports from admin-analytics DAL
    - Analytics page has admin auth gate (getUser, role check)
    - Revenue is formatted as dollars (divided by 100)
    - Conversion rate handles zero views (no division by zero)
  </verify>
  <done>
    Admin analytics DAL provides summary metrics, top viewed profiles, and recent unlock transactions. Analytics page displays all metrics in a card grid with top profiles and recent unlocks tables.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update admin dashboard with live data</name>
  <files>
    src/app/admin/page.tsx
  </files>
  <action>
    Update `src/app/admin/page.tsx` to replace placeholder "--" values with real database counts:

    1. Import count from 'drizzle-orm' and db from '@/lib/db'
    2. Import profiles, employerProfiles, profileUnlocks from schema (only if profileUnlocks exists after Plan 01)
    3. Import eq, sql from 'drizzle-orm'

    4. Add three queries after the auth gate:
       - Active candidates: `SELECT count(*) FROM profiles WHERE status = 'active'`
       - Approved employers: `SELECT count(*) FROM employerProfiles WHERE status = 'approved'`
       - Total revenue: `SELECT sum(amountPaid) FROM profileUnlocks` (returns null if no rows, default to 0)

    5. Update the three existing cards:
       - **Candidates card:** Show the actual count number. Update description to "Active candidate profiles"
       - **Employers card:** Show the actual count number. Update description to "Approved employer accounts"
       - **Revenue card:** Show formatted revenue `$${(totalRevenue / 100).toFixed(2)}`. Update description to "Total from profile unlocks"

    6. Add a fourth card:
       - **Quick Links card** with links to:
         - "View Analytics" -> /admin/analytics
         - "Manage Candidates" -> /admin/candidates
         - "Manage Employers" -> /admin/employers
       - Use simple link list with arrow icons

    Keep the existing page structure and auth gate. Only replace the placeholder content in the cards.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Admin dashboard page queries profiles, employerProfiles, profileUnlocks tables
    - No placeholder "--" values remain in the cards
    - Revenue formatted as dollars (divided by 100)
    - Quick links card includes link to /admin/analytics
  </verify>
  <done>
    Admin dashboard shows live counts: active candidates, approved employers, total revenue. Placeholder values replaced with real database queries. Quick links card provides navigation to analytics and management pages.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes -- all files compile
2. Analytics DAL exports three cached functions: getAnalyticsSummary, getTopProfiles, getRecentUnlocks
3. Analytics page displays summary cards (revenue, unlocks, views, conversion rate)
4. Analytics page displays top profiles and recent unlocks tables
5. Admin dashboard shows real counts instead of "--" placeholders
6. All currency amounts formatted correctly (cents to dollars)
7. Division by zero handled in conversion rate calculation
8. Admin auth gate on analytics page (admin role required)
</verification>

<success_criteria>
- Admin analytics page at /admin/analytics shows revenue, unlock count, view count, conversion rate
- Admin analytics page shows most viewed profiles and recent unlock transactions
- Admin dashboard at /admin shows live candidate count, employer count, and total revenue
- All amounts properly formatted as currency (cents to dollars)
- All pages have admin auth gates
</success_criteria>

<output>
After completion, create `.planning/phases/06-monetization/06-03-SUMMARY.md`
</output>
