---
phase: 2
plan: 02-04
title: "Admin CV Upload UI with Batch Processing and Status Tracking"
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - src/app/admin/cv-upload/page.tsx
  - src/app/admin/layout.tsx
autonomous: false
estimated_minutes: 30

user_setup:
  - service: anthropic
    why: "Claude API for CV parsing"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys -> Create Key"
  - service: vercel-blob
    why: "PDF file storage"
    env_vars:
      - name: BLOB_READ_WRITE_TOKEN
        source: "Vercel Dashboard -> Storage -> Create Blob Store -> Get token (or use vercel env pull)"

must_haves:
  truths:
    - "Admin can drag-and-drop or click to select multiple PDF files for upload"
    - "Each file uploads to Vercel Blob and a cvUpload record is created in the database"
    - "Admin can trigger parsing of uploaded CVs and see real-time status updates (uploaded, parsing, parsed, failed)"
    - "Admin can retry failed parses with a retry button"
    - "Batch upload processes files in groups and shows per-file progress"
  artifacts:
    - path: "src/app/admin/cv-upload/page.tsx"
      provides: "Complete CV upload page with drag-drop, status tracking, batch parsing"
      min_lines: 100
    - path: "src/app/admin/layout.tsx"
      provides: "Updated admin nav with CV Upload link"
      contains: "cv-upload"
  key_links:
    - from: "src/app/admin/cv-upload/page.tsx"
      to: "/api/admin/cv/upload"
      via: "Vercel Blob client upload"
      pattern: "upload.*handleUploadUrl.*upload"
    - from: "src/app/admin/cv-upload/page.tsx"
      to: "/api/admin/cv/batch"
      via: "fetch POST to trigger batch parsing"
      pattern: "fetch.*batch"
    - from: "src/app/admin/cv-upload/page.tsx"
      to: "/api/admin/cv/status"
      via: "polling for status updates"
      pattern: "fetch.*status"
---

<objective>
Build the admin-facing CV upload page with drag-and-drop multi-file upload, Vercel Blob client upload integration, batch parse triggering, real-time status polling, and retry functionality for failed parses. Also update admin navigation to include the CV Upload link.

Purpose: This is the user-facing interface for the entire CV parsing pipeline. The admin needs to upload 95+ PDF CVs, trigger parsing, and monitor progress -- all from a single page.

Output: Admin CV upload page and updated admin layout navigation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cv-parsing-pipeline/02-RESEARCH.md
@.planning/phases/02-cv-parsing-pipeline/02-01-SUMMARY.md
@.planning/phases/02-cv-parsing-pipeline/02-02-SUMMARY.md
@.planning/phases/02-cv-parsing-pipeline/02-03-SUMMARY.md
@src/app/admin/layout.tsx
@src/app/admin/page.tsx
</context>

<tasks>

<task id="02-04-T1">
<title>Task 1: Create admin CV upload page with full functionality</title>
<details>
Create `src/app/admin/cv-upload/page.tsx` as a client component ('use client').

The page needs these sections:

**1. Upload Area (top of page)**
- Drag-and-drop zone that accepts PDF files only
- Also has a "Select files" button (hidden file input triggered by button click)
- Accepts multiple files
- Shows file validation errors inline (non-PDF rejected, >10MB rejected)
- On drop/select: immediately starts uploading each file to Vercel Blob using:
  ```typescript
  import { upload } from '@vercel/blob/client'

  const blob = await upload(file.name, file, {
    access: 'public', // or 'private' -- check Vercel Blob docs
    handleUploadUrl: '/api/admin/cv/upload',
  })
  ```
- After each successful blob upload, create a cvUpload record by calling a small API or relying on onUploadCompleted. Since onUploadCompleted doesn't work in local dev, after blob upload succeeds, call a separate POST to register the upload:

  Actually, the handleUpload route's onUploadCompleted creates the DB record in production. For local dev compatibility, after the client upload returns the blob, also POST to `/api/admin/cv/parse` with a flag or rely on the status endpoint.

  Simpler approach: After blob upload succeeds, make a POST to create the DB record explicitly. Create a small helper route or add logic to the upload route.

  BEST approach (research-backed): The `handleUpload()` flow handles the token exchange. The `onUploadCompleted` callback creates the DB record. For local dev, you can use `onBeforeGenerateToken` to pass the admin userId into the token metadata, and have the client create the DB record after upload if `onUploadCompleted` didn't fire.

  SIMPLEST approach: After blob `upload()` returns on the client, immediately POST to a small endpoint that creates the cvUpload DB record:
  ```typescript
  // After blob upload succeeds
  await fetch('/api/admin/cv/upload', {
    method: 'PUT', // Use PUT for record creation after upload
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ filename: file.name, blobUrl: blob.url })
  })
  ```

  Add a PUT handler to the upload route that creates the DB record. This way the flow works both locally and in production. The `onUploadCompleted` callback can be a no-op or also create the record (with upsert to avoid duplicates).

- Show upload progress per file (uploading spinner, then checkmark)

**2. Upload List with Status (middle of page)**
- Table/card list showing all CV uploads
- Columns: Filename, Status (badge), Uploaded At, Parsed At, Actions
- Status badges with colors:
  - `uploaded` -- blue/neutral badge
  - `parsing` -- yellow/amber badge with spinner
  - `parsed` -- green badge with checkmark
  - `failed` -- red badge with error icon
- For failed uploads, show error message in a tooltip or expandable row
- For failed uploads, show a "Retry" button that calls POST /api/admin/cv/parse with that cvUploadId

**3. Batch Actions (between upload area and list)**
- "Parse All Uploaded" button -- takes all CVs with status 'uploaded' and sends them for parsing in batches
- Batch logic on the client:
  ```typescript
  const uploadedIds = uploads.filter(u => u.status === 'uploaded').map(u => u.id)
  const BATCH_SIZE = 10
  for (let i = 0; i < uploadedIds.length; i += BATCH_SIZE) {
    const batch = uploadedIds.slice(i, i + BATCH_SIZE)
    await fetch('/api/admin/cv/batch', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ cvUploadIds: batch })
    })
  }
  ```
- Show overall progress: "Parsing: 45/95 complete" with a progress bar
- Disable button while parsing is in progress

**4. Status Polling**
- Use `useEffect` + `setInterval` to poll GET /api/admin/cv/status every 3 seconds while any uploads have status 'parsing'
- Stop polling when no uploads are in 'parsing' state
- Update the list in real-time as statuses change

**Styling:**
- Use existing shadcn components: Card, Button, Badge (if available), or simple Tailwind classes matching the admin dashboard style
- The page should match the admin layout's visual style (gray/neutral tones, clean typography)
- Use lucide-react icons: Upload, FileText, CheckCircle, XCircle, Loader2 (for spinner)

**State management:**
- `uploads`: array of cvUpload records from the status endpoint
- `isUploading`: boolean, true while files are being uploaded to blob
- `isPolling`: boolean, true while polling for status updates
- Fetch initial uploads list on mount

**Important implementation note on the PUT handler:**
Add a PUT handler to `src/app/api/admin/cv/upload/route.ts` (same file as the POST handler for handleUpload):
```typescript
export async function PUT(request: Request) {
  try {
    const { userId } = await requireAdmin()
    const { filename, blobUrl } = await request.json()

    const [record] = await db.insert(cvUploads).values({
      filename,
      blobUrl,
      uploadedBy: userId,
      status: 'uploaded',
    }).returning()

    return NextResponse.json(record)
  } catch (error) {
    // auth error handling
  }
}
```
</details>
<files>
- src/app/admin/cv-upload/page.tsx (create)
- src/app/api/admin/cv/upload/route.ts (modify -- add PUT handler)
</files>
</task>

<task id="02-04-T2">
<title>Task 2: Update admin layout navigation and add verification checkpoint</title>
<details>
Modify `src/app/admin/layout.tsx` to add "CV Upload" to the navigation links:

Find the `navLinks` array and add:
```typescript
const navLinks = [
  { name: 'Dashboard', href: '/admin' },
  { name: 'CV Upload', href: '/admin/cv-upload' },  // ADD THIS
  { name: 'Candidates', href: '/admin/candidates' },
  { name: 'Employers', href: '/admin/employers' },
  { name: 'Analytics', href: '/admin/analytics' },
]
```

Place "CV Upload" second in the list since it's the primary admin action for Phase 2.
</details>
<files>
- src/app/admin/layout.tsx (modify)
</files>
</task>

<task id="02-04-T3" type="checkpoint:human-verify">
<title>Task 3: Verify complete CV upload and parsing flow</title>
<details>
<what-built>Complete CV upload and parsing pipeline: admin uploads PDFs via drag-and-drop, CVs are stored in Vercel Blob, parsed by Claude Haiku 4.5 with structured output, and results stored in normalized database tables with confidence scoring.</what-built>
<how-to-verify>
Prerequisites: Ensure ANTHROPIC_API_KEY and BLOB_READ_WRITE_TOKEN are set in .env.local. Run `npx drizzle-kit push` to apply new schema tables.

1. Start the dev server: `npm run dev`
2. Log in as admin and navigate to /admin/cv-upload
3. Verify the page has a drag-and-drop upload zone
4. Upload a single PDF CV -- verify it appears in the list with "uploaded" status
5. Click "Parse All Uploaded" or trigger parse on the single CV
6. Watch the status change: uploaded -> parsing -> parsed (or failed)
7. If parsed successfully, verify the data exists in the database (check profiles table)
8. Upload 3-5 more CVs at once (drag multiple files)
9. Trigger batch parsing, verify progress updates via polling
10. If any fail, verify the retry button works
</how-to-verify>
<resume-signal>Type "approved" or describe any issues found</resume-signal>
</details>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- TypeScript compiles
2. Admin CV upload page renders at /admin/cv-upload
3. Admin layout nav includes "CV Upload" link
4. Drag-and-drop upload works, files go to Vercel Blob
5. Parse trigger calls Claude API and stores structured data
6. Status polling updates UI every 3 seconds during parsing
7. Failed parses show error message and retry button
8. Batch parsing sends CVs in groups of 10
</verification>

<success_criteria>
- Admin can upload PDF CVs via drag-and-drop or file picker
- Uploaded files are stored in Vercel Blob with DB record tracking
- Single and batch parse triggers work correctly
- Status polling shows real-time progress updates
- Failed parses display error messages and can be retried
- Admin nav includes CV Upload link
- Complete flow works end-to-end: upload -> parse -> stored in DB
</success_criteria>

<output>
After completion, create `.planning/phases/02-cv-parsing-pipeline/02-04-SUMMARY.md`
</output>
