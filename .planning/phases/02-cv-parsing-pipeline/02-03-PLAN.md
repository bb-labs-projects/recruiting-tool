---
phase: 2
plan: 02-03
title: "Upload Handler and API Routes"
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - src/lib/auth/require-admin.ts
  - src/app/api/admin/cv/upload/route.ts
  - src/app/api/admin/cv/parse/route.ts
  - src/app/api/admin/cv/parse/[id]/route.ts
  - src/app/api/admin/cv/status/route.ts
  - src/app/api/admin/cv/batch/route.ts
autonomous: true
estimated_minutes: 30

must_haves:
  truths:
    - "Admin can upload a PDF via Vercel Blob client upload and a cvUpload record is created in the database"
    - "Admin can trigger parsing of a single CV via POST /api/admin/cv/parse with the cvUpload ID"
    - "Admin can check the status of all CV uploads via GET /api/admin/cv/status"
    - "Admin can trigger batch parsing via POST /api/admin/cv/batch which processes multiple CVs asynchronously"
    - "All routes verify admin authentication and return 401/403 for unauthorized requests"
  artifacts:
    - path: "src/lib/auth/require-admin.ts"
      provides: "Shared admin auth verification for API routes"
      contains: "requireAdmin"
    - path: "src/app/api/admin/cv/upload/route.ts"
      provides: "Vercel Blob client upload handler using handleUpload()"
      contains: "handleUpload"
    - path: "src/app/api/admin/cv/parse/route.ts"
      provides: "Single CV parse trigger"
      contains: "parseSingleCv"
    - path: "src/app/api/admin/cv/parse/[id]/route.ts"
      provides: "Get parse status for a single CV upload"
      contains: "GET"
    - path: "src/app/api/admin/cv/status/route.ts"
      provides: "List all CV uploads with status for the admin"
      contains: "GET"
    - path: "src/app/api/admin/cv/batch/route.ts"
      provides: "Batch parse trigger using after()"
      contains: "after"
  key_links:
    - from: "src/app/api/admin/cv/upload/route.ts"
      to: "@vercel/blob"
      via: "handleUpload() for client upload"
      pattern: "handleUpload"
    - from: "src/app/api/admin/cv/parse/route.ts"
      to: "src/lib/cv-parser/parse.ts"
      via: "import parseSingleCv"
      pattern: "parseSingleCv"
    - from: "src/app/api/admin/cv/batch/route.ts"
      to: "next/server after()"
      via: "async background processing"
      pattern: "after\\("
---

<objective>
Create all API route handlers for the CV upload and parsing pipeline: Vercel Blob client upload handler, single parse trigger, batch parse trigger with async processing, and status polling endpoints.

Purpose: These routes form the API surface that the admin UI will call. The upload route handles Vercel Blob's client upload protocol. The parse routes trigger the core parser from Plan 02-02. The status routes enable the UI to poll for progress.

Output: Shared admin auth helper, plus five route handler files under src/app/api/admin/cv/.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cv-parsing-pipeline/02-RESEARCH.md
@.planning/phases/02-cv-parsing-pipeline/02-01-SUMMARY.md
@.planning/phases/02-cv-parsing-pipeline/02-02-SUMMARY.md
@src/lib/dal.ts
@src/lib/auth/session.ts
@src/lib/db/schema.ts
</context>

<tasks>

<task id="02-03-T1">
<title>Task 1: Create shared admin auth helper, Vercel Blob upload route, and status endpoints</title>
<details>
Create four files:

**File 1: `src/lib/auth/require-admin.ts`**

Shared helper for admin auth verification in API routes. The DAL's `verifySession()` calls `redirect()` which throws in API routes, so this helper throws catchable errors instead.

```typescript
import 'server-only'
import { cookies } from 'next/headers'
import { decrypt } from '@/lib/auth/session'
import { db } from '@/lib/db'
import { users, sessions } from '@/lib/db/schema'
import { eq, and, gt } from 'drizzle-orm'
import { AUTH_CONSTANTS } from '@/lib/auth/constants'

export async function requireAdmin(): Promise<{ userId: string }> {
  const cookieStore = await cookies()
  const sessionCookie = cookieStore.get(AUTH_CONSTANTS.SESSION_COOKIE_NAME)?.value
  const payload = await decrypt(sessionCookie)

  if (!payload?.sessionId) {
    throw new Error('Unauthorized')
  }

  // Verify session exists and not expired
  const [session] = await db.select({ userId: sessions.userId })
    .from(sessions)
    .where(and(eq(sessions.id, payload.sessionId), gt(sessions.expiresAt, new Date())))
    .limit(1)

  if (!session) {
    throw new Error('Unauthorized')
  }

  // Verify user is admin
  const [user] = await db.select({ id: users.id, role: users.role })
    .from(users).where(eq(users.id, session.userId)).limit(1)

  if (!user || user.role !== 'admin') {
    throw new Error('Forbidden')
  }

  return { userId: user.id }
}
```

All route handlers should use this shared helper and catch its errors to return proper HTTP responses:
```typescript
try {
  const { userId } = await requireAdmin()
  // ... route logic
} catch (error) {
  if (error instanceof Error && error.message === 'Forbidden') {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
  }
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
}
```

**File 2: `src/app/api/admin/cv/upload/route.ts`**

Handles Vercel Blob client upload protocol using `handleUpload()`.

```typescript
import { handleUpload, type HandleUploadBody } from '@vercel/blob/client'
import { NextResponse } from 'next/server'
import { db } from '@/lib/db'
import { cvUploads } from '@/lib/db/schema'
import { requireAdmin } from '@/lib/auth/require-admin'
```

Implementation:
- Export POST handler
- Call `handleUpload()` with:
  - `body`: parsed from request JSON
  - `request`: the incoming request
  - `onBeforeGenerateToken`: async callback that verifies admin auth via `requireAdmin()` (return `{ allowedContentTypes: ['application/pdf'], maximumSizeInBytes: 10 * 1024 * 1024 }` for 10MB limit)
  - `onUploadCompleted`: async callback that creates a cvUpload record in the database with `{ filename: blob.pathname, blobUrl: blob.url, uploadedBy: adminUserId, status: 'uploaded' }`. Note: this callback does NOT fire in local dev (Vercel servers can't reach localhost), so the client also calls the PUT handler as a fallback.
- Return the JSON response from handleUpload

- Export PUT handler for explicit DB record creation (used by client after blob upload completes, works in both local dev and production):
```typescript
export async function PUT(request: Request) {
  try {
    const { userId } = await requireAdmin()
    const { filename, blobUrl } = await request.json()

    const [record] = await db.insert(cvUploads).values({
      filename,
      blobUrl,
      uploadedBy: userId,
      status: 'uploaded',
    }).returning()

    return NextResponse.json(record)
  } catch (error) {
    // auth error handling
  }
}
```

**File 3: `src/app/api/admin/cv/status/route.ts`**

GET endpoint that returns all CV uploads for the authenticated admin.

- Verify admin auth
- Query cvUploads table ordered by createdAt desc
- Return array of `{ id, filename, status, errorMessage, profileId, createdAt, parsedAt }`
- This is the polling endpoint the UI calls to track progress

**File 4: `src/app/api/admin/cv/parse/[id]/route.ts`**

GET endpoint that returns the status of a single CV upload by ID.

- Verify admin auth
- Fetch the cvUpload by ID
- If not found, return 404
- Return `{ id, filename, status, errorMessage, profileId, createdAt, parsedAt }`
</details>
<files>
- src/lib/auth/require-admin.ts (create)
- src/app/api/admin/cv/upload/route.ts (create)
- src/app/api/admin/cv/status/route.ts (create)
- src/app/api/admin/cv/parse/[id]/route.ts (create)
</files>
</task>

<task id="02-03-T2">
<title>Task 2: Create parse trigger and batch parse routes</title>
<details>
Create two route files:

**File 1: `src/app/api/admin/cv/parse/route.ts`**

POST endpoint that triggers parsing of a single CV.

- Verify admin auth
- Accept JSON body: `{ cvUploadId: string }`
- Validate cvUploadId is provided
- Import and call `parseSingleCv(cvUploadId)` from `@/lib/cv-parser/parse`
- Return the result: `{ success: boolean, profileId?: string, error?: string }`
- Set `maxDuration = 60` (export at module level) for Claude API call time

```typescript
export const maxDuration = 60

export async function POST(request: Request) {
  try {
    const { userId } = await requireAdmin()
    const { cvUploadId } = await request.json()

    if (!cvUploadId) {
      return NextResponse.json({ error: 'cvUploadId is required' }, { status: 400 })
    }

    const result = await parseSingleCv(cvUploadId)
    return NextResponse.json(result)
  } catch (error) {
    // auth error handling...
  }
}
```

**File 2: `src/app/api/admin/cv/batch/route.ts`**

POST endpoint that triggers batch parsing of multiple CVs asynchronously using `after()`.

- Verify admin auth
- Accept JSON body: `{ cvUploadIds: string[] }` -- array of cvUpload IDs to parse
- Validate the array is present and not empty, max 50 per batch
- Update all specified cvUploads to status 'parsing' immediately
- Return 202 Accepted with `{ message: 'Batch parsing started', count: N }`
- Use `after()` from 'next/server' to process CVs in the background:
  ```typescript
  import { after } from 'next/server'

  after(async () => {
    for (const id of cvUploadIds) {
      try {
        await parseSingleCv(id)
      } catch (error) {
        // parseSingleCv handles its own error state,
        // but catch here to prevent batch abort
        console.error(`Failed to parse CV ${id}:`, error)
      }
      // Rate limit delay: 500ms between API calls
      await new Promise(resolve => setTimeout(resolve, 500))
    }
  })
  ```
- Set `maxDuration = 300` for batch processing (5 minutes, handles ~15-20 CVs per batch comfortably)

Important: The frontend should send batches of 10-15 CVs at a time, not all 95 at once. Each batch request gets its own 300s window. The status polling endpoint tracks overall progress.
</details>
<files>
- src/app/api/admin/cv/parse/route.ts (create)
- src/app/api/admin/cv/batch/route.ts (create)
</files>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- TypeScript compiles without errors
2. All six files exist (1 auth helper + 5 route handlers) and export the correct items
3. Every route uses requireAdmin() for auth verification
4. Upload route uses handleUpload() from @vercel/blob/client
5. Parse route imports and calls parseSingleCv
6. Batch route uses after() from next/server
7. maxDuration is exported from parse (60) and batch (300) routes
</verification>

<success_criteria>
- Upload route handles Vercel Blob client upload protocol with admin auth in onBeforeGenerateToken
- Parse route triggers single CV parsing and returns result synchronously
- Batch route accepts array of IDs, returns 202 immediately, processes in background via after()
- Status route returns all CV uploads sorted by newest first
- Single status route returns individual CV upload by ID
- Shared requireAdmin() helper validates session and admin role consistently
- All routes return proper HTTP status codes (401, 403, 404, 400, 200, 202)
</success_criteria>

<output>
After completion, create `.planning/phases/02-cv-parsing-pipeline/02-03-SUMMARY.md`
</output>
