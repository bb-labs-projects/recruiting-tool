---
phase: 2
plan: 02-02
title: "CV Parser Core -- Claude API Integration and Zod Schemas"
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/lib/cv-parser/schema.ts
  - src/lib/cv-parser/prompt.ts
  - src/lib/cv-parser/parse.ts
autonomous: true
estimated_minutes: 30

must_haves:
  truths:
    - "parseSingleCv() accepts a cvUpload ID, fetches the PDF from Vercel Blob, sends it to Claude API, and stores the parsed result in all normalized database tables"
    - "Claude API is called with structured output using output_config.format and zodOutputFormat() -- not client.messages.parse()"
    - "Every extracted field has an associated confidence level (high/medium/low)"
    - "On success, cvUpload status is updated to 'parsed' with profileId set; on failure, status is 'failed' with errorMessage"
  artifacts:
    - path: "src/lib/cv-parser/schema.ts"
      provides: "Zod schemas for Claude structured output with confidence scoring"
      contains: "CvParsedDataSchema"
    - path: "src/lib/cv-parser/prompt.ts"
      provides: "System prompt for IP lawyer CV extraction"
      contains: "CV_EXTRACTION_PROMPT"
    - path: "src/lib/cv-parser/parse.ts"
      provides: "Main parse function that calls Claude API and stores results"
      contains: "parseSingleCv"
  key_links:
    - from: "src/lib/cv-parser/parse.ts"
      to: "@anthropic-ai/sdk"
      via: "import Anthropic"
      pattern: "import Anthropic"
    - from: "src/lib/cv-parser/parse.ts"
      to: "src/lib/cv-parser/schema.ts"
      via: "zodOutputFormat(CvParsedDataSchema)"
      pattern: "zodOutputFormat.*CvParsedDataSchema"
    - from: "src/lib/cv-parser/parse.ts"
      to: "src/lib/db/schema.ts"
      via: "database inserts to profiles and related tables"
      pattern: "db\\.insert"
    - from: "src/lib/cv-parser/parse.ts"
      to: "@vercel/blob"
      via: "fetch PDF from blob URL"
      pattern: "fetch.*blobUrl"
---

<objective>
Create the core CV parsing module that takes a PDF stored in Vercel Blob, sends it to Claude Haiku 4.5 for structured extraction of IP lawyer data with confidence scoring, and stores the parsed result in the normalized database tables.

Purpose: This is the core intelligence of the CV parsing pipeline -- the module that turns unstructured PDFs into structured, queryable candidate data. Everything else (upload UI, batch processing, status tracking) is orchestration around this core.

Output: Three files in src/lib/cv-parser/ -- Zod schemas, extraction prompt, and the main parse function.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cv-parsing-pipeline/02-RESEARCH.md
@.planning/phases/02-cv-parsing-pipeline/02-01-SUMMARY.md
@src/lib/db/schema.ts
</context>

<tasks>

<task id="02-02-T1">
<title>Task 1: Create Zod schemas for Claude structured output</title>
<details>
Create `src/lib/cv-parser/schema.ts` with Zod schemas that define the shape of Claude's structured output.

Key design decisions from research:
- All fields REQUIRED (no z.optional()) -- structured output has a 24 optional param limit. Use empty string as sentinel for missing data.
- Confidence is per-field, embedded in the schema as a wrapper object.
- Keep schema flat where possible to avoid compilation complexity errors.

```typescript
import { z } from 'zod'

export const ConfidenceLevel = z.enum(['high', 'medium', 'low'])
export type ConfidenceLevel = z.infer<typeof ConfidenceLevel>

// Helper: wrap a value schema with confidence
const withConfidence = <T extends z.ZodType>(valueSchema: T) =>
  z.object({
    value: valueSchema,
    confidence: ConfidenceLevel,
  })

const EducationEntry = z.object({
  institution: z.string(),
  degree: z.string(),
  field: z.string(),
  year: z.string(), // YYYY or empty string if unknown
})

const BarAdmissionEntry = z.object({
  jurisdiction: z.string(),
  year: z.string(), // YYYY or empty string
  status: z.string(), // "active", "inactive", or empty string
})

const WorkHistoryEntry = z.object({
  employer: z.string(),
  title: z.string(),
  startDate: z.string(), // YYYY or YYYY-MM or empty string
  endDate: z.string(), // YYYY or YYYY-MM or "Present" or empty string
  description: z.string(),
})

export const CvParsedDataSchema = z.object({
  name: withConfidence(z.string()),
  email: withConfidence(z.string()),
  phone: withConfidence(z.string()),
  specializations: withConfidence(z.array(z.string())),
  education: withConfidence(z.array(EducationEntry)),
  technicalBackground: withConfidence(z.array(z.string())),
  barAdmissions: withConfidence(z.array(BarAdmissionEntry)),
  workHistory: withConfidence(z.array(WorkHistoryEntry)),
})

export type CvParsedData = z.infer<typeof CvParsedDataSchema>
```

Export all schemas and types. The `CvParsedDataSchema` will be used with `zodOutputFormat()` when calling Claude API.
</details>
<files>
- src/lib/cv-parser/schema.ts (create)
</files>
</task>

<task id="02-02-T2">
<title>Task 2: Create extraction prompt and main parse function</title>
<details>
Create two files:

**File 1: `src/lib/cv-parser/prompt.ts`**

Export a `CV_EXTRACTION_PROMPT` string constant. The prompt should:
- Instruct Claude to extract structured data from an IP lawyer CV/resume
- Define the confidence levels: "high" (clearly/explicitly stated), "medium" (partially stated or inferred), "low" (uncertain/ambiguous/not found)
- List all fields to extract: name, email, phone, IP law specializations, education, technical background/domains, bar admissions, work history
- Specify that missing fields should use empty string or empty array with "low" confidence
- Specify date format preferences: YYYY or YYYY-MM where possible
- List common IP law specializations for reference: patent prosecution, patent litigation, trademark prosecution, trademark litigation, copyright, trade secrets, IP portfolio management, IP licensing, IP due diligence
- Note to look for technical backgrounds: electrical engineering, computer science/software, biotechnology, chemistry, pharmaceutical, mechanical engineering, physics, materials science

Use the prompt text from the research document as the starting point but refine it to be more specific about IP law context.

**File 2: `src/lib/cv-parser/parse.ts`**

This is the core function. It should:

1. Export `parseSingleCv(cvUploadId: string): Promise<{ success: boolean; profileId?: string; error?: string }>`

2. Implementation flow:
   a. Fetch the cvUpload record from database
   b. Validate status is 'uploaded' or 'failed' (allow retry of failed parses)
   c. Update status to 'parsing'
   d. Fetch PDF from Vercel Blob URL: `const pdfResponse = await fetch(blobUrl)` then `Buffer.from(await pdfResponse.arrayBuffer()).toString('base64')`
   e. Call Claude API:
      ```typescript
      import Anthropic from '@anthropic-ai/sdk'
      import { zodOutputFormat } from '@anthropic-ai/sdk/helpers/zod'

      const anthropic = new Anthropic() // uses ANTHROPIC_API_KEY env var

      const response = await anthropic.messages.create({
        model: 'claude-haiku-4-5-20251001',
        max_tokens: 4096,
        messages: [{
          role: 'user',
          content: [
            {
              type: 'document',
              source: {
                type: 'base64',
                media_type: 'application/pdf',
                data: pdfBase64
              }
            },
            {
              type: 'text',
              text: CV_EXTRACTION_PROMPT
            }
          ]
        }],
        output_config: {
          format: zodOutputFormat(CvParsedDataSchema)
        }
      })
      ```
   f. Parse the response: `const parsed = CvParsedDataSchema.parse(JSON.parse(response.content[0].text))`
   g. Store in database using a transaction (db.transaction):
      - Insert into profiles table (name, email, phone with their confidence levels)
      - For specializations: upsert into specializations lookup table (insert on conflict do nothing), then insert into profileSpecializations junction
      - Insert education entries
      - For technicalBackground: upsert into technicalDomains lookup table, then insert into profileTechnicalDomains junction
      - Insert barAdmissions entries
      - Insert workHistory entries
      - Update cvUpload: set status='parsed', profileId, parsedAt=new Date()
   h. Return `{ success: true, profileId }`
   i. On error: update cvUpload status to 'failed' with errorMessage (truncate error message to 500 chars), return `{ success: false, error: message }`

3. Important implementation details:
   - Use `import 'server-only'` at the top
   - Import db from `@/lib/db`
   - Import all table schemas from `@/lib/db/schema`
   - Use `eq` from 'drizzle-orm' for queries
   - For specialization/technicalDomain upserts, use Drizzle's `onConflictDoNothing()`:
     ```typescript
     await tx.insert(specializations).values({ name: spec }).onConflictDoNothing()
     const [specRow] = await tx.select().from(specializations).where(eq(specializations.name, spec))
     ```
   - Wrap the entire parse+store in try/catch. The catch block must update cvUpload status to 'failed'.
   - Add a 500ms delay between API calls consideration: export a helper `delay(ms: number)` for use by batch processing in Plan 02-03.

Do NOT use `client.messages.parse()` -- that method uses the old beta `output_format` parameter. Use `output_config.format` with `zodOutputFormat()` directly as shown above.
</details>
<files>
- src/lib/cv-parser/prompt.ts (create)
- src/lib/cv-parser/parse.ts (create)
</files>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- TypeScript compiles without errors
2. All three files exist and export the correct items:
   - schema.ts exports CvParsedDataSchema, CvParsedData type, ConfidenceLevel
   - prompt.ts exports CV_EXTRACTION_PROMPT string
   - parse.ts exports parseSingleCv function
3. parse.ts uses `output_config.format` (NOT `output_format` or `client.messages.parse()`)
4. parse.ts uses database transaction for atomic writes
5. parse.ts handles both success (status='parsed') and failure (status='failed') cases
</verification>

<success_criteria>
- Zod schema covers all 8 extraction fields with confidence scoring
- All schema fields are required (no z.optional) to avoid structured output limits
- Prompt is specific to IP lawyer CVs with domain-relevant examples
- parseSingleCv fetches PDF from blob, calls Claude API, stores in normalized tables
- Database writes use transaction for atomicity
- Error handling updates cvUpload status on failure
- Claude API call uses correct model (claude-haiku-4-5-20251001), document content block, and output_config.format
</success_criteria>

<output>
After completion, create `.planning/phases/02-cv-parsing-pipeline/02-02-SUMMARY.md`
</output>
