---
phase: 2
plan: 02-01
title: "Database Schema Extension and Package Installation"
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/db/schema.ts
autonomous: true
estimated_minutes: 15

must_haves:
  truths:
    - "New npm packages @anthropic-ai/sdk and @vercel/blob are installed and importable"
    - "Database schema contains all CV parsing tables (cvUploads, profiles, specializations, profileSpecializations, education, technicalDomains, profileTechnicalDomains, barAdmissions, workHistory)"
    - "Enums cvUploadStatusEnum and confidenceEnum exist in schema"
    - "All foreign key relationships are correctly defined with cascade deletes where appropriate"
  artifacts:
    - path: "package.json"
      provides: "New dependencies"
      contains: "@anthropic-ai/sdk"
    - path: "src/lib/db/schema.ts"
      provides: "Extended database schema with all CV parsing tables"
      contains: "cvUploads"
  key_links:
    - from: "src/lib/db/schema.ts"
      to: "users table"
      via: "cvUploads.uploadedBy foreign key"
      pattern: "references.*users\\.id"
    - from: "src/lib/db/schema.ts"
      to: "profiles table"
      via: "junction tables referencing profiles.id"
      pattern: "references.*profiles\\.id"
---

<objective>
Install the two new npm packages required for Phase 2 (@anthropic-ai/sdk for Claude API CV parsing, @vercel/blob for PDF file storage) and extend the existing Drizzle ORM database schema with all tables needed for the CV parsing pipeline.

Purpose: This is the foundation for the entire CV parsing pipeline. Every other plan in Phase 2 depends on these tables and packages existing.

Output: Updated package.json with new dependencies, extended schema.ts with 9 new tables and 2 new enums.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cv-parsing-pipeline/02-RESEARCH.md
@src/lib/db/schema.ts
@package.json
</context>

<tasks>

<task id="02-01-T1">
<title>Task 1: Install npm packages</title>
<details>
Run:
```bash
npm install @anthropic-ai/sdk @vercel/blob
```

Verify both packages appear in package.json dependencies. Do NOT pin exact versions -- use the caret range that npm installs by default.

After install, verify the packages are importable by checking that `node_modules/@anthropic-ai/sdk` and `node_modules/@vercel/blob` exist.
</details>
<files>
- package.json (modify)
- package-lock.json (modify -- auto-generated)
</files>
</task>

<task id="02-01-T2">
<title>Task 2: Extend database schema with CV parsing tables</title>
<details>
Modify `src/lib/db/schema.ts` to add all tables needed for CV parsing. Add the new tables BELOW the existing tables (users, magicLinkTokens, sessions). Do NOT modify existing tables.

Add two new enums:
```typescript
export const cvUploadStatusEnum = pgEnum('cv_upload_status', [
  'uploaded', 'parsing', 'parsed', 'failed'
])

export const confidenceEnum = pgEnum('confidence_level', [
  'high', 'medium', 'low'
])
```

Add these tables in this order (respecting foreign key references):

1. **profiles** -- Main profile table for parsed CV data
   - id: uuid, defaultRandom, primaryKey
   - name: varchar(255), notNull
   - nameConfidence: confidenceEnum, notNull
   - email: varchar(255)
   - emailConfidence: confidenceEnum, notNull
   - phone: varchar(50)
   - phoneConfidence: confidenceEnum, notNull
   - createdAt: timestamp with timezone, defaultNow, notNull
   - updatedAt: timestamp with timezone, defaultNow, notNull

2. **cvUploads** -- Tracks each uploaded PDF and its parse status
   - id: uuid, defaultRandom, primaryKey
   - filename: varchar(255), notNull
   - blobUrl: text, notNull
   - status: cvUploadStatusEnum, notNull, default 'uploaded'
   - errorMessage: text (nullable -- only set on failure)
   - uploadedBy: uuid, notNull, references users.id
   - profileId: uuid, nullable, references profiles.id (set after successful parse)
   - createdAt: timestamp with timezone, defaultNow, notNull
   - updatedAt: timestamp with timezone, defaultNow, notNull
   - parsedAt: timestamp with timezone (nullable -- set after successful parse)
   - Indexes: status, uploadedBy

3. **specializations** -- Lookup table for IP law specializations
   - id: uuid, defaultRandom, primaryKey
   - name: varchar(255), unique, notNull

4. **profileSpecializations** -- Junction table: profiles <-> specializations
   - profileId: uuid, notNull, references profiles.id with onDelete cascade
   - specializationId: uuid, notNull, references specializations.id
   - confidence: confidenceEnum, notNull
   - Indexes: profileId, specializationId

5. **education** -- Education entries per profile
   - id: uuid, defaultRandom, primaryKey
   - profileId: uuid, notNull, references profiles.id with onDelete cascade
   - institution: varchar(255), notNull
   - degree: varchar(255), notNull
   - field: varchar(255), notNull
   - year: varchar(10), nullable
   - confidence: confidenceEnum, notNull
   - Index: profileId

6. **technicalDomains** -- Lookup table for technical backgrounds
   - id: uuid, defaultRandom, primaryKey
   - name: varchar(255), unique, notNull

7. **profileTechnicalDomains** -- Junction table: profiles <-> technicalDomains
   - profileId: uuid, notNull, references profiles.id with onDelete cascade
   - technicalDomainId: uuid, notNull, references technicalDomains.id
   - confidence: confidenceEnum, notNull
   - Indexes: profileId, technicalDomainId

8. **barAdmissions** -- Bar admission records per profile
   - id: uuid, defaultRandom, primaryKey
   - profileId: uuid, notNull, references profiles.id with onDelete cascade
   - jurisdiction: varchar(255), notNull
   - year: varchar(10), nullable
   - status: varchar(100), nullable
   - confidence: confidenceEnum, notNull
   - Index: profileId

9. **workHistory** -- Work history entries per profile
   - id: uuid, defaultRandom, primaryKey
   - profileId: uuid, notNull, references profiles.id with onDelete cascade
   - employer: varchar(255), notNull
   - title: varchar(255), notNull
   - startDate: varchar(20), nullable
   - endDate: varchar(20), nullable
   - description: text, nullable
   - confidence: confidenceEnum, notNull
   - Index: profileId

Follow the exact same coding conventions as the existing tables:
- Use the same import style (pgTable, pgEnum, uuid, varchar, etc. from 'drizzle-orm/pg-core')
- Use the same index pattern: `(table) => [index('name').on(table.column)]`
- Use `text()` for long strings (like description, blobUrl, errorMessage)
- Use `varchar()` with explicit length for bounded strings
- Use `timestamp('name', { withTimezone: true })` for all timestamps

Important: Add `integer` to the imports from 'drizzle-orm/pg-core' (it's not currently imported but may be needed later). Also add `jsonb` to imports for potential future use -- actually, skip jsonb, only import what's used. Just ensure the existing imports aren't broken.
</details>
<files>
- src/lib/db/schema.ts (modify)
</files>
</task>

</tasks>

<verification>
1. `npm ls @anthropic-ai/sdk @vercel/blob` -- both packages listed without errors
2. `npx tsc --noEmit` -- TypeScript compilation succeeds with new schema
3. Schema file exports all new tables: cvUploads, profiles, specializations, profileSpecializations, education, technicalDomains, profileTechnicalDomains, barAdmissions, workHistory
4. Schema file exports both new enums: cvUploadStatusEnum, confidenceEnum
</verification>

<success_criteria>
- Both npm packages installed and listed in package.json
- All 9 new tables defined in schema.ts with correct column types, constraints, and indexes
- Both new enums defined in schema.ts
- Foreign key relationships correctly reference existing users table and new profiles table
- TypeScript compiles without errors
- Existing tables (users, magicLinkTokens, sessions) are unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/02-cv-parsing-pipeline/02-01-SUMMARY.md`
</output>
