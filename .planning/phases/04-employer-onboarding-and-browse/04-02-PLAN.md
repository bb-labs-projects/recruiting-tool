---
phase: 04-employer-onboarding-and-browse
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/(authenticated)/employer/layout.tsx
  - src/app/(authenticated)/employer/page.tsx
  - src/app/(authenticated)/employer/register/page.tsx
  - src/app/(authenticated)/employer/pending/page.tsx
  - src/app/(authenticated)/employer/rejected/page.tsx
  - src/components/employer/registration-form.tsx
  - src/components/employer/approval-banner.tsx
autonomous: true

must_haves:
  truths:
    - "New employer user sees registration form on first visit"
    - "After registration, employer sees pending approval page"
    - "Rejected employer sees rejection reason and cannot browse"
    - "Approved employer can access dashboard and browse routes"
    - "Employer layout gates access based on approval status from database"
  artifacts:
    - path: "src/app/(authenticated)/employer/layout.tsx"
      provides: "Approval-gated employer layout with status-based routing"
      min_lines: 25
    - path: "src/app/(authenticated)/employer/register/page.tsx"
      provides: "Employer registration page"
      min_lines: 10
    - path: "src/app/(authenticated)/employer/pending/page.tsx"
      provides: "Pending approval status page"
      min_lines: 10
    - path: "src/app/(authenticated)/employer/rejected/page.tsx"
      provides: "Rejection notice page with reason"
      min_lines: 10
    - path: "src/components/employer/registration-form.tsx"
      provides: "Client component form for employer registration"
      min_lines: 40
    - path: "src/components/employer/approval-banner.tsx"
      provides: "Status banner component for pending/rejected states"
      min_lines: 15
  key_links:
    - from: "src/app/(authenticated)/employer/layout.tsx"
      to: "src/lib/dal/admin-employers.ts"
      via: "getEmployerProfile to check approval status"
      pattern: "getEmployerProfile"
    - from: "src/components/employer/registration-form.tsx"
      to: "src/actions/employers.ts"
      via: "registerEmployer server action"
      pattern: "registerEmployer"
---

<objective>
Build the employer registration flow and approval-gated layout so new employers can create accounts and only approved employers can access protected features.

Purpose: This enforces the AUTH-04 requirement that employer accounts require admin approval before they can browse profiles. The layout gates access at both the layout and page level to prevent stale-status bypass.

Output: Registration form, pending/rejected status pages, and an employer layout that redirects based on approval status.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-employer-onboarding-and-browse/04-RESEARCH.md

@src/app/(authenticated)/employer/layout.tsx
@src/app/(authenticated)/employer/page.tsx
@src/app/(authenticated)/layout.tsx
@src/lib/dal.ts
@src/components/auth/magic-link-form.tsx

Prior plan summary (for schema/DAL context):
@.planning/phases/04-employer-onboarding-and-browse/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Employer layout with approval gating and status pages</name>
  <files>
    src/app/(authenticated)/employer/layout.tsx
    src/app/(authenticated)/employer/page.tsx
    src/app/(authenticated)/employer/register/page.tsx
    src/app/(authenticated)/employer/pending/page.tsx
    src/app/(authenticated)/employer/rejected/page.tsx
  </files>
  <action>
    1. UPDATE `src/app/(authenticated)/employer/layout.tsx`:
       - Import `getUser` from '@/lib/dal' and `getEmployerProfile` from '@/lib/dal/admin-employers'
       - Import `redirect` from 'next/navigation'
       - In the async server component:
         - Call `getUser()` -- if not user or role !== 'employer', redirect to '/login'
         - Call `getEmployerProfile(user.id)` to get employer approval status
         - Determine current pathname context (use headers or pass as prop -- since layouts cannot read searchParams, use a simpler approach):
           - If NO employer profile exists AND the current page is not the register page, redirect to '/employer/register'
           - If status === 'pending' AND current page is not pending page, redirect to '/employer/pending'
           - If status === 'rejected' AND current page is not rejected page, redirect to '/employer/rejected'
         - IMPORTANT: Layouts in Next.js do not re-render on client-side navigation. The gating logic here is a FIRST check. Pages must also check status themselves for security (per research pitfall 3).
         - APPROACH: Instead of trying to read pathname in the layout (which is unreliable), pass the employer profile as a prop-like pattern using React context or simply rely on page-level checks. The simplest pattern: the layout does NOT redirect but passes employerProfile to children. Each page checks its own access. OR use the simpler approach: only gate browse/dashboard pages, let register/pending/rejected pages be always accessible.
         - RECOMMENDED APPROACH: The layout should:
           a) Fetch employer profile
           b) Allow register/pending/rejected pages to always render (they handle their own logic)
           c) For the main dashboard and browse routes, the PAGE components check approval status
         - Keep the layout as a simple shell with padding. The status gating happens at page level.
       - Render children with a simple wrapper div (same as current but with navbar if desired)

    2. UPDATE `src/app/(authenticated)/employer/page.tsx` (dashboard):
       - Import `getUser` from '@/lib/dal', `getEmployerProfile` from '@/lib/dal/admin-employers', `redirect` from 'next/navigation'
       - Check: if no employerProfile, redirect to '/employer/register'
       - Check: if status === 'pending', redirect to '/employer/pending'
       - Check: if status === 'rejected', redirect to '/employer/rejected'
       - If approved: show the employer dashboard with:
         - Welcome message with company name
         - Card grid with: "Browse Candidates" (link to /employer/browse), "Saved Profiles" (coming soon placeholder), "My Jobs" (coming soon placeholder)
         - Use existing Card/CardHeader/CardContent/CardTitle/CardDescription components

    3. Create `src/app/(authenticated)/employer/register/page.tsx` (NEW):
       - Server component that imports `getUser` from dal and `getEmployerProfile`
       - If employer profile already exists, redirect to '/employer' (prevents re-registration)
       - Renders a centered card with:
         - Title: "Complete Your Registration"
         - Description: "Tell us about your company to get started"
         - The `RegistrationForm` client component (created in Task 2)

    4. Create `src/app/(authenticated)/employer/pending/page.tsx` (NEW):
       - Server component that imports `getUser` and `getEmployerProfile`
       - If no profile, redirect to '/employer/register'
       - If status !== 'pending', redirect to '/employer' (approved or rejected)
       - Render a centered card with:
         - Clock/hourglass icon (from lucide-react)
         - Title: "Account Pending Approval"
         - Company name displayed
         - Message: "Your account is being reviewed by our team. You'll be able to browse candidate profiles once approved."
         - "We'll notify you by email when your account is reviewed." (informational text)

    5. Create `src/app/(authenticated)/employer/rejected/page.tsx` (NEW):
       - Server component that imports `getUser` and `getEmployerProfile`
       - If no profile, redirect to '/employer/register'
       - If status !== 'rejected', redirect to '/employer'
       - Render a centered card with:
         - XCircle icon (from lucide-react)
         - Title: "Account Not Approved"
         - If rejectionReason exists, display it in a muted box
         - Message: "If you believe this was a mistake, please contact us."
         - A link or button to contact support (mailto link to a placeholder email)
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm all page components compile. Verify that redirect logic prevents circular redirects (register checks for existing profile, pending checks for non-pending status, etc.).
  </verify>
  <done>
    - Employer dashboard redirects to register/pending/rejected based on profile status
    - Register page only accessible when no employer profile exists
    - Pending page shows approval status with company name
    - Rejected page shows rejection reason
    - No circular redirect loops between pages
  </done>
</task>

<task type="auto">
  <name>Task 2: Registration form and approval banner components</name>
  <files>
    src/components/employer/registration-form.tsx
    src/components/employer/approval-banner.tsx
  </files>
  <action>
    1. Create `src/components/employer/registration-form.tsx` (NEW):
       - 'use client' directive
       - Import useActionState from 'react', registerEmployer from '@/actions/employers'
       - Import Card, CardContent, CardHeader, CardTitle, CardDescription from ui/card
       - Import Input from ui/input, Label from ui/label, Button from ui/button
       - Create `RegistrationForm` component:
         - useActionState with registerEmployer action (follow the same pattern as MagicLinkForm in src/components/auth/magic-link-form.tsx)
         - Form fields:
           - Company Name (required, Input)
           - Company Website (optional, Input type="url")
           - Contact Name (required, Input)
           - Contact Title (optional, Input)
           - Phone (optional, Input type="tel")
         - Submit button: "Submit for Approval"
         - Show error message if state.error exists (red text)
         - On success (state.success), use `useEffect` + `useRouter` to redirect to '/employer/pending'
         - Disable button while pending (useActionState provides isPending)
       - IMPORTANT: The registerEmployer action accepts FormData, so use a regular `<form action={formAction}>` pattern with named inputs. Follow the established pattern from magic-link-form.tsx.

    2. Create `src/components/employer/approval-banner.tsx` (NEW):
       - Server component (no 'use client')
       - Import Badge from ui/badge
       - Import Clock, XCircle, CheckCircle from lucide-react
       - Export `ApprovalBanner({ status, companyName }: { status: 'pending' | 'approved' | 'rejected'; companyName: string })`:
         - If pending: yellow/amber banner with Clock icon, "Account pending approval" text
         - If approved: green banner with CheckCircle icon, "Account approved" text
         - If rejected: red banner with XCircle icon, "Account not approved" text
         - Shows company name in the banner
       - This component can be used in the employer layout or individual pages for visual status indication
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm components compile. Verify that RegistrationForm follows the same useActionState pattern as existing MagicLinkForm.
  </verify>
  <done>
    - RegistrationForm collects company info and calls registerEmployer server action
    - Form validates required fields client-side (HTML required attribute) and server-side (Zod in action)
    - On success, redirects to pending page
    - ApprovalBanner renders status-appropriate banner with icon and color
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. New employer (no profile row) visiting /employer is redirected to /employer/register
3. After registration, employer is redirected to /employer/pending
4. Pending employer cannot access /employer dashboard (redirected to /employer/pending)
5. Rejected employer sees rejection reason on /employer/rejected
6. Approved employer can access /employer dashboard normally
7. No circular redirect loops exist between any status pages
</verification>

<success_criteria>
- AUTH-04 requirement satisfied: employer accounts require admin approval before browsing
- Registration form collects company name, website, contact name, title, phone
- Status pages show appropriate messaging for pending and rejected states
- Page-level status checks prevent stale layout caching bypass
- Components follow established project patterns (useActionState, server actions, shadcn/ui)
</success_criteria>

<output>
After completion, create `.planning/phases/04-employer-onboarding-and-browse/04-02-SUMMARY.md`
</output>
