---
phase: 04-employer-onboarding-and-browse
plan: 05
type: execute
wave: 4
depends_on: ["04-02", "04-03", "04-04"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Full employer registration -> approval -> browse flow works end-to-end"
    - "Anonymization verified: no PII in employer-facing responses"
    - "Admin approve/reject flow updates employer access correctly"
    - "TypeScript compiles with zero errors"
    - "Application starts without runtime errors"
  artifacts: []
  key_links: []
---

<objective>
Verify the complete Phase 4 implementation: employer registration, admin approval, anonymized browsing, and the security of the anonymization layer.

Purpose: End-to-end verification ensures all three requirements (AUTH-04, MARK-01, ADMN-02) are satisfied and that the anonymization -- the most critical business requirement -- is enforced correctly.

Output: Verified phase or identified gaps for closure.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Prior plan summaries:
@.planning/phases/04-employer-onboarding-and-browse/04-01-SUMMARY.md
@.planning/phases/04-employer-onboarding-and-browse/04-02-SUMMARY.md
@.planning/phases/04-employer-onboarding-and-browse/04-03-SUMMARY.md
@.planning/phases/04-employer-onboarding-and-browse/04-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build verification and schema push reminder</name>
  <files></files>
  <action>
    1. Run `npx tsc --noEmit` and verify ZERO errors
    2. Run `npm run build` (or `npx next build`) and verify the build completes successfully
    3. Check that all new files exist:
       - src/lib/db/schema.ts (updated with employerProfiles)
       - src/lib/db/relations.ts (updated with employerProfilesRelations)
       - src/lib/anonymize.ts
       - src/lib/dal/employer-profiles.ts
       - src/lib/dal/admin-employers.ts
       - src/actions/employers.ts
       - src/app/(authenticated)/employer/layout.tsx (updated)
       - src/app/(authenticated)/employer/page.tsx (updated)
       - src/app/(authenticated)/employer/register/page.tsx
       - src/app/(authenticated)/employer/pending/page.tsx
       - src/app/(authenticated)/employer/rejected/page.tsx
       - src/app/(authenticated)/employer/browse/page.tsx
       - src/app/(authenticated)/employer/browse/search.tsx
       - src/app/(authenticated)/employer/browse/filters.tsx
       - src/app/(authenticated)/employer/browse/[id]/page.tsx
       - src/app/admin/employers/page.tsx
       - src/app/admin/employers/columns.tsx
       - src/app/admin/employers/data-table.tsx
       - src/app/admin/employers/[id]/page.tsx
       - src/components/employer/registration-form.tsx
       - src/components/employer/profile-card.tsx
       - src/components/employer/unlock-button.tsx
       - src/components/employer/approval-banner.tsx
       - src/components/admin/employer-actions.tsx
    4. Verify AnonymizedProfileDTO type does NOT contain name, email, phone, or employer fields by inspecting the type definition in employer-profiles.ts
    5. Verify getAnonymizedProfiles query uses column whitelisting (not blacklisting) for the profiles table -- meaning it explicitly lists which columns to include, not which to exclude
    6. Verify that browse page and profile detail page both check employer approval status at the page level (not just layout)
    7. Remind user: "Run `npx drizzle-kit push` to apply the new employerProfiles table to the database before testing"
  </action>
  <verify>
    `npx tsc --noEmit` exits with code 0. `npm run build` exits with code 0 (or `next build` succeeds).
  </verify>
  <done>
    - TypeScript compilation passes with zero errors
    - Next.js build succeeds
    - All expected files exist
    - Anonymization verified at type and query level
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete employer onboarding and anonymized browse flow:
    1. Database schema with employerProfiles table and approval status
    2. Employer registration form and approval-gated access
    3. Admin employer management (list, detail, approve/reject)
    4. Anonymized candidate browse with search, filters, and profile detail
    5. Server-side anonymization enforced at the DAL level
  </what-built>
  <how-to-verify>
    Prerequisites:
    - Run `npx drizzle-kit push` to apply schema changes
    - Start dev server: `npm run dev`

    Test 1 - Employer Registration (AUTH-04):
    1. Create an employer user in the database (or use magic link login with a new email, then update their role to 'employer' in the DB: `UPDATE users SET role = 'employer' WHERE email = 'test-employer@example.com'`)
    2. Log in as the employer
    3. Verify redirect to /employer/register (no employer profile yet)
    4. Fill in company name, contact name, etc. and submit
    5. Verify redirect to /employer/pending
    6. Verify cannot access /employer or /employer/browse (redirected to /employer/pending)

    Test 2 - Admin Employer Management (ADMN-02):
    1. Log in as admin
    2. Navigate to /admin/employers
    3. Verify the pending employer appears in the table with yellow "pending" badge
    4. Click the employer name to see detail page
    5. Verify company info is displayed
    6. Click "Approve Employer"
    7. Verify status changes to "approved" (green badge)
    8. Go back to employer list -- verify status updated there too

    Test 3 - Approved Employer Browse (MARK-01):
    1. Log in as the now-approved employer
    2. Verify redirect to /employer dashboard (no longer pending)
    3. Navigate to /employer/browse
    4. Verify anonymized profile cards appear (if active profiles exist in DB)
    5. Verify cards show: specializations, experience range, bar admissions, education summary
    6. Verify cards do NOT show: candidate name, email, phone, employer names
    7. Try the search input -- type a specialization name
    8. Try the filter dropdowns

    Test 4 - Anonymization Verification (CRITICAL):
    1. On the browse page, open browser DevTools -> Network tab
    2. Reload the page
    3. Inspect the HTML response (or RSC payload) for any candidate names, emails, or phone numbers
    4. Verify ZERO PII appears in the response payload
    5. Navigate to a single profile detail page (/employer/browse/[id])
    6. Verify the detail page shows anonymized data only
    7. Check for "Unlock Full Profile" button

    Test 5 - Rejection Flow:
    1. As admin, reject the test employer (provide a reason)
    2. Log in as the rejected employer
    3. Verify redirect to /employer/rejected with the rejection reason displayed
    4. Verify cannot access /employer/browse

    Expected: All 5 tests pass. The anonymization test (Test 4) is the most critical.
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 4 is complete when:
1. TypeScript compiles with zero errors
2. Next.js build succeeds
3. All 5 manual test scenarios pass
4. Anonymization verified via network inspection (no PII in response)
</verification>

<success_criteria>
- AUTH-04: Employer accounts require admin approval before browsing -- VERIFIED
- MARK-01: Employers browse anonymized profiles, server-side enforced -- VERIFIED
- ADMN-02: Admin can approve, manage employer accounts -- VERIFIED
- Anonymization: No PII in any employer-facing API response or HTML payload -- VERIFIED
</success_criteria>

<output>
After completion, create `.planning/phases/04-employer-onboarding-and-browse/04-05-SUMMARY.md`
</output>
