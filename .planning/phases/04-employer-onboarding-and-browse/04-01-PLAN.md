---
phase: 04-employer-onboarding-and-browse
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/schema.ts
  - src/lib/db/relations.ts
  - src/lib/anonymize.ts
  - src/lib/dal/employer-profiles.ts
  - src/lib/dal/admin-employers.ts
  - src/actions/employers.ts
autonomous: true

must_haves:
  truths:
    - "employerProfiles table exists with status enum (pending/approved/rejected)"
    - "Anonymized profile query NEVER selects name, email, phone, or employer fields"
    - "Experience range bucketing converts exact dates to ranges"
    - "Admin can query all employer profiles with user email join"
    - "Server actions exist for employer registration, admin approve, admin reject"
  artifacts:
    - path: "src/lib/db/schema.ts"
      provides: "employerStatusEnum and employerProfiles table"
      contains: "employerProfiles"
    - path: "src/lib/db/relations.ts"
      provides: "employerProfiles <-> users relations"
      contains: "employerProfilesRelations"
    - path: "src/lib/anonymize.ts"
      provides: "bucketExperienceYears, anonymizeWorkHistory pure functions"
      exports: ["bucketExperienceYears", "anonymizeWorkHistory"]
    - path: "src/lib/dal/employer-profiles.ts"
      provides: "getAnonymizedProfiles, getAnonymizedProfileById DAL functions"
      exports: ["getAnonymizedProfiles", "getAnonymizedProfileById", "AnonymizedProfileDTO"]
    - path: "src/lib/dal/admin-employers.ts"
      provides: "getEmployerProfile, getAllEmployerProfiles DAL functions"
      exports: ["getEmployerProfile", "getAllEmployerProfiles"]
    - path: "src/actions/employers.ts"
      provides: "registerEmployer, approveEmployer, rejectEmployer server actions"
      exports: ["registerEmployer", "approveEmployer", "rejectEmployer"]
  key_links:
    - from: "src/lib/dal/employer-profiles.ts"
      to: "src/lib/anonymize.ts"
      via: "import bucketExperienceYears, anonymizeWorkHistory"
      pattern: "import.*from.*anonymize"
    - from: "src/lib/dal/employer-profiles.ts"
      to: "src/lib/db/schema.ts"
      via: "Drizzle relational query with column exclusion"
      pattern: "db\\.query\\.profiles\\.findMany"
    - from: "src/actions/employers.ts"
      to: "src/lib/db/schema.ts"
      via: "db.insert/update on employerProfiles"
      pattern: "employerProfiles"
---

<objective>
Create the database schema extension, anonymization utilities, Data Access Layer functions, and server actions for Phase 4 (Employer Onboarding and Browse).

Purpose: This is the data foundation for ALL employer-facing features. The anonymized DAL ensures PII is never selected from the database for employer views. The schema extension adds employer account management. Server actions handle registration and admin approval workflows.

Output: Schema with employerProfiles table, anonymization pure functions, two DAL modules (employer-profiles for anonymized browsing, admin-employers for management), and server actions for registration/approval.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-employer-onboarding-and-browse/04-RESEARCH.md

@src/lib/db/schema.ts
@src/lib/db/relations.ts
@src/lib/dal.ts
@src/actions/profiles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema extension, relations, and anonymization utilities</name>
  <files>
    src/lib/db/schema.ts
    src/lib/db/relations.ts
    src/lib/anonymize.ts
  </files>
  <action>
    1. In `src/lib/db/schema.ts`, add AFTER the existing exports:
       - `employerStatusEnum` pgEnum with values: 'pending', 'approved', 'rejected'
       - `employerProfiles` pgTable with columns:
         - id: uuid defaultRandom primaryKey
         - userId: uuid notNull references users.id onDelete cascade, unique
         - companyName: varchar(255) notNull
         - companyWebsite: varchar(500) nullable
         - contactName: varchar(255) notNull
         - contactTitle: varchar(255) nullable
         - phone: varchar(50) nullable
         - status: employerStatusEnum notNull default 'pending'
         - rejectionReason: text nullable
         - reviewedAt: timestamp withTimezone nullable
         - reviewedBy: uuid references users.id nullable
         - createdAt: timestamp withTimezone defaultNow notNull
         - updatedAt: timestamp withTimezone defaultNow notNull
       - Indexes: employer_profiles_user_idx on userId, employer_profiles_status_idx on status

    2. In `src/lib/db/relations.ts`:
       - Import `employerProfiles` and `users` from schema
       - Add `employerProfilesRelations` using `relations(employerProfiles, ({ one }) => ...)` with:
         - `user`: one(users) via userId -> users.id
         - `reviewer`: one(users) via reviewedBy -> users.id, with relationName 'employerReviewer'
       - Add `usersRelations` using `relations(users, ({ one }) => ...)` with:
         - `employerProfile`: one(employerProfiles) via users.id -> employerProfiles.userId
       - IMPORTANT: Be careful with the existing relations in this file. The profilesRelations and other existing relations must stay untouched. Only ADD new relation definitions.

    3. Create `src/lib/anonymize.ts` (NEW file):
       - Add `import 'server-only'` at the top
       - Export `bucketExperienceYears(workHistory: { startDate: string | null; endDate: string | null }[]): string`
         - Calculates total months from all work history entries
         - Returns bucketed ranges: "< 2 years", "2-5 years", "5-10 years", "10-15 years", "15-20 years", "20+ years"
         - Handles null startDate (skip entry) and null endDate (use current date)
       - Export `anonymizeWorkHistory(workHistory: { title: string; startDate: string | null; endDate: string | null }[]): { title: string; type: string; durationRange: string }[]`
         - Suppresses employer name (not in input type)
         - Infers employer type from title using `inferEmployerType` helper
         - Buckets individual duration using `bucketDuration` helper
       - Private helper `inferEmployerType(title: string): string` - returns "Law Firm", "In-House", "Government", or "Legal" based on title keywords
       - Private helper `bucketDuration(startDate, endDate): string` - returns "< 1 year", "1-3 years", "3-5 years", "5-10 years", "10+ years", or "Unknown"
       - See research document Pattern 2 for exact implementation reference
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm schema extension compiles without errors. Verify that `src/lib/anonymize.ts` exports are recognized by checking no TypeScript errors.
  </verify>
  <done>
    - employerProfiles table defined in schema.ts with all columns, indexes, and foreign keys
    - employerProfilesRelations and usersRelations added to relations.ts
    - anonymize.ts exports bucketExperienceYears and anonymizeWorkHistory as pure functions with server-only guard
  </done>
</task>

<task type="auto">
  <name>Task 2: DAL modules and server actions</name>
  <files>
    src/lib/dal/employer-profiles.ts
    src/lib/dal/admin-employers.ts
    src/actions/employers.ts
  </files>
  <action>
    1. Create directory `src/lib/dal/` if it does not exist.

    2. Create `src/lib/dal/employer-profiles.ts` (NEW file):
       - Add `import 'server-only'` at the top
       - Import `cache` from 'react', `db` from '@/lib/db', `eq`, `or`, `ilike`, `sql`, `count` from 'drizzle-orm'
       - Import `bucketExperienceYears`, `anonymizeWorkHistory` from '@/lib/anonymize'
       - Define and export `AnonymizedProfileDTO` type:
         ```
         { id: string, specializations: string[], technicalDomains: string[], experienceRange: string, educationSummary: string[], barAdmissions: string[], workHistorySummary: { title: string, type: string, durationRange: string }[] }
         ```
       - Export `getAnonymizedProfiles = cache(async (filters?: { specialization?: string, experienceRange?: string, search?: string, page?: number, pageSize?: number }) => { ... })`
         - Use `db.query.profiles.findMany` with:
           - `where`: status = 'active' (only approved profiles visible to employers)
           - `columns`: whitelist ONLY `id` and `createdAt` (NO name, email, phone, or confidence fields)
           - `with`: nested relations using explicit column whitelists:
             - profileSpecializations -> specialization (name only)
             - profileTechnicalDomains -> technicalDomain (name only)
             - education (institution, degree, field, year -- NO profileId)
             - barAdmissions (jurisdiction, status, year -- NO profileId)
             - workHistory (title, startDate, endDate -- NO employer, NO description)
           - `limit`: pageSize (default 12)
           - `offset`: (page - 1) * pageSize
           - `orderBy`: desc(profiles.createdAt)
         - CRITICAL: If the `columns` option in nested `with` clauses does not work in Drizzle 0.45.1, fall back to selecting all columns and stripping in the DTO transform. The DTO must NEVER include PII.
         - Transform results into `AnonymizedProfileDTO[]` using anonymize utils
         - Return `{ profiles: AnonymizedProfileDTO[], total: number }` -- use a separate count query for total

       - Export `getAnonymizedProfileById = cache(async (id: string) => { ... })`
         - Same column exclusion pattern as above but `findFirst` with `where: eq(profiles.id, id)` AND `status = 'active'`
         - Returns `AnonymizedProfileDTO | null`

    3. Create `src/lib/dal/admin-employers.ts` (NEW file):
       - Add `import 'server-only'` at the top
       - Import `cache` from 'react', `db` from '@/lib/db', `employerProfiles`, `users` from schema, `eq` from 'drizzle-orm'
       - Export `getEmployerProfile = cache(async (userId: string) => { ... })`
         - Select full row from employerProfiles where userId matches
         - Return profile or null
       - Export `getAllEmployerProfiles = cache(async () => { ... })`
         - Select id, companyName, contactName, contactTitle, status, createdAt, reviewedAt, userEmail (from joined users table)
         - innerJoin users on employerProfiles.userId = users.id
         - orderBy createdAt desc
         - Return array

    4. Create `src/actions/employers.ts` (NEW file):
       - Add `'use server'` directive
       - Import revalidatePath, db, employerProfiles schema, eq from drizzle, z from zod, getUser from dal

       - Helper: `async function requireAdmin()` -- same pattern as in `src/actions/profiles.ts`

       - `registerEmployer(formData: FormData)`:
         - Validate with RegisterEmployerSchema: companyName (min 1, max 255), companyWebsite (url or empty string, optional), contactName (min 1, max 255), contactTitle (max 255, optional), phone (max 50, optional)
         - Get user via getUser(), verify role is 'employer'
         - Check if employer profile already exists (prevent duplicates)
         - Insert into employerProfiles with status 'pending'
         - revalidatePath('/employer')
         - Return { success: true } or { error: string }

       - `approveEmployer(formData: FormData)`:
         - requireAdmin()
         - Validate employerProfileId as UUID
         - Update status to 'approved', set reviewedAt and reviewedBy
         - revalidatePath('/admin/employers')
         - Return { success: true } or { error: string }

       - `rejectEmployer(formData: FormData)`:
         - requireAdmin()
         - Validate employerProfileId as UUID and rejectionReason as non-empty string
         - Update status to 'rejected', set rejectionReason, reviewedAt, reviewedBy
         - revalidatePath('/admin/employers')
         - Return { success: true } or { error: string }

       - Follow the EXACT same error handling pattern as `src/actions/profiles.ts` (try/catch with Unauthorized check)
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm all new files compile without errors. Verify that imports between files resolve correctly (anonymize -> DAL, schema -> actions).
  </verify>
  <done>
    - employer-profiles.ts returns AnonymizedProfileDTO that NEVER contains name/email/phone/employer fields
    - admin-employers.ts returns full employer profile data for admin views
    - employers.ts server actions handle registration, approval, and rejection with proper auth guards
    - All three files use 'server-only' or 'use server' guards appropriately
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Schema has employerProfiles table with all required columns
3. AnonymizedProfileDTO type does NOT have name, email, phone, or employer fields
4. Server actions follow established patterns from profiles.ts (requireAdmin, Zod validation, try/catch)
5. DAL functions use 'server-only' import guard
6. Anonymization pure functions handle edge cases (null dates, empty arrays)
</verification>

<success_criteria>
- employerProfiles table schema compiles and matches the research spec
- Drizzle relations are correctly defined for employerProfiles <-> users
- AnonymizedProfileDTO type contains ONLY safe fields (id, specializations, technicalDomains, experienceRange, educationSummary, barAdmissions, workHistorySummary)
- bucketExperienceYears returns range strings, not exact years
- registerEmployer, approveEmployer, rejectEmployer server actions are fully implemented with validation
- getAnonymizedProfiles and getAnonymizedProfileById DAL functions use column whitelisting to prevent PII leakage
</success_criteria>

<output>
After completion, create `.planning/phases/04-employer-onboarding-and-browse/04-01-SUMMARY.md`
</output>
