---
phase: 04-employer-onboarding-and-browse
plan: 04
type: execute
wave: 3
depends_on: ["04-01", "04-02"]
files_modified:
  - src/app/(authenticated)/employer/browse/page.tsx
  - src/app/(authenticated)/employer/browse/search.tsx
  - src/app/(authenticated)/employer/browse/filters.tsx
  - src/app/(authenticated)/employer/browse/[id]/page.tsx
  - src/components/employer/profile-card.tsx
  - src/components/employer/unlock-button.tsx
autonomous: true
user_setup:
  - service: use-debounce
    why: "Search input debouncing for browse page"
    env_vars: []
    dashboard_config: []

must_haves:
  truths:
    - "Approved employer can browse anonymized candidate profile cards"
    - "Profile cards show specializations, experience range, bar admissions, education -- never name, email, phone"
    - "Employer can search by specialization or jurisdiction text"
    - "Employer can filter by specialization and experience range"
    - "Single profile detail page shows full anonymized details with Unlock Profile CTA"
    - "Unapproved employer is redirected away from browse pages"
  artifacts:
    - path: "src/app/(authenticated)/employer/browse/page.tsx"
      provides: "Server component browse page with search params"
      min_lines: 30
    - path: "src/app/(authenticated)/employer/browse/search.tsx"
      provides: "Client component search input with debounce"
      min_lines: 20
    - path: "src/app/(authenticated)/employer/browse/filters.tsx"
      provides: "Client component filter dropdowns"
      min_lines: 20
    - path: "src/app/(authenticated)/employer/browse/[id]/page.tsx"
      provides: "Single anonymized profile detail page"
      min_lines: 40
    - path: "src/components/employer/profile-card.tsx"
      provides: "Anonymized candidate profile card component"
      min_lines: 30
    - path: "src/components/employer/unlock-button.tsx"
      provides: "Unlock Profile CTA button (placeholder for Phase 6)"
      min_lines: 10
  key_links:
    - from: "src/app/(authenticated)/employer/browse/page.tsx"
      to: "src/lib/dal/employer-profiles.ts"
      via: "getAnonymizedProfiles DAL function"
      pattern: "getAnonymizedProfiles"
    - from: "src/app/(authenticated)/employer/browse/page.tsx"
      to: "src/lib/dal/admin-employers.ts"
      via: "getEmployerProfile for approval gate"
      pattern: "getEmployerProfile"
    - from: "src/app/(authenticated)/employer/browse/[id]/page.tsx"
      to: "src/lib/dal/employer-profiles.ts"
      via: "getAnonymizedProfileById for single profile"
      pattern: "getAnonymizedProfileById"
    - from: "src/components/employer/profile-card.tsx"
      to: "src/lib/dal/employer-profiles.ts"
      via: "AnonymizedProfileDTO type import"
      pattern: "AnonymizedProfileDTO"
---

<objective>
Build the employer browse experience: anonymized profile card grid with search, filters, pagination, and a single profile detail view with "Unlock Profile" CTA.

Purpose: This satisfies MARK-01: "Employers can browse anonymized candidate profiles (no name/contact details) -- enforced server-side." This is the revenue funnel entry point -- employers see enough to evaluate candidates but must pay to unlock full details.

Output: Browse page with card grid, search input with debounce, filter dropdowns, pagination, single profile detail page, and an Unlock Profile button placeholder for Phase 6.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-employer-onboarding-and-browse/04-RESEARCH.md

@src/lib/dal/employer-profiles.ts (from 04-01)
@src/lib/dal/admin-employers.ts (from 04-01)
@src/lib/dal.ts
@src/components/ui/card.tsx
@src/components/ui/badge.tsx
@src/components/ui/input.tsx
@src/components/ui/select.tsx
@src/components/ui/button.tsx

Prior plan summaries (for DAL and registration context):
@.planning/phases/04-employer-onboarding-and-browse/04-01-SUMMARY.md
@.planning/phases/04-employer-onboarding-and-browse/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install packages and create browse page with search, filters, and profile cards</name>
  <files>
    src/app/(authenticated)/employer/browse/page.tsx
    src/app/(authenticated)/employer/browse/search.tsx
    src/app/(authenticated)/employer/browse/filters.tsx
    src/components/employer/profile-card.tsx
    src/components/employer/unlock-button.tsx
  </files>
  <action>
    FIRST: Install required packages:
    ```bash
    npm install use-debounce
    npx shadcn@latest add skeleton
    ```

    1. Create `src/components/employer/unlock-button.tsx` (NEW):
       - Simple server component (no 'use client')
       - Import Button from ui/button, Lock icon from lucide-react
       - Export `UnlockButton({ profileId }: { profileId: string })`:
         - Renders a Button variant="default" with Lock icon and text "Unlock Full Profile"
         - For now, this is a non-functional placeholder. In Phase 6, it will trigger Stripe Checkout.
         - Add a `disabled` prop or tooltip saying "Payment integration coming soon" -- OR simply link to a placeholder. Best: just render the button as-is with an onClick that shows an alert or does nothing. Keep it simple.
         - Actually, the simplest approach: just render the styled button. Phase 6 will wire it up.

    2. Create `src/components/employer/profile-card.tsx` (NEW):
       - Import Card, CardContent, CardHeader, CardTitle from ui/card
       - Import Badge from ui/badge
       - Import Button from ui/button
       - Import Lock from lucide-react
       - Import Link from 'next/link'
       - Import type `AnonymizedProfileDTO` from '@/lib/dal/employer-profiles'
       - Export `ProfileCard({ profile }: { profile: AnonymizedProfileDTO })`:
         - Card layout showing:
           - Header: "IP Professional" as title (no name!), experience range as subtitle text-muted-foreground
           - Specializations: flex-wrap row of Badge variant="secondary" for each specialization
           - Technical domains: if any, show as smaller badges or comma-separated text
           - Bar admissions: "Licensed: California (Active), USPTO (Active)" as text
           - Education: first entry as text, "+N more" if multiple
           - Work history summary: list of "{title} - {type} ({durationRange})" -- NO employer names
           - Footer: Link to `/employer/browse/${profile.id}` as "View Profile" button with Lock icon
         - Card should use `flex flex-col` so the footer button is pushed to the bottom
         - Follow the exact component structure from research Pattern 5 (profile card code example)

    3. Create `src/app/(authenticated)/employer/browse/search.tsx` (NEW):
       - 'use client' directive
       - Import useSearchParams, usePathname, useRouter from 'next/navigation'
       - Import useDebouncedCallback from 'use-debounce'
       - Import Input from ui/input, Search icon from lucide-react
       - Export `SearchInput()`:
         - Read current 'q' param from searchParams
         - useDebouncedCallback with 300ms delay that:
           - Creates new URLSearchParams from current searchParams
           - Sets 'page' to '1' (reset pagination on new search)
           - Sets or deletes 'q' param based on input value
           - Calls router.replace(`${pathname}?${params.toString()}`)
         - Render Input with Search icon positioned absolute left
         - defaultValue from searchParams 'q'
         - className="pl-10" to make room for icon
         - Placeholder: "Search specializations, jurisdictions..."
       - Follow the exact pattern from research code example

    4. Create `src/app/(authenticated)/employer/browse/filters.tsx` (NEW):
       - 'use client' directive
       - Import useSearchParams, usePathname, useRouter from 'next/navigation'
       - Import Select, SelectContent, SelectItem, SelectTrigger, SelectValue from ui/select
       - Export `FilterBar()`:
         - Specialization filter (Select):
           - Options: "All Specializations", "Patent Prosecution", "Trademark", "Copyright", "Trade Secrets", "IP Litigation", "Licensing"
           - On value change: update URL param 'specialization', reset 'page' to '1'
           - Default: from searchParams 'specialization' or 'all'
         - Experience range filter (Select):
           - Options: "All Experience", "< 2 years", "2-5 years", "5-10 years", "10-15 years", "15-20 years", "20+ years"
           - On value change: update URL param 'experience', reset 'page' to '1'
           - Default: from searchParams 'experience' or 'all'
         - Both filters update URL params and let the server component re-fetch

    5. Create `src/app/(authenticated)/employer/browse/page.tsx` (NEW):
       - Server component (async)
       - Import getUser from '@/lib/dal', getEmployerProfile from '@/lib/dal/admin-employers'
       - Import getAnonymizedProfiles from '@/lib/dal/employer-profiles'
       - Import redirect from 'next/navigation', Suspense from 'react'
       - Import SearchInput from './search', FilterBar from './filters', ProfileCard, Skeleton
       - **APPROVAL GATE (page-level, critical for security):**
         - const user = await getUser()
         - const employerProfile = await getEmployerProfile(user.id)
         - if (!employerProfile || employerProfile.status !== 'approved') redirect('/employer')
       - Read searchParams (Next.js 16: `searchParams: Promise<{ q?: string, specialization?: string, experience?: string, page?: string }>` -- must await)
       - const params = await searchParams
       - Call getAnonymizedProfiles with filters from URL params
       - Render:
         - Header: "Browse Candidates" title, "Discover qualified IP professionals" subtitle
         - Search + filter bar (flex row with gap)
         - Results count: "{total} candidates found"
         - Card grid: `grid gap-4 sm:grid-cols-2 lg:grid-cols-3`
         - Map profiles to ProfileCard components
         - Empty state: if no profiles, show helpful message ("No candidates match your criteria. Try broadening your filters.")
         - Pagination: simple prev/next with page numbers
           - "Previous" button disabled if page <= 1
           - "Next" button disabled if no more results
           - Both buttons link to same page with updated 'page' param
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm all browse files compile. Verify that `use-debounce` is installed in package.json. Verify that the browse page imports getAnonymizedProfiles (not a full profile query).
  </verify>
  <done>
    - Browse page renders anonymized profile cards in a responsive grid
    - Search input debounces at 300ms and updates URL params
    - Filter dropdowns for specialization and experience range update URL params
    - Profile cards show ONLY: specializations, experience range, bar admissions, education summary, work history summary (no names, emails, phones, employer names)
    - Empty state and pagination both work correctly
    - Unapproved employer is redirected away from browse page
  </done>
</task>

<task type="auto">
  <name>Task 2: Single anonymized profile detail page</name>
  <files>
    src/app/(authenticated)/employer/browse/[id]/page.tsx
  </files>
  <action>
    1. Create `src/app/(authenticated)/employer/browse/[id]/page.tsx` (NEW):
       - Server component (async)
       - Import getUser from '@/lib/dal', getEmployerProfile from '@/lib/dal/admin-employers'
       - Import getAnonymizedProfileById from '@/lib/dal/employer-profiles'
       - Import redirect from 'next/navigation', notFound from 'next/navigation'
       - Import Card, CardContent, CardHeader, CardTitle from ui/card
       - Import Badge from ui/badge, Separator from ui/separator
       - Import UnlockButton from '@/components/employer/unlock-button'
       - Import ArrowLeft, Briefcase, GraduationCap, Scale, Cpu from lucide-react
       - Import Link from 'next/link'

       - **APPROVAL GATE (page-level):**
         - const user = await getUser()
         - const employerProfile = await getEmployerProfile(user.id)
         - if (!employerProfile || employerProfile.status !== 'approved') redirect('/employer')

       - Fetch profile: const profile = await getAnonymizedProfileById(params.id)
       - If !profile, call notFound()

       - Render detailed anonymized profile:
         - Back link: ArrowLeft icon + "Back to Browse" linking to /employer/browse
         - Title section: "IP Professional" (anonymous title), experience range badge
         - Main content in Card:
           - Section: "Specializations" -- list of Badge components for each specialization
           - Section: "Technical Background" -- list of Badge variant="outline" for each technical domain
           - Separator
           - Section: "Bar Admissions" -- Scale icon, list items showing "jurisdiction (status)"
           - Separator
           - Section: "Education" -- GraduationCap icon, list items showing "degree, institution (year)"
           - Separator
           - Section: "Experience" -- Briefcase icon, list items showing each work history entry:
             - "{title}" bold
             - "{type}" text-muted-foreground
             - "{durationRange}" text-sm
             - NO employer name anywhere
           - Separator
           - Section: Unlock CTA
             - Prominent card or section with:
               - Lock icon
               - "Want to see this candidate's full details?"
               - "Unlock this profile to see their name, contact information, and complete work history."
               - UnlockButton component with profileId
         - Use a clean, spacious layout. This is the page that sells the unlock.
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm the detail page compiles. Verify that the page imports getAnonymizedProfileById (not a full profile query). Verify that NO PII fields (name, email, phone, employer) appear in the render.
  </verify>
  <done>
    - Single profile detail page shows all anonymized information in a clean layout
    - Specializations, technical domains, bar admissions, education, work history all displayed
    - Work history shows title, type, duration -- NEVER employer name
    - Unlock Profile CTA is prominently displayed
    - Back link returns to browse page
    - Page-level approval gate prevents unapproved access
    - notFound() called for invalid profile IDs
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Browse page shows anonymized cards -- inspect card content for any PII leakage
3. Search updates URL params with 300ms debounce
4. Filter dropdowns update URL params and reset page to 1
5. Profile detail page shows full anonymized details with no PII
6. Unlock button is visible on both card footer and detail page
7. Unapproved employer visiting /employer/browse is redirected to /employer
8. Empty state renders helpful message when no profiles match
</verification>

<success_criteria>
- MARK-01 requirement satisfied: employers browse anonymized profiles enforced server-side
- Profile cards and detail page NEVER show name, email, phone, or employer names
- Experience shown as ranges ("5-10 years"), not exact values
- Search and filter are functional via URL search params (bookmarkable, shareable)
- Unlock Profile CTA is visible and ready for Phase 6 wiring
- Page-level approval check prevents stale layout status bypass
</success_criteria>

<output>
After completion, create `.planning/phases/04-employer-onboarding-and-browse/04-04-SUMMARY.md`
</output>
