---
phase: 05-search-and-discovery
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - src/app/(authenticated)/employer/saved/page.tsx
  - src/app/(authenticated)/employer/layout.tsx
autonomous: false

must_haves:
  truths:
    - "Employer can access a saved profiles page from the employer navigation"
    - "Saved profiles page shows all profiles the employer has saved, with the same anonymized card format"
    - "Employer can unsave a profile from the saved profiles page and it disappears"
    - "Empty saved page shows helpful message encouraging employer to browse and save profiles"
    - "All search filters, save/unsave, pagination, and empty states work correctly end-to-end"
  artifacts:
    - path: "src/app/(authenticated)/employer/saved/page.tsx"
      provides: "Saved profiles list page"
      contains: "getSavedProfiles"
    - path: "src/app/(authenticated)/employer/layout.tsx"
      provides: "Navigation link to saved profiles"
      contains: "saved"
  key_links:
    - from: "src/app/(authenticated)/employer/saved/page.tsx"
      to: "src/lib/dal/employer-saved.ts"
      via: "getSavedProfiles to get saved profile IDs"
      pattern: "getSavedProfiles"
    - from: "src/app/(authenticated)/employer/saved/page.tsx"
      to: "src/lib/dal/employer-profiles.ts"
      via: "getAnonymizedProfileById for each saved profile"
      pattern: "getAnonymizedProfileById"
---

<objective>
Create the saved profiles list page and add navigation, then verify the entire Phase 5 search and discovery feature end-to-end.

Purpose: The saved page completes the MARK-04 requirement (save/favorite for later viewing). The verification ensures all Phase 5 requirements work together correctly before moving on.

Output: Saved profiles page accessible from employer nav, plus verified end-to-end search/filter/save experience.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-search-and-discovery/05-RESEARCH.md
@.planning/phases/05-search-and-discovery/05-01-SUMMARY.md
@.planning/phases/05-search-and-discovery/05-02-SUMMARY.md

Key source files:
@src/app/(authenticated)/employer/layout.tsx
@src/lib/dal/employer-saved.ts
@src/lib/dal/employer-profiles.ts
@src/components/employer/profile-card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Saved profiles list page and navigation link</name>
  <files>
    src/app/(authenticated)/employer/saved/page.tsx
    src/app/(authenticated)/employer/layout.tsx
  </files>
  <action>
    1. CREATE `src/app/(authenticated)/employer/saved/page.tsx`:

       This is a server component page that shows all profiles saved by the current employer.

       **Approval gate:** Same pattern as browse page -- check user exists, role is employer, employer profile is approved. Redirect to /employer if not.

       **Data loading:**
       ```typescript
       import { getUser } from '@/lib/dal'
       import { getEmployerProfile } from '@/lib/dal/admin-employers'
       import { getSavedProfiles } from '@/lib/dal/employer-saved'
       import { getAnonymizedProfileById } from '@/lib/dal/employer-profiles'
       import { redirect } from 'next/navigation'
       import { ProfileCard } from '@/components/employer/profile-card'
       import { Heart, Users } from 'lucide-react'
       import Link from 'next/link'
       import { Button } from '@/components/ui/button'
       ```

       - Get saved profile IDs via `getSavedProfiles(user.id)`
       - For each saved ID, load anonymized profile via `getAnonymizedProfileById(id)`
       - Filter out nulls (profile may have been deactivated since being saved)
       - All saved profiles are inherently "saved" so pass `isSaved={true}` to each ProfileCard

       **Layout:**
       - Header: "Saved Profiles" title with description "Profiles you've saved for later review"
       - Count: "X saved profile(s)"
       - Grid: Same 3-column responsive grid as browse page, using ProfileCard
       - Empty state: When no saved profiles, show a centered card with Heart icon, "No saved profiles yet" heading, "Browse candidates and save profiles you're interested in to see them here." description, and a "Browse Candidates" button linking to /employer/browse

    2. UPDATE `src/app/(authenticated)/employer/layout.tsx`:

       Add a navigation link to the saved profiles page. Read the current layout first to understand its structure.

       Add a "Saved" or "Saved Profiles" link (with Heart icon) to the navigation area, next to the existing "Browse" link. Use the same styling pattern as existing nav links.

       Only show the saved link for approved employers (same condition that shows the browse link).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - saved/page.tsx exports a default async function component
    - saved/page.tsx has approval gate (redirects unapproved employers)
    - saved/page.tsx renders ProfileCard for each saved profile with isSaved={true}
    - Empty state shows browse CTA when no saved profiles
    - Layout includes navigation link to /employer/saved
  </verify>
  <done>
    Saved profiles page shows all employer's saved profiles in anonymized card grid with unsave capability. Empty state guides employers to browse page. Navigation link in employer layout provides easy access to saved profiles.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: End-to-end verification of search, filters, save, and saved page</name>
  <what-built>
    Complete Phase 5 search and discovery feature:
    - Multi-dimensional filter panel (specializations checkboxes, technical domains checkboxes, location input, patent bar toggle, experience dropdown)
    - Free-text search across non-PII fields (specialization names, technical domains, jurisdictions, education)
    - Save/unsave profiles with optimistic UI (filled/outline heart)
    - Saved profiles list page with navigation
    - URL-driven filter state (bookmarkable, shareable)
    - Pagination with filter persistence
    - Empty states with helpful guidance
  </what-built>
  <how-to-verify>
    Pre-requisites:
    - Ensure database has active candidate profiles with varied specializations, technical domains, bar admissions, and education (created in earlier phases)
    - Run `npm run dev` and log in as an approved employer
    - Apply the pg_trgm migration: connect to Neon database and run the SQL from `drizzle/0001_enable_pg_trgm.sql`, then run `npx drizzle-kit push` to apply the savedProfiles table

    Test 1: Filter by specialization
    1. Go to /employer/browse
    2. Check "Patent Prosecution" checkbox
    3. Verify: URL updates to include ?spec=Patent+Prosecution, result count changes, only profiles with Patent Prosecution specialization appear

    Test 2: Combine multiple filters
    1. With Patent Prosecution still checked, also check "Trademark"
    2. Verify: URL has spec=Patent+Prosecution&spec=Trademark, results show profiles with EITHER specialization
    3. Add experience range filter (e.g., 5-10 years)
    4. Verify: Results narrow further (AND between different filter types)

    Test 3: Free-text search
    1. Clear all filters
    2. Type "biotechnology" in the search box
    3. Verify: After 300ms debounce, results filter to profiles with biotechnology-related content
    4. Type a name (PII) -- verify it does NOT match any profiles (search only covers non-PII fields)

    Test 4: Patent bar and location filters
    1. Toggle "USPTO Patent Bar" checkbox
    2. Verify: Only profiles with USPTO bar admission appear
    3. Type a state name in location field (e.g., "California")
    4. Verify: Results further narrow to profiles with California bar admission

    Test 5: Save/unsave profiles
    1. Click the heart icon on a profile card
    2. Verify: Heart fills red immediately (optimistic), profile stays saved after page reload
    3. Click the filled heart again
    4. Verify: Heart returns to outline immediately, unsave persists after reload

    Test 6: Saved profiles page
    1. Save 2-3 profiles
    2. Navigate to /employer/saved (via nav link)
    3. Verify: All saved profiles appear in card grid with filled hearts
    4. Unsave one from the saved page
    5. Verify: It disappears from the saved list

    Test 7: Empty states
    1. Apply very narrow filters (e.g., rare specialization + experience combo)
    2. Verify: Empty state shows "No candidates found" with guidance to broaden filters
    3. Go to /employer/saved and unsave all profiles
    4. Verify: Empty state shows "No saved profiles yet" with link to browse

    Test 8: Pagination
    1. Remove all filters to see all candidates
    2. If more than 12 candidates exist, verify pagination controls appear
    3. Navigate to page 2
    4. Verify: URL includes page=2, results change
    5. Add a filter
    6. Verify: Page resets to 1

    Test 9: URL shareability
    1. Apply several filters and copy the URL
    2. Open in a new tab (while logged in as employer)
    3. Verify: Same filters are applied and results match
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- Build succeeds: `npm run build`
- All filter dimensions work in combination
- Save/unsave persists to database
- Saved profiles page shows correct profiles
- Empty states are helpful
- No PII leakage through search
- URL state is shareable and bookmarkable
</verification>

<success_criteria>
1. Employer can narrow candidates using any combination of: specializations, technical domains, location, patent bar, experience range, free-text search
2. Save/unsave works with instant optimistic feedback and database persistence
3. Saved profiles page shows all saved profiles with ability to unsave
4. All filter state lives in URL params (copy URL -> paste in new tab -> same results)
5. Empty states provide actionable guidance
6. No PII is ever searchable or visible in anonymized views
</success_criteria>

<output>
After completion, create `.planning/phases/05-search-and-discovery/05-03-SUMMARY.md`
</output>
