---
phase: 05-search-and-discovery
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/actions/saved-profiles.ts
  - src/app/(authenticated)/employer/browse/filters.tsx
  - src/app/(authenticated)/employer/browse/saved-button.tsx
  - src/app/(authenticated)/employer/browse/page.tsx
  - src/components/employer/profile-card.tsx
  - src/app/(authenticated)/employer/browse/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Employer can filter by multiple specializations simultaneously using checkboxes"
    - "Employer can filter by multiple technical domains simultaneously using checkboxes"
    - "Employer can filter by location (bar admission jurisdiction) via text input"
    - "Employer can toggle patent bar filter (boolean)"
    - "Employer can filter by experience range via dropdown"
    - "Combining multiple filters narrows results with AND logic"
    - "Selecting multiple values within a filter (e.g., 2 specializations) uses OR logic"
    - "Employer can save/unsave a profile from the browse card or detail page"
    - "Save button shows filled heart when saved, outline when not saved"
    - "Filter state persists in URL params (shareable, bookmarkable)"
    - "Changing any filter resets page to 1"
  artifacts:
    - path: "src/actions/saved-profiles.ts"
      provides: "toggleSaveProfile server action"
      exports: ["toggleSaveProfile"]
    - path: "src/app/(authenticated)/employer/browse/filters.tsx"
      provides: "Multi-select filter UI with checkboxes"
      contains: "Checkbox"
    - path: "src/app/(authenticated)/employer/browse/saved-button.tsx"
      provides: "Save/unsave button with optimistic UI"
      contains: "useOptimistic"
    - path: "src/app/(authenticated)/employer/browse/page.tsx"
      provides: "Browse page reading all filter params and saved state"
      contains: "getSavedProfileIds"
    - path: "src/components/employer/profile-card.tsx"
      provides: "Profile card with save button"
      contains: "SaveButton"
    - path: "src/app/(authenticated)/employer/browse/[id]/page.tsx"
      provides: "Profile detail with save button"
      contains: "SaveButton"
  key_links:
    - from: "src/app/(authenticated)/employer/browse/page.tsx"
      to: "src/lib/dal/employer-profiles.ts"
      via: "getAnonymizedProfiles with SearchFilters"
      pattern: "getAnonymizedProfiles\\("
    - from: "src/app/(authenticated)/employer/browse/page.tsx"
      to: "src/lib/dal/employer-saved.ts"
      via: "getSavedProfileIds for batch save status"
      pattern: "getSavedProfileIds"
    - from: "src/actions/saved-profiles.ts"
      to: "src/lib/db/schema.ts"
      via: "insert/delete on savedProfiles table"
      pattern: "savedProfiles"
    - from: "src/app/(authenticated)/employer/browse/saved-button.tsx"
      to: "src/actions/saved-profiles.ts"
      via: "toggleSaveProfile server action"
      pattern: "toggleSaveProfile"
    - from: "src/app/(authenticated)/employer/browse/filters.tsx"
      to: "URL search params"
      via: "useSearchParams + useRouter.replace"
      pattern: "router\\.replace"
---

<objective>
Build the complete search/filter UI and save functionality for employer browse experience: multi-select filters with URL-driven state, a server action for save/unsave with optimistic UI, and wire everything into the browse page and profile cards.

Purpose: This is the employer-facing layer of Phase 5. Employers need to efficiently narrow hundreds of anonymized profiles down to candidates matching their specific hiring needs, and save promising ones for later review.

Output: Enhanced browse page with multi-dimensional filtering (specializations, technical domains, location, patent bar, experience), save/unsave buttons on cards and detail page with optimistic UI, all filter state in URL params.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-search-and-discovery/05-RESEARCH.md
@.planning/phases/05-search-and-discovery/05-01-SUMMARY.md

Key source files (current state before Plan 01 changes):
@src/app/(authenticated)/employer/browse/page.tsx
@src/app/(authenticated)/employer/browse/search.tsx
@src/app/(authenticated)/employer/browse/filters.tsx
@src/app/(authenticated)/employer/browse/[id]/page.tsx
@src/components/employer/profile-card.tsx
@src/lib/dal/employer-profiles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Server action for save/unsave and SaveButton client component</name>
  <files>
    src/actions/saved-profiles.ts
    src/app/(authenticated)/employer/browse/saved-button.tsx
  </files>
  <action>
    1. CREATE `src/actions/saved-profiles.ts`:
       ```typescript
       'use server'
       import { revalidatePath } from 'next/cache'
       import { db } from '@/lib/db'
       import { savedProfiles } from '@/lib/db/schema'
       import { eq, and } from 'drizzle-orm'
       import { getUser } from '@/lib/dal'
       ```

       **toggleSaveProfile(profileId: string): Promise<{ error?: string; saved?: boolean }>**
       - Get current user via `getUser()`. If no user or user.role !== 'employer', return `{ error: 'Unauthorized' }`
       - Check if already saved: `db.select().from(savedProfiles).where(and(eq(savedProfiles.employerUserId, user.id), eq(savedProfiles.profileId, profileId))).limit(1)`
       - If exists: DELETE with same conditions. Return `{ saved: false }`
       - If not exists: INSERT `{ employerUserId: user.id, profileId }`. Return `{ saved: true }`
       - Call `revalidatePath('/employer/browse')` and `revalidatePath('/employer/saved')` after mutation
       - Wrap in try/catch, return `{ error: 'Failed to update saved status' }` on error

    2. CREATE `src/app/(authenticated)/employer/browse/saved-button.tsx`:
       ```typescript
       'use client'
       import { useOptimistic, useTransition } from 'react'
       import { Heart } from 'lucide-react'
       import { Button } from '@/components/ui/button'
       import { toggleSaveProfile } from '@/actions/saved-profiles'
       ```

       **SaveButton component:**
       - Props: `{ profileId: string; initialSaved: boolean; size?: 'sm' | 'default' }`
       - Use `useTransition` for pending state
       - Use `useOptimistic(initialSaved)` for instant UI feedback
       - onClick handler: `startTransition(async () => { setOptimisticSaved(!optimisticSaved); await toggleSaveProfile(profileId) })`
       - Render: `Button` with `variant="ghost"`, `size="icon"` (or "sm" based on size prop)
       - Heart icon: when `optimisticSaved`, add classes `fill-red-500 text-red-500`; when not, no fill
       - Add `aria-label={optimisticSaved ? 'Unsave profile' : 'Save profile'}` for accessibility
       - Add `disabled={isPending}` to prevent double-clicks
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `saved-profiles.ts` exports toggleSaveProfile
    - `saved-button.tsx` exports SaveButton component
    - SaveButton uses useOptimistic for instant UI feedback
    - Server action checks user role before mutation
    - Server action calls revalidatePath for both /employer/browse and /employer/saved
  </verify>
  <done>
    toggleSaveProfile server action performs insert-or-delete toggle on savedProfiles table with auth check. SaveButton client component shows filled/outline heart with optimistic UI that updates instantly before server round-trip.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhanced filter UI, browse page wiring, and profile card/detail updates</name>
  <files>
    src/app/(authenticated)/employer/browse/filters.tsx
    src/app/(authenticated)/employer/browse/page.tsx
    src/components/employer/profile-card.tsx
    src/app/(authenticated)/employer/browse/[id]/page.tsx
  </files>
  <action>
    1. REWRITE `src/app/(authenticated)/employer/browse/filters.tsx`:

       Replace the two single-select dropdowns with a comprehensive filter panel:

       **Constants** (keep SPECIALIZATIONS and EXPERIENCE_RANGES arrays, add):
       ```typescript
       const TECHNICAL_DOMAINS = [
         'Biotechnology', 'Chemical', 'Computer Science', 'Electrical Engineering',
         'Mechanical Engineering', 'Pharmaceutical', 'Software', 'Telecommunications',
       ]
       ```

       **FilterBar component** (still 'use client', still uses useSearchParams/usePathname/useRouter):

       **URL param scheme:**
       - `spec` (repeating): multiple specializations, e.g. `spec=Patent+Prosecution&spec=Trademark`
       - `tech` (repeating): multiple technical domains
       - `patent_bar`: "true" or absent
       - `location`: string
       - `experience`: single value (same as current)
       - `q`: search text (handled by SearchInput, not FilterBar)

       **Helper function `toArray`:**
       ```typescript
       function toArray(param: string | string[] | undefined): string[] {
         if (!param) return []
         return Array.isArray(param) ? param : [param]
       }
       ```

       **Layout:** Use a collapsible/expandable filter section. Arrange filters in a flex-wrap layout:

       a) **Specializations** -- Checkbox group (multi-select). Read current from `searchParams.getAll('spec')`. On toggle: remove all 'spec' params, re-add the remaining ones, reset page to 1.

       b) **Technical Domains** -- Checkbox group (multi-select). Same pattern as specializations but with `tech` param.

       c) **Experience Range** -- Keep as single-select `<Select>` dropdown (same as current but param name stays `experience`).

       d) **Patent Bar** -- Simple toggle using a `<Checkbox>` labeled "USPTO Patent Bar". Read from `searchParams.get('patent_bar') === 'true'`. On toggle: set/remove `patent_bar` param.

       e) **Location** -- Debounced text `<Input>` (like search). Use `useDebouncedCallback` from `use-debounce`. Param name: `location`. Debounce 300ms.

       f) **Clear All Filters** button -- removes all filter params except `q`, resets page.

       **Styling:** Use shadcn Checkbox components. Group each filter section with a `<p className="text-sm font-medium">` label. Wrap the whole thing in a bordered card/div with padding for visual separation.

       Import `Checkbox` from `@/components/ui/checkbox`. If Checkbox component doesn't exist, run `npx shadcn@latest add checkbox` first.

    2. UPDATE `src/app/(authenticated)/employer/browse/page.tsx`:

       **Update searchParams type** to include all new filter params:
       ```typescript
       searchParams: Promise<{
         q?: string
         spec?: string | string[]
         tech?: string | string[]
         experience?: string
         patent_bar?: string
         location?: string
         page?: string
       }>
       ```

       **Normalize multi-value params** using toArray helper (define locally or import):
       ```typescript
       function toArray(param: string | string[] | undefined): string[] {
         if (!param) return []
         return Array.isArray(param) ? param : [param]
       }
       ```

       **Call getAnonymizedProfiles with full SearchFilters:**
       ```typescript
       const { profiles, total } = await getAnonymizedProfiles({
         search: params.q,
         specializations: toArray(params.spec),
         technicalDomains: toArray(params.tech),
         experienceRange: params.experience,
         patentBar: params.patent_bar === 'true',
         location: params.location,
         page,
         pageSize,
       })
       ```

       **Load saved profile IDs** for the current page:
       ```typescript
       import { getSavedProfileIds } from '@/lib/dal/employer-saved'

       const profileIds = profiles.map(p => p.id)
       const savedIds = await getSavedProfileIds(user.id, profileIds)
       ```

       **Pass isSaved to ProfileCard:**
       ```tsx
       <ProfileCard
         key={profile.id}
         profile={profile}
         isSaved={savedIds.has(profile.id)}
       />
       ```

       **Update buildPageUrl** to preserve ALL filter params (spec, tech, experience, patent_bar, location, q) when navigating between pages. For multi-value params, use `params.spec` as string|string[] and iterate to append each.

       **Improve empty state:** Add suggestions based on active filters. Show "Try broadening your filters or clearing some to see more candidates." with a link that clears filters.

    3. UPDATE `src/components/employer/profile-card.tsx`:

       **Add props:** `isSaved: boolean`

       **Import SaveButton** from `@/app/(authenticated)/employer/browse/saved-button`

       **Add SaveButton** to the card header area (top-right corner, absolute positioned or in a flex row with the title):
       ```tsx
       <CardHeader className="flex flex-row items-start justify-between">
         <div>
           <CardTitle>IP Professional</CardTitle>
           <CardDescription>{profile.experienceRange} experience</CardDescription>
         </div>
         <SaveButton profileId={profile.id} initialSaved={isSaved} size="sm" />
       </CardHeader>
       ```

    4. UPDATE `src/app/(authenticated)/employer/browse/[id]/page.tsx`:

       **Import and use SaveButton and isProfileSaved:**
       ```typescript
       import { isProfileSaved } from '@/lib/dal/employer-saved'
       import { SaveButton } from '../saved-button'
       ```

       After fetching the profile, check if saved:
       ```typescript
       const saved = await isProfileSaved(user.id, id)
       ```

       Add SaveButton next to the "IP Professional" heading in the title section:
       ```tsx
       <div className="flex items-center gap-3">
         <h1 className="text-3xl font-bold tracking-tight">IP Professional</h1>
         <Badge variant="secondary">{profile.experienceRange} experience</Badge>
         <SaveButton profileId={profile.id} initialSaved={saved} />
       </div>
       ```

    IMPORTANT: Before writing filters.tsx, check if `@/components/ui/checkbox` exists. If not, run `npx shadcn@latest add checkbox` to install it.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds (or `npx next build`)
    - filters.tsx renders checkboxes for specializations and technical domains
    - filters.tsx has location input with debounce and patent bar checkbox toggle
    - browse/page.tsx reads all filter params (spec, tech, experience, patent_bar, location) and passes to getAnonymizedProfiles
    - browse/page.tsx loads saved status and passes isSaved to each ProfileCard
    - ProfileCard renders SaveButton in header
    - Profile detail page shows SaveButton next to title
    - URL params update correctly when toggling filters
  </verify>
  <done>
    Browse page shows enhanced filter panel with multi-select specializations (checkboxes), multi-select technical domains (checkboxes), location text input, patent bar toggle, and experience dropdown. Each profile card and detail page displays a save/unsave heart button with optimistic UI. All filter state lives in URL params, enabling bookmarkable/shareable searches. Changing filters resets to page 1.
  </done>
</task>

</tasks>

<verification>
- Full build passes: `npm run build`
- Filter checkboxes update URL params with repeated param pattern (spec=A&spec=B)
- Save button toggles between filled/outline heart
- Profile cards show correct saved state from database
- Pagination preserves all active filters
- Clear all filters button removes all filter params
- Empty state shows helpful guidance to broaden filters
</verification>

<success_criteria>
1. Build passes with zero errors
2. Selecting Patent Prosecution + Trademark checkboxes produces URL: ?spec=Patent+Prosecution&spec=Trademark
3. Clicking heart on profile card fills it red immediately (optimistic), then persists after page reload
4. Combining filters narrows results (verified by result count decreasing)
5. Navigating to page 2 preserves all active filters in URL
6. Clear all filters button removes spec, tech, patent_bar, location, experience params
</success_criteria>

<output>
After completion, create `.planning/phases/05-search-and-discovery/05-02-SUMMARY.md`
</output>
