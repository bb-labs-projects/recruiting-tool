---
phase: 08-job-posting-and-ai-matching
plan: 04
type: execute
wave: 3
depends_on: ["08-02", "08-03"]
files_modified:
  - src/app/admin/jobs/page.tsx
  - src/app/admin/jobs/new/page.tsx
  - src/app/admin/jobs/[id]/page.tsx
  - src/app/admin/jobs/columns.tsx
  - src/app/admin/jobs/data-table.tsx
  - src/app/admin/layout.tsx
  - src/lib/email/match-notification.ts
  - src/actions/jobs.ts
autonomous: true

must_haves:
  truths:
    - "Admin can see all jobs across all employers in a sortable table"
    - "Admin can create a job listing on behalf of any employer"
    - "Admin can view any job's match results and trigger matching"
    - "System sends email notifications to employers when new matches are found"
    - "Notifications are sent only once per match (notifiedAt tracking prevents spam)"
    - "Admin sidebar includes Jobs link"
  artifacts:
    - path: "src/app/admin/jobs/page.tsx"
      provides: "Admin job management page with TanStack Table"
      min_lines: 20
    - path: "src/app/admin/jobs/new/page.tsx"
      provides: "Admin job creation page with employer selection"
      min_lines: 20
    - path: "src/app/admin/jobs/[id]/page.tsx"
      provides: "Admin job detail with matches and notify button"
      min_lines: 40
    - path: "src/app/admin/jobs/columns.tsx"
      provides: "TanStack Table column definitions for jobs"
      min_lines: 20
    - path: "src/app/admin/jobs/data-table.tsx"
      provides: "Reusable DataTable component for admin jobs"
      min_lines: 20
    - path: "src/lib/email/match-notification.ts"
      provides: "Email templates and send functions for match notifications"
      exports: ["sendMatchNotificationToEmployer", "sendMatchNotificationToCandidate"]
    - path: "src/actions/jobs.ts"
      provides: "Extended with admin-specific actions"
      exports: ["createJobAction", "updateJobAction", "publishJobAction", "createJobForEmployerAction", "triggerNotificationsAction"]
  key_links:
    - from: "src/app/admin/jobs/page.tsx"
      to: "src/lib/dal/jobs.ts"
      via: "calls getJobsForAdmin"
      pattern: "import.*getJobsForAdmin.*from.*dal/jobs"
    - from: "src/app/admin/jobs/[id]/page.tsx"
      to: "src/lib/dal/job-matches.ts"
      via: "calls getMatchesForJob and getUnnotifiedMatches"
      pattern: "import.*getMatchesForJob.*from.*dal/job-matches"
    - from: "src/lib/email/match-notification.ts"
      to: "resend"
      via: "Resend batch.send for email delivery"
      pattern: "resend\\.batch\\.send|resend\\.emails\\.send"
    - from: "src/actions/jobs.ts"
      to: "src/lib/email/match-notification.ts"
      via: "triggerNotificationsAction sends match emails"
      pattern: "import.*sendMatchNotification.*from.*email/match-notification"
    - from: "src/app/admin/layout.tsx"
      to: "/admin/jobs"
      via: "sidebar navigation link"
      pattern: "href.*admin/jobs"
---

<objective>
Create admin job management pages (list, create on behalf of employer, detail with matches), match notification emails via Resend, and notification-sending server action. Add Jobs to admin sidebar.

Purpose: Enables the agency to manage job listings on behalf of employer clients and notify both employers and candidates when good matches are found. Completes the full job posting and AI matching feature set.
Output: Admin job pages (5 files), notification email module, extended server actions, updated admin layout.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-job-posting-and-ai-matching/08-RESEARCH.md
@.planning/phases/08-job-posting-and-ai-matching/08-01-SUMMARY.md
@.planning/phases/08-job-posting-and-ai-matching/08-02-SUMMARY.md
@.planning/phases/08-job-posting-and-ai-matching/08-03-SUMMARY.md

Key reference files:
@src/app/admin/layout.tsx -- admin sidebar to extend with Jobs link
@src/app/admin/candidates/page.tsx -- admin list page pattern with TanStack Table
@src/app/admin/candidates/columns.tsx -- TanStack column definitions pattern
@src/app/admin/candidates/data-table.tsx -- DataTable component pattern
@src/app/admin/employers/page.tsx -- admin employer list pattern
@src/lib/email/magic-link-email.tsx -- Resend email sending pattern
@src/lib/dal/jobs.ts -- job DAL (created in plan 01)
@src/lib/dal/job-matches.ts -- match result DAL (created in plan 01)
@src/lib/dal/admin-employers.ts -- admin DAL pattern for loading employers
@src/actions/jobs.ts -- job server actions (created in plan 03)
@src/components/jobs/job-form.tsx -- job form component (created in plan 03)
@src/components/jobs/match-results.tsx -- match results component (created in plan 03)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin job management pages and update sidebar</name>
  <files>src/app/admin/jobs/page.tsx, src/app/admin/jobs/new/page.tsx, src/app/admin/jobs/[id]/page.tsx, src/app/admin/jobs/columns.tsx, src/app/admin/jobs/data-table.tsx, src/app/admin/layout.tsx</files>
  <action>
**In `src/app/admin/jobs/columns.tsx`:**

Follow the EXACT pattern from `src/app/admin/candidates/columns.tsx`. Define TanStack Table columns for the admin job list:

- **Title** -- sortable, link to `/admin/jobs/${row.id}`
- **Employer** -- company name (from joined employer profile)
- **Status** -- badge with color coding (draft=gray, open=green, closed=yellow, archived=red)
- **Matching** -- matching status badge (pending=gray, running=blue, completed=green, failed=red)
- **Matches** -- match count number
- **Created** -- formatted date

Column type: `ColumnDef<AdminJobListDTO>[]` where `AdminJobListDTO` comes from the jobs DAL.

**In `src/app/admin/jobs/data-table.tsx`:**

Copy and adapt from `src/app/admin/candidates/data-table.tsx`. Reusable DataTable with sorting and filtering. Use `@tanstack/react-table`. Include basic column sorting and a search filter on title.

**In `src/app/admin/jobs/page.tsx`:**

Server component. Follow pattern from `src/app/admin/candidates/page.tsx`:
1. Call `getJobsForAdmin()` from the jobs DAL
2. Render heading "Job Listings" with a "Create Job" button linking to `/admin/jobs/new`
3. Render `<DataTable columns={columns} data={jobs} />`

**In `src/app/admin/jobs/new/page.tsx`:**

Server component for admin creating a job on behalf of an employer.

This is different from the employer's create page because admin must SELECT which employer the job is for:

1. Load all approved employers via a DAL query: `db.query.employerProfiles.findMany({ where: eq(status, 'approved'), with: { user: { columns: { id: true, email: true } } } })`.
2. Render heading "Create Job for Employer"
3. Render an employer selection dropdown (select the employer user ID)
4. Then render the `<JobForm>` component with the `createJobForEmployerAction` server action
5. The employer selection must be passed as a hidden input or part of the form data

**In `src/app/admin/jobs/[id]/page.tsx`:**

Server component. Admin job detail page.

1. Load job via `getJobById(params.id)` -- admin can view any job, no ownership check
2. If not found, `notFound()`
3. Display all job details (title, description, requirements as chips)
4. Display employer info (company name, email)
5. Show matching section (same as employer detail but admin has additional powers):
   - "Run Matching" / "Retry Matching" button (same MatchingTrigger client component from plan 03)
   - If matches exist, show `<MatchResults>` component
   - Additional: "Send Notifications" button that triggers notification emails for unnotified matches. This calls `triggerNotificationsAction(jobId)`. Show count of unnotified matches.
6. Show job status controls: Publish (draft->open), Close (open->closed), Archive (closed->archived)

**In `src/app/admin/layout.tsx`:**

Add a "Jobs" entry to the `navLinks` array, positioned after "Employers":

```typescript
{ name: 'Jobs', href: '/admin/jobs' },
```

This is a one-line change to the existing array. Do NOT modify the rest of the layout.
  </action>
  <verify>Run `npx tsc --noEmit` to verify all files compile. Verify admin layout sidebar includes Jobs link. Verify the admin jobs list page loads via getJobsForAdmin. Verify admin can create jobs with employer selection.</verify>
  <done>Admin can manage all jobs in a TanStack Table, create jobs on behalf of employers with employer selection, view any job's detail with matches and notification controls. Admin sidebar shows Jobs link.</done>
</task>

<task type="auto">
  <name>Task 2: Create notification email module and notification server action</name>
  <files>src/lib/email/match-notification.ts, src/actions/jobs.ts</files>
  <action>
**In `src/lib/email/match-notification.ts`:**

Follow the EXACT pattern from `src/lib/email/magic-link-email.tsx`: Resend client instantiation, inline HTML template, error handling.

Export two functions:

1. `sendMatchNotificationToEmployer(data: { employerEmail: string; employerName: string; jobTitle: string; matchCount: number; topScore: number; jobId: string }): Promise<void>`

   Sends a single email to the employer notifying them of new matches for their job.

   Email content:
   - Subject: `${matchCount} candidates match your "${jobTitle}" posting`
   - Body: inline HTML (same style as magic link email -- light background, white card, dark button)
   - Key info: "We found {matchCount} candidates matching your job requirements. The top candidate scored {topScore}/100."
   - CTA button: "View Matches" linking to `${appUrl}/employer/jobs/${jobId}`
   - Footer: "You're receiving this because you have an active job posting on {appName}."

2. `sendMatchNotificationToCandidates(candidates: { email: string; name: string; jobTitle: string; recommendation: string }[]): Promise<void>`

   Uses Resend batch API to notify candidates about matching jobs. Batch up to 100 per call.

   Email content per candidate:
   - Subject: `New job match: "${jobTitle}"`
   - Body: "A new job posting matches your profile. You've been rated as a '{recommendation}' for the position of {jobTitle}."
   - CTA button: "View Your Profile" linking to `${appUrl}/candidate` (candidates view their own profile, not the job directly -- they may not have access to job details)
   - Footer: "You're receiving this because your profile is active on {appName}."

   For batch sending:
   ```typescript
   const resend = new Resend(process.env.RESEND_API_KEY)
   // Split into chunks of 100 for Resend batch API limit
   for (const chunk of chunks(emails, 100)) {
     await resend.batch.send(chunk)
   }
   ```

   Implement a simple `chunks<T>(arr: T[], size: number): T[][]` helper.

**Extend `src/actions/jobs.ts`:**

Read the existing file first (created in plan 03), then add:

1. `createJobForEmployerAction(prevState: ActionState | undefined, formData: FormData): Promise<ActionState>` -- Admin-only server action.
   - Call `getUser()`, verify role is 'admin'.
   - Extract `employerUserId` from formData.
   - Validate that the employer user exists and has an approved employer profile.
   - Parse and validate remaining fields with the same `CreateJobSchema`.
   - Call `createJob()` with `employerUserId` from form and `createdBy: user.id` (admin's ID).
   - Revalidate `/admin/jobs`.
   - Return `{ success: true, jobId }`.

2. `triggerNotificationsAction(jobId: string): Promise<ActionState>` -- Admin-only action to send match notifications.
   - Call `getUser()`, verify role is 'admin'.
   - Load job by ID, verify it exists.
   - Call `getUnnotifiedMatches(jobId, 25)` from job-matches DAL (minimum score 25 to avoid notifying about weak matches).
   - If no unnotified matches, return `{ error: 'No new matches to notify about' }`.
   - Load employer email for the job (from job's employerUserId -> users table).
   - Send employer notification: `sendMatchNotificationToEmployer({ employerEmail, employerName, jobTitle, matchCount, topScore, jobId })`.
   - For candidate notifications: load candidate profiles for each match (need email and name). Only notify candidates who have a userId (self-registered candidates with email access). For agency-uploaded candidates without a userId, skip (they don't have platform accounts).
   - Send candidate notifications via `sendMatchNotificationToCandidates(candidates)`.
   - Call `markMatchesNotified(matchIds)` to set notifiedAt timestamps.
   - Revalidate `/admin/jobs/${jobId}`.
   - Return `{ success: true }`.

3. `updateJobStatusAction(jobId: string, newStatus: 'open' | 'closed' | 'archived'): Promise<ActionState>` -- Admin action to change job status.
   - Call `getUser()`, verify role is 'admin'.
   - Call `updateJob(jobId, { status: newStatus })`.
   - Revalidate paths.
   - Return `{ success: true }`.
  </action>
  <verify>Run `npx tsc --noEmit` to verify all files compile. Verify match-notification.ts uses Resend batch API for candidates. Verify triggerNotificationsAction only notifies unnotified matches (checks notifiedAt IS NULL) and marks them after sending. Verify createJobForEmployerAction checks admin role.</verify>
  <done>Notification emails use inline HTML via Resend (single for employer, batch for candidates). Admin can trigger notifications for unnotified matches. Notifications are tracked via notifiedAt to prevent spam. Admin can create jobs on behalf of employers and change job status.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- Admin sidebar shows "Jobs" link
- `/admin/jobs` shows all jobs across employers in TanStack Table
- `/admin/jobs/new` has employer selection dropdown and job form
- `/admin/jobs/[id]` shows job detail, matches, and "Send Notifications" button
- Notification email templates follow existing magic link email pattern
- `triggerNotificationsAction` only sends to unnotified matches (notifiedAt IS NULL)
- `markMatchesNotified` sets notifiedAt after sending
- Resend batch API used for candidate notifications (chunks of 100)
- `createJobForEmployerAction` requires admin role and validates employer exists
</verification>

<success_criteria>
Admin can manage all jobs (list, create on behalf of employer, view detail with matches). System sends email notifications to employers about new matches and to candidates about matching jobs. Notifications are tracked to prevent duplicates. All success criteria from the phase are met:
1. Employer can create jobs (plan 03)
2. Admin can create jobs on behalf (this plan)
3. System produces ranked match results with explanations (plan 02 + 03)
4. Two-stage matching approach (plan 02)
5. Notifications for employers and candidates (this plan)
</success_criteria>

<output>
After completion, create `.planning/phases/08-job-posting-and-ai-matching/08-04-SUMMARY.md`
</output>
