---
phase: 08-job-posting-and-ai-matching
plan: 04
type: execute
wave: 3
depends_on: ["08-02", "08-03"]
files_modified:
  - src/app/admin/jobs/columns.tsx
  - src/app/admin/jobs/data-table.tsx
  - src/app/admin/jobs/page.tsx
  - src/app/admin/layout.tsx
  - src/app/admin/jobs/new/page.tsx
  - src/app/admin/jobs/[id]/page.tsx
  - src/actions/jobs.ts
autonomous: true

must_haves:
  truths:
    - "Admin can see all jobs across all employers in a sortable table"
    - "Admin can create a job listing on behalf of any employer"
    - "Admin can view any job's match results and trigger matching"
    - "Admin can manually re-send notifications for unnotified matches"
    - "Notifications are sent only once per match (notifiedAt tracking prevents spam)"
    - "Admin sidebar includes Jobs link"
  artifacts:
    - path: "src/app/admin/jobs/columns.tsx"
      provides: "TanStack Table column definitions for jobs"
      min_lines: 20
    - path: "src/app/admin/jobs/data-table.tsx"
      provides: "Reusable DataTable component for admin jobs"
      min_lines: 20
    - path: "src/app/admin/jobs/page.tsx"
      provides: "Admin job management page with TanStack Table"
      min_lines: 20
    - path: "src/app/admin/jobs/new/page.tsx"
      provides: "Admin job creation page with employer selection"
      min_lines: 20
    - path: "src/app/admin/jobs/[id]/page.tsx"
      provides: "Admin job detail with matches, notify button, and status controls"
      min_lines: 40
    - path: "src/actions/jobs.ts"
      provides: "Extended with admin-specific actions"
      exports: ["createJobAction", "updateJobAction", "publishJobAction", "createJobForEmployerAction", "triggerNotificationsAction", "updateJobStatusAction"]
  key_links:
    - from: "src/app/admin/jobs/page.tsx"
      to: "src/lib/dal/jobs.ts"
      via: "calls getJobsForAdmin"
      pattern: "import.*getJobsForAdmin.*from.*dal/jobs"
    - from: "src/app/admin/jobs/[id]/page.tsx"
      to: "src/lib/dal/job-matches.ts"
      via: "calls getMatchesForJob and getUnnotifiedMatches"
      pattern: "import.*getMatchesForJob.*from.*dal/job-matches"
    - from: "src/actions/jobs.ts"
      to: "src/lib/matching/notify.ts"
      via: "triggerNotificationsAction calls notifyMatchResults for manual re-send"
      pattern: "import.*notifyMatchResults.*from.*matching/notify"
    - from: "src/app/admin/layout.tsx"
      to: "/admin/jobs"
      via: "sidebar navigation link"
      pattern: "href.*admin/jobs"
---

<objective>
Create admin job management pages (list with TanStack Table, create on behalf of employer, detail with matches and notification controls) and admin-specific server actions. Add Jobs to admin sidebar.

Purpose: Enables the agency to manage job listings on behalf of employer clients and manually re-trigger notifications. Completes the full job posting and AI matching feature set. Note: automatic notifications happen in Plan 02's matching pipeline; this plan adds manual admin re-send capability.
Output: Admin job pages (5 files), extended server actions, updated admin layout.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-job-posting-and-ai-matching/08-RESEARCH.md
@.planning/phases/08-job-posting-and-ai-matching/08-01-SUMMARY.md
@.planning/phases/08-job-posting-and-ai-matching/08-02-SUMMARY.md
@.planning/phases/08-job-posting-and-ai-matching/08-03-SUMMARY.md

Key reference files:
@src/app/admin/layout.tsx -- admin sidebar to extend with Jobs link
@src/app/admin/candidates/page.tsx -- admin list page pattern with TanStack Table
@src/app/admin/candidates/columns.tsx -- TanStack column definitions pattern
@src/app/admin/candidates/data-table.tsx -- DataTable component pattern
@src/app/admin/employers/page.tsx -- admin employer list pattern
@src/lib/dal/jobs.ts -- job DAL (created in plan 01)
@src/lib/dal/job-matches.ts -- match result DAL (created in plan 01)
@src/lib/dal/admin-employers.ts -- admin DAL pattern for loading employers
@src/lib/matching/notify.ts -- notification module (created in plan 02)
@src/actions/jobs.ts -- job server actions (created in plan 03)
@src/components/jobs/job-form.tsx -- job form component (created in plan 03)
@src/components/jobs/match-results.tsx -- match results component (created in plan 03)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin job list page with TanStack Table, columns, and sidebar link</name>
  <files>src/app/admin/jobs/columns.tsx, src/app/admin/jobs/data-table.tsx, src/app/admin/jobs/page.tsx, src/app/admin/layout.tsx</files>
  <action>
**In `src/app/admin/jobs/columns.tsx`:**

Follow the EXACT pattern from `src/app/admin/candidates/columns.tsx`. Define TanStack Table columns for the admin job list:

- **Title** -- sortable, link to `/admin/jobs/${row.id}`
- **Employer** -- company name (from joined employer profile)
- **Status** -- badge with color coding (draft=gray, open=green, closed=yellow, archived=red)
- **Matching** -- matching status badge (pending=gray, running=blue, completed=green, failed=red)
- **Matches** -- match count number
- **Created** -- formatted date

Column type: `ColumnDef<AdminJobListDTO>[]` where `AdminJobListDTO` comes from the jobs DAL.

**In `src/app/admin/jobs/data-table.tsx`:**

Copy and adapt from `src/app/admin/candidates/data-table.tsx`. Reusable DataTable with sorting and filtering. Use `@tanstack/react-table`. Include basic column sorting and a search filter on title.

**In `src/app/admin/jobs/page.tsx`:**

Server component. Follow pattern from `src/app/admin/candidates/page.tsx`:
1. Call `getJobsForAdmin()` from the jobs DAL
2. Render heading "Job Listings" with a "Create Job" button linking to `/admin/jobs/new`
3. Render `<DataTable columns={columns} data={jobs} />`

**In `src/app/admin/layout.tsx`:**

Add a "Jobs" entry to the `navLinks` array, positioned after "Employers":

```typescript
{ name: 'Jobs', href: '/admin/jobs' },
```

This is a one-line change to the existing array. Do NOT modify the rest of the layout.
  </action>
  <verify>Run `npx tsc --noEmit` to verify all files compile. Verify admin layout sidebar includes Jobs link. Verify the admin jobs list page loads via getJobsForAdmin. Verify column definitions include Title, Employer, Status, Matching, Matches, and Created.</verify>
  <done>Admin can see all jobs across employers in a sortable TanStack Table with status badges and match counts. Admin sidebar shows Jobs link.</done>
</task>

<task type="auto">
  <name>Task 2: Create admin job detail page, new page, and admin-specific server actions</name>
  <files>src/app/admin/jobs/new/page.tsx, src/app/admin/jobs/[id]/page.tsx, src/actions/jobs.ts</files>
  <action>
**In `src/app/admin/jobs/new/page.tsx`:**

Server component for admin creating a job on behalf of an employer.

This is different from the employer's create page because admin must SELECT which employer the job is for:

1. Load all approved employers via a DAL query: `db.query.employerProfiles.findMany({ where: eq(status, 'approved'), with: { user: { columns: { id: true, email: true } } } })`.
2. Render heading "Create Job for Employer"
3. Render an employer selection dropdown (select the employer user ID)
4. Then render the `<JobForm>` component with the `createJobForEmployerAction` server action
5. The employer selection must be passed as a hidden input or part of the form data

**In `src/app/admin/jobs/[id]/page.tsx`:**

Server component. Admin job detail page. This is the substantive page with matching trigger, notification controls, and status management.

1. Load job via `getJobById(params.id)` -- admin can view any job, no ownership check
2. If not found, `notFound()`
3. Display all job details (title, description, requirements as chips)
4. Display employer info (company name, email)
5. Show matching section (same as employer detail but admin has additional powers):
   - "Run Matching" / "Retry Matching" button (same MatchingTrigger client component from plan 03)
   - If matches exist, show `<MatchResults>` component
   - Additional: "Send Notifications" button that triggers notification emails for unnotified matches. This calls `triggerNotificationsAction(jobId)`. Show count of unnotified matches. Note: automatic notifications already fire after matching (Plan 02), but this button allows admin to manually re-send for matches that may have failed notification delivery.
6. Show job status controls: Publish (draft->open), Close (open->closed), Archive (closed->archived). Use `updateJobStatusAction` for these transitions.
7. Load unnotified match count via `getUnnotifiedMatches(jobId)` to show next to the notification button (e.g., "Send Notifications (3 pending)").

**Extend `src/actions/jobs.ts`:**

Read the existing file first (created in plan 03), then add these admin-specific actions:

1. `createJobForEmployerAction(prevState: ActionState | undefined, formData: FormData): Promise<ActionState>` -- Admin-only server action.
   - Call `getUser()`, verify role is 'admin'.
   - Extract `employerUserId` from formData.
   - Validate that the employer user exists and has an approved employer profile.
   - Parse and validate remaining fields with the same `CreateJobSchema`.
   - Call `createJob()` with `employerUserId` from form and `createdBy: user.id` (admin's ID).
   - Revalidate `/admin/jobs`.
   - Return `{ success: true, jobId }`.

2. `triggerNotificationsAction(jobId: string): Promise<ActionState>` -- Admin-only action to manually re-send match notifications.
   - Call `getUser()`, verify role is 'admin'.
   - Load job by ID, verify it exists.
   - Call `notifyMatchResults(jobId, 0)` from `src/lib/matching/notify.ts`. This reuses the same notification module that fires automatically after matching. The `notifyMatchResults` function internally checks for unnotified matches (notifiedAt IS NULL) and only sends for those, preventing spam.
   - If no unnotified matches exist, notifyMatchResults returns early.
   - Revalidate `/admin/jobs/${jobId}`.
   - Return `{ success: true }`.

3. `updateJobStatusAction(jobId: string, newStatus: 'open' | 'closed' | 'archived'): Promise<ActionState>` -- Admin action to change job status.
   - Call `getUser()`, verify role is 'admin'.
   - Call `updateJob(jobId, { status: newStatus })`.
   - Revalidate paths.
   - Return `{ success: true }`.
  </action>
  <verify>Run `npx tsc --noEmit` to verify all files compile. Verify admin can create jobs with employer selection via createJobForEmployerAction. Verify the detail page shows matches, notification button with pending count, and status controls. Verify triggerNotificationsAction reuses notifyMatchResults from Plan 02's notify module. Verify updateJobStatusAction checks admin role.</verify>
  <done>Admin can create jobs on behalf of employers with employer selection dropdown. Admin job detail page shows full job info, match results, "Send Notifications" button for manual re-send (with pending count), and status management controls. All admin actions verify admin role.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- Admin sidebar shows "Jobs" link
- `/admin/jobs` shows all jobs across employers in TanStack Table
- `/admin/jobs/new` has employer selection dropdown and job form
- `/admin/jobs/[id]` shows job detail, matches, "Send Notifications" button with pending count, and status controls
- `triggerNotificationsAction` reuses `notifyMatchResults` from Plan 02 (no duplicate notification logic)
- `notifyMatchResults` checks notifiedAt IS NULL internally, preventing spam even on manual re-send
- `createJobForEmployerAction` requires admin role and validates employer exists
- `updateJobStatusAction` requires admin role
</verification>

<success_criteria>
Admin can manage all jobs (list, create on behalf of employer, view detail with matches). Admin can manually re-trigger notifications for matches where automated notification may have failed. Notifications are tracked to prevent duplicates. All success criteria from the phase are met:
1. Employer can create jobs (plan 03)
2. Admin can create jobs on behalf (this plan)
3. System produces ranked match results with explanations (plan 02 + 03)
4. Two-stage matching approach (plan 02)
5. Automatic notifications for employers and candidates after matching (plan 02), with admin manual re-send (this plan)
</success_criteria>

<output>
After completion, create `.planning/phases/08-job-posting-and-ai-matching/08-04-SUMMARY.md`
</output>
