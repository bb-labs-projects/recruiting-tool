---
phase: 01-foundation-and-auth
plan: 05
type: execute
wave: 4
depends_on: ["01-03", "01-04"]
files_modified:
  - src/app/(public)/login/page.tsx
  - src/app/(public)/auth/verify/page.tsx
  - src/components/auth/magic-link-form.tsx
  - src/components/auth/magic-link-verify.tsx
  - src/components/auth/logout-button.tsx
  - src/app/(authenticated)/layout.tsx
  - src/app/admin/layout.tsx
autonomous: false

must_haves:
  truths:
    - "User can type email and submit login form"
    - "After submitting, user sees 'Check your email' success message"
    - "Invalid email shows validation error before submission"
    - "Rate limit error shows user-friendly message"
    - "Magic link verify page shows 'Confirm login' button (does NOT auto-consume token)"
    - "Clicking confirm button on verify page triggers token verification"
    - "Successful verification redirects to role-based dashboard"
    - "Expired/invalid token shows error with 'Request new link' option"
    - "Logout button is visible on every authenticated page"
    - "Clicking logout clears session and redirects to /login"
  artifacts:
    - path: "src/components/auth/magic-link-form.tsx"
      provides: "Email input form for requesting magic link"
      exports: ["MagicLinkForm"]
    - path: "src/components/auth/magic-link-verify.tsx"
      provides: "Two-step token verification UI"
      exports: ["MagicLinkVerify"]
    - path: "src/components/auth/logout-button.tsx"
      provides: "Logout button component"
      exports: ["LogoutButton"]
    - path: "src/app/(public)/login/page.tsx"
      provides: "Login page with MagicLinkForm"
      min_lines: 10
    - path: "src/app/(public)/auth/verify/page.tsx"
      provides: "Verify page with MagicLinkVerify"
      min_lines: 10
  key_links:
    - from: "src/components/auth/magic-link-form.tsx"
      to: "src/actions/auth.ts"
      via: "useActionState with requestMagicLink"
      pattern: "useActionState.*requestMagicLink"
    - from: "src/components/auth/magic-link-verify.tsx"
      to: "/api/auth/magic-link/verify"
      via: "fetch POST call"
      pattern: "fetch.*api/auth/magic-link/verify"
    - from: "src/components/auth/logout-button.tsx"
      to: "/api/auth/logout"
      via: "fetch POST call"
      pattern: "fetch.*api/auth/logout"
    - from: "src/app/(public)/login/page.tsx"
      to: "src/components/auth/magic-link-form.tsx"
      via: "component import"
      pattern: "import.*MagicLinkForm"
    - from: "src/app/(public)/auth/verify/page.tsx"
      to: "src/components/auth/magic-link-verify.tsx"
      via: "component import"
      pattern: "import.*MagicLinkVerify"
---

<objective>
Build the auth UI: login form, magic link verification page, and logout button. Wire them to the server action and API routes.

Purpose: This is the user-facing layer of authentication. It connects the backend (Plan 03) to the route structure (Plan 04), completing the full magic link flow from email input to authenticated dashboard.

Output: Three client components and two updated pages that deliver the complete auth user experience.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation-and-auth/01-RESEARCH.md
@01-magic-link-auth.md

Depends on Plan 01-03 artifacts:
- src/actions/auth.ts (requestMagicLink server action, MagicLinkState type)
- src/app/api/auth/magic-link/verify/route.ts (POST endpoint)
- src/app/api/auth/logout/route.ts (POST endpoint)

Depends on Plan 01-04 artifacts:
- src/app/(public)/login/page.tsx (placeholder to replace)
- src/app/(public)/auth/verify/page.tsx (placeholder to replace)
- src/app/(authenticated)/layout.tsx (add LogoutButton)
- src/app/admin/layout.tsx (add LogoutButton)

Key patterns:
- useActionState (React 19) for login form -- NOT useFormState
- Two-step verify: GET shows confirm button, POST consumes token (email prefetch protection)
- Client components ('use client' directive) for interactive forms
- shadcn/ui components for styling
- useRouter from next/navigation for client-side redirects after verify
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth client components (form, verify, logout)</name>
  <files>
    src/components/auth/magic-link-form.tsx
    src/components/auth/magic-link-verify.tsx
    src/components/auth/logout-button.tsx
  </files>
  <action>
    1. Create `src/components/auth/magic-link-form.tsx`:
       - 'use client' directive
       - Import useActionState from 'react'
       - Import requestMagicLink from '@/actions/auth'
       - Import Button, Input, Label from shadcn components
       - Import Card, CardContent, CardDescription, CardHeader, CardTitle from shadcn

       Component MagicLinkForm:
       - useActionState(requestMagicLink, undefined) -> [state, action, pending]
       - If state?.success: render success UI in a Card:
         - Icon or checkmark (can use a simple SVG or emoji-free text indicator)
         - Heading: "Check your email"
         - Text: "We sent a login link to your email address. Click the link in the email to sign in."
         - Subtext: "The link expires in 10 minutes."
         - "Didn't receive it?" hint about checking spam folder
       - Otherwise: render login form in a Card:
         - CardHeader: title "Sign In", description "Enter your email to receive a login link"
         - CardContent: form with action={action}
         - Label + Input: name="email", type="email", placeholder="you@example.com", required, autoFocus, autoComplete="email"
         - Error display: if state?.error, show in red text below input
         - Submit Button: text "Send Login Link", disabled={pending}, show loading state when pending (text changes to "Sending...")
         - The form should be clean and professional -- single input, single button, no clutter

    2. Create `src/components/auth/magic-link-verify.tsx`:
       - 'use client' directive
       - Import useState from 'react'
       - Import useSearchParams, useRouter from 'next/navigation'
       - Import Button from shadcn
       - Import Card, CardContent, CardHeader, CardTitle from shadcn

       Component MagicLinkVerify:
       - Get token from URL search params: useSearchParams().get('token')
       - State: status ('idle' | 'loading' | 'success' | 'error'), errorMessage (string)
       - useRouter for redirect after success

       If no token in URL: show error state "Invalid link. No token found."

       Render based on status:

       'idle' state (default):
       - Card with heading "Confirm Sign In"
       - Text: "Click the button below to complete your sign in."
       - Button: "Confirm Login" -- onClick triggers verification
       - This is the two-step protection against email prefetch

       'loading' state:
       - Same card with "Verifying..." text
       - Button disabled with loading indicator

       'success' state:
       - Card with "Success!" heading
       - Text: "You're signed in. Redirecting..."
       - Auto-redirect happens via router.push

       'error' state:
       - Card with "Sign In Failed" heading
       - Show errorMessage
       - "Request New Link" button that navigates to /login

       On confirm click:
       - Set status to 'loading'
       - POST to /api/auth/magic-link/verify with { token }
       - On 200: set status 'success', then router.push(response.redirectTo) after brief delay
       - On 401: set status 'error', set errorMessage from response
       - On other error: set status 'error', generic message

       IMPORTANT: Token verification happens on button click (POST), NOT on page load (GET). This prevents email client prefetch from consuming the token.

    3. Create `src/components/auth/logout-button.tsx`:
       - 'use client' directive
       - Import useState from 'react'
       - Import useRouter from 'next/navigation'
       - Import Button from shadcn

       Component LogoutButton:
       - State: loading (boolean)
       - On click:
         - Set loading true
         - POST to /api/auth/logout
         - On success: router.push('/login')
         - On error: set loading false (maybe show alert)
       - Render: Button variant="ghost" or "outline", text "Sign Out", disabled when loading
       - Keep it simple -- just a button, no modal confirmation needed
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - All three files have 'use client' directive
    - MagicLinkForm uses useActionState (NOT useFormState)
    - MagicLinkForm shows success state when state.success is true
    - MagicLinkVerify reads token from searchParams
    - MagicLinkVerify does NOT auto-verify on mount (waits for button click)
    - MagicLinkVerify POSTs to /api/auth/magic-link/verify
    - LogoutButton POSTs to /api/auth/logout
    - All components use shadcn/ui components (Button, Input, Card, etc.)
  </verify>
  <done>
    Three client components compile and implement the complete auth UI: login form with server action integration, two-step token verification with prefetch protection, and logout button with session cleanup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire auth components into pages and layouts</name>
  <files>
    src/app/(public)/login/page.tsx
    src/app/(public)/auth/verify/page.tsx
    src/app/(authenticated)/layout.tsx
    src/app/admin/layout.tsx
  </files>
  <action>
    1. Update `src/app/(public)/login/page.tsx`:
       - Replace the placeholder content from Plan 04
       - Import MagicLinkForm from '@/components/auth/magic-link-form'
       - Render the MagicLinkForm component
       - Keep metadata export: { title: 'Sign In' }
       - The page itself is a server component -- MagicLinkForm is the client component within it
       - Minimal wrapper -- the Card styling is inside MagicLinkForm, so the page just renders it

    2. Update `src/app/(public)/auth/verify/page.tsx`:
       - Replace the placeholder content from Plan 04
       - This page needs to use Suspense because MagicLinkVerify uses useSearchParams (which requires Suspense boundary in Next.js)
       - Import Suspense from 'react'
       - Import MagicLinkVerify from '@/components/auth/magic-link-verify'
       - Render: <Suspense fallback={loading spinner or skeleton}><MagicLinkVerify /></Suspense>
       - Keep metadata export: { title: 'Verify Login' }

    3. Update `src/app/(authenticated)/layout.tsx`:
       - Import LogoutButton from '@/components/auth/logout-button'
       - Add LogoutButton to the header area (right side)
       - The layout already calls getUser() from Plan 04 -- now also display user.email and add the LogoutButton next to it
       - Layout structure: header bar (app name left, user email + LogoutButton right) + main content below

    4. Update `src/app/admin/layout.tsx`:
       - Import LogoutButton from '@/components/auth/logout-button'
       - Add LogoutButton to the admin header area
       - Display user.email in the header alongside the LogoutButton
       - Keep the existing sidebar and admin role check from Plan 04
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - /login page renders MagicLinkForm (not placeholder text)
    - /auth/verify page renders MagicLinkVerify wrapped in Suspense
    - Authenticated layout header shows user email and LogoutButton
    - Admin layout header shows user email and LogoutButton
    - No 'use client' directive on the page files (they're server components that render client components)
  </verify>
  <done>
    Login page shows the email input form. Verify page shows the two-step confirmation UI with Suspense boundary. All authenticated pages (candidate, employer, admin) have a visible logout button in the header. The full auth UI is wired end-to-end.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete magic link authentication flow:
    1. Login page with email form at /login
    2. Magic link email sent via Resend
    3. Two-step verify page at /auth/verify?token=...
    4. Session cookie set on successful verification
    5. Role-based redirect after login (candidate/employer/admin dashboard)
    6. Logout button on all authenticated pages
    7. Proxy-based route protection (unauthenticated users redirected to /login)
    8. Admin area restricted to admin role only
  </what-built>
  <how-to-verify>
    Prerequisites:
    - DATABASE_URL configured in .env.local (Neon PostgreSQL)
    - Run `npx drizzle-kit push` to push schema to database
    - RESEND_API_KEY configured in .env.local
    - EMAIL_FROM configured (use onboarding@resend.dev for testing)
    - SESSION_SECRET configured (run `openssl rand -base64 32` to generate)
    - Run `npm run dev` to start the dev server

    Test the full flow:

    1. Visit http://localhost:3000 -- should redirect to /login
    2. Enter your email address and click "Send Login Link"
    3. Should see "Check your email" success message
    4. Check your email for the magic link from Resend
    5. Click the link -- should go to /auth/verify?token=... and show "Confirm Sign In" button
    6. Click "Confirm Login" -- should create session and redirect to /candidate (default role)
    7. Verify you see the candidate dashboard with your email in the header
    8. Open a new tab -- visit http://localhost:3000 -- should redirect to /candidate (session persists)
    9. Click "Sign Out" -- should redirect to /login
    10. Try visiting /candidate directly -- should redirect to /login (no session)

    To test admin:
    11. Manually update your user's role to 'admin' in the database:
        `UPDATE users SET role = 'admin' WHERE email = 'your@email.com';`
    12. Request a new magic link, verify, and confirm you're redirected to /admin
    13. Verify the admin layout has a sidebar

    To test rate limiting:
    14. Request 6 magic links for the same email rapidly -- the 6th should show a rate limit error

    To test error handling:
    15. Visit /auth/verify?token=invalidtoken123 -- should show "Confirm Sign In" button
    16. Click confirm -- should show error "Invalid or already used token"
    17. Click the link from step 4 again (already used) -- should show already-used error
  </how-to-verify>
  <resume-signal>Type "approved" if the auth flow works end-to-end, or describe any issues you encounter.</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. Full auth flow works: email -> magic link -> verify -> session -> dashboard -> logout
4. Role-based routing works: candidate -> /candidate, employer -> /employer, admin -> /admin
5. Session persists across tabs/refresh
6. Logout clears session
7. Rate limiting prevents excessive requests
8. Expired/invalid tokens show clear errors
9. Email prefetch protection: verify page requires button click (POST, not GET)
</verification>

<success_criteria>
- User can enter email and receive a magic link
- Two-step verification prevents email prefetch issues
- Successful verification creates session and redirects by role
- Session persists across page refreshes and new tabs
- Logout destroys session and redirects to login
- Unauthenticated users are redirected to /login
- Admin routes are restricted to admin role
- Rate limiting enforced (5 per email per hour)
- Expired/reused tokens show helpful error messages
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-auth/01-05-SUMMARY.md`
</output>
