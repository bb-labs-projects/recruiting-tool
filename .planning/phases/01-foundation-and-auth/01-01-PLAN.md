---
phase: 01-foundation-and-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - next.config.ts
  - postcss.config.mjs
  - drizzle.config.ts
  - src/app/globals.css
  - src/app/layout.tsx
  - src/lib/db/index.ts
  - src/lib/db/schema.ts
  - src/lib/utils.ts
  - .env.local
  - .env.example
  - .gitignore
  - components.json
autonomous: true
user_setup:
  - service: neon
    why: "PostgreSQL database for all application data"
    env_vars:
      - name: DATABASE_URL
        source: "Neon Console -> Project -> Connection Details -> Connection string"
    dashboard_config:
      - task: "Create a Neon project"
        location: "https://console.neon.tech -> New Project"

must_haves:
  truths:
    - "Next.js dev server starts without errors on localhost:3000"
    - "Tailwind CSS classes render correctly in the browser"
    - "shadcn/ui components are available for import"
    - "Drizzle schema compiles and migration SQL can be generated"
    - "Database connection succeeds with valid DATABASE_URL"
  artifacts:
    - path: "package.json"
      provides: "All project dependencies"
      contains: "next"
    - path: "src/lib/db/schema.ts"
      provides: "users, magicLinkTokens, sessions tables"
      exports: ["users", "magicLinkTokens", "sessions", "userRoleEnum"]
    - path: "src/lib/db/index.ts"
      provides: "Drizzle database client"
      exports: ["db"]
    - path: "drizzle.config.ts"
      provides: "Drizzle Kit configuration"
      contains: "defineConfig"
    - path: ".env.example"
      provides: "Template for all required environment variables"
      contains: "DATABASE_URL"
  key_links:
    - from: "src/lib/db/index.ts"
      to: "src/lib/db/schema.ts"
      via: "schema import"
      pattern: "import.*schema"
    - from: "drizzle.config.ts"
      to: "src/lib/db/schema.ts"
      via: "schema path"
      pattern: "schema.*lib/db/schema"
---

<objective>
Scaffold the Next.js project with all dependencies and create the database schema for auth.

Purpose: Establish the foundation that every subsequent plan depends on -- the running application, configured tooling, and database tables for users, sessions, and magic link tokens.

Output: A working Next.js 16 app with Tailwind v4, shadcn/ui, Drizzle ORM schema, and database configuration ready for migration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-auth/01-RESEARCH.md
@01-magic-link-auth.md

Key research findings to honor:
- Next.js 16.1.x with proxy.ts (not middleware.ts)
- Tailwind v4 uses CSS-first config (@import "tailwindcss" in CSS, not tailwind.config.ts)
- Drizzle ORM 0.45.x with neon-http driver
- Use uuid().defaultRandom() for PKs, not serial()
- Use text() for ip_address columns (not inet)
- Database-backed rate limiting (not in-memory) -- the magic_link_tokens table enables this via COUNT query
- jose for session encryption (Edge-compatible)
- Zod v4.x for validation
- React 19 with useActionState (not useFormState)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Next.js project and install all dependencies</name>
  <files>
    package.json
    tsconfig.json
    next.config.ts
    postcss.config.mjs
    src/app/globals.css
    src/app/layout.tsx
    src/app/page.tsx
    src/lib/utils.ts
    components.json
    .gitignore
    .env.example
    .env.local
  </files>
  <action>
    1. Run `npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir --import-alias "@/*"` in the project root. Accept defaults. If the project root already has files (like .planning, .claude) and create-next-app errors on a non-empty directory, use this fallback procedure:
       - Scaffold into a temporary directory: `npx create-next-app@latest tmp-scaffold --typescript --tailwind --eslint --app --src-dir --import-alias "@/*"`
       - Move all generated files from tmp-scaffold/ to the project root (cp -r tmp-scaffold/* . && cp tmp-scaffold/.* . where applicable -- be careful not to overwrite .git, .planning, .claude)
       - Remove the temporary directory: `rm -rf tmp-scaffold`
       The key is to end up with the standard Next.js 16 project structure in the current repo root.

    2. Install core dependencies:
       ```
       npm install drizzle-orm @neondatabase/serverless jose server-only zod resend @react-email/components
       npm install -D drizzle-kit dotenv
       ```

    3. Verify Tailwind v4 is set up correctly. After scaffolding:
       - `src/app/globals.css` should have `@import "tailwindcss"` (Tailwind v4 pattern)
       - `postcss.config.mjs` should use `@tailwindcss/postcss` plugin
       - There should NOT be a `tailwind.config.ts` file (Tailwind v4 uses CSS-first config)
       - If create-next-app generated a tailwind.config.ts, delete it and ensure CSS config is correct

    4. Initialize shadcn/ui:
       ```
       npx shadcn@latest init --defaults
       ```
       Then add components needed for auth:
       ```
       npx shadcn@latest add button input card label
       ```

    5. Create `.env.example` with ALL environment variables needed for Phase 1:
       ```
       # Application
       APP_NAME="IP Lawyer Recruiting"
       APP_URL="http://localhost:3000"

       # Database (Neon PostgreSQL)
       DATABASE_URL="postgresql://user:pass@ep-xxx.us-east-2.aws.neon.tech/dbname?sslmode=require"

       # Auth
       SESSION_SECRET="generate-with-openssl-rand-base64-32"

       # Email (Resend)
       RESEND_API_KEY="re_..."
       EMAIL_FROM="noreply@yourdomain.com"
       ```

    6. Create `.env.local` by copying `.env.example` (user will fill in real values).

    7. Ensure `.gitignore` includes `.env.local` and `node_modules` (create-next-app should handle this, but verify).

    NOTE: The exact version of Next.js installed will be whatever `create-next-app@latest` provides. The research found 16.1.6 but this may have changed. That is fine -- use whatever latest stable is.
  </action>
  <verify>
    - `npm run dev` starts without errors
    - Visit http://localhost:3000 and see the Next.js default page
    - `npx tsc --noEmit` passes with no type errors
    - shadcn/ui components exist in `src/components/ui/` (button.tsx, input.tsx, card.tsx, label.tsx)
    - `.env.example` exists with all required variables
    - No `tailwind.config.ts` file exists (Tailwind v4 uses CSS-first config)
  </verify>
  <done>
    Next.js dev server runs successfully. Tailwind v4 is configured via CSS (no tailwind.config.ts). shadcn/ui components are installed. All auth-related npm packages are in package.json. Environment variable template exists.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create database schema and Drizzle configuration</name>
  <files>
    src/lib/db/schema.ts
    src/lib/db/index.ts
    drizzle.config.ts
  </files>
  <action>
    1. Create `src/lib/db/schema.ts` with the following tables. Use the exact patterns from the research:

       **userRoleEnum**: pgEnum with values ['candidate', 'employer', 'admin']

       **users table**:
       - id: uuid().defaultRandom().primaryKey()
       - email: varchar(255).unique().notNull()
       - role: userRoleEnum().notNull().default('candidate')
       - emailVerified: boolean().default(false).notNull()
       - isActive: boolean().default(true).notNull()
       - createdAt: timestamp({ withTimezone: true }).defaultNow().notNull()
       - updatedAt: timestamp({ withTimezone: true }).defaultNow().notNull()
       - lastLoginAt: timestamp({ withTimezone: true })
       - Indexes: uniqueIndex on email

       **magicLinkTokens table**:
       - id: uuid().defaultRandom().primaryKey()
       - userId: uuid().notNull().references(() => users.id, { onDelete: 'cascade' })
       - tokenHash: varchar(64).unique().notNull()
       - expiresAt: timestamp({ withTimezone: true }).notNull()
       - usedAt: timestamp({ withTimezone: true })
       - createdAt: timestamp({ withTimezone: true }).defaultNow().notNull()
       - ipAddress: text() -- using text not inet per research recommendation
       - userAgent: text()
       - redirectPath: text().default('/')
       - Indexes: index on tokenHash, index on expiresAt, index on userId

       **sessions table**:
       - id: uuid().defaultRandom().primaryKey()
       - userId: uuid().notNull().references(() => users.id, { onDelete: 'cascade' })
       - tokenHash: varchar(64).unique().notNull()
       - expiresAt: timestamp({ withTimezone: true }).notNull()
       - createdAt: timestamp({ withTimezone: true }).defaultNow().notNull()
       - lastActiveAt: timestamp({ withTimezone: true }).defaultNow().notNull()
       - ipAddress: text()
       - userAgent: text()
       - Indexes: index on tokenHash, index on userId

       Export ALL table definitions and the enum.

    2. Create `src/lib/db/index.ts`:
       ```typescript
       import { drizzle } from 'drizzle-orm/neon-http'
       import * as schema from './schema'

       export const db = drizzle(process.env.DATABASE_URL!, { schema })
       ```

    3. Create `drizzle.config.ts` at the project root:
       ```typescript
       import 'dotenv/config'
       import { defineConfig } from 'drizzle-kit'

       export default defineConfig({
         out: './drizzle',
         schema: './src/lib/db/schema.ts',
         dialect: 'postgresql',
         dbCredentials: {
           url: process.env.DATABASE_URL!,
         },
       })
       ```

    4. Run `npx drizzle-kit generate` to generate the initial migration SQL. This validates the schema compiles correctly. The migration files will appear in `./drizzle/`.

       Do NOT run `drizzle-kit push` or `drizzle-kit migrate` -- the user needs to configure DATABASE_URL first. Just generate the SQL to prove the schema is valid.
  </action>
  <verify>
    - `npx tsc --noEmit` passes (schema types are valid)
    - `npx drizzle-kit generate` succeeds and creates SQL file(s) in `./drizzle/`
    - The generated SQL contains CREATE TABLE for users, magic_link_tokens, sessions
    - The generated SQL contains CREATE TYPE for user_role enum
    - `src/lib/db/schema.ts` exports users, magicLinkTokens, sessions, userRoleEnum
    - `src/lib/db/index.ts` exports db
  </verify>
  <done>
    Database schema compiles. Drizzle migration SQL is generated. Schema exports users, magicLinkTokens, sessions, and userRoleEnum. Database client is ready to use once DATABASE_URL is configured.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` starts successfully on localhost:3000
2. `npx tsc --noEmit` has zero type errors
3. `./drizzle/` directory contains generated migration SQL
4. `src/components/ui/` contains button.tsx, input.tsx, card.tsx, label.tsx
5. `.env.example` lists DATABASE_URL, SESSION_SECRET, RESEND_API_KEY, EMAIL_FROM, APP_NAME, APP_URL
6. `src/lib/db/schema.ts` defines 3 tables with correct column types and indexes
7. No `tailwind.config.ts` file exists
</verification>

<success_criteria>
- Next.js dev server runs on localhost:3000
- All npm packages installed (next, drizzle-orm, @neondatabase/serverless, jose, server-only, zod, resend, @react-email/components)
- Tailwind v4 CSS-first config working (no tailwind.config.ts)
- shadcn/ui initialized with button, input, card, label components
- Drizzle schema defines users, magicLinkTokens, sessions tables with proper types/indexes
- Migration SQL generated successfully
- Environment variable template complete
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-auth/01-01-SUMMARY.md`
</output>
